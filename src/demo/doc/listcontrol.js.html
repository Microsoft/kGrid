<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: listcontrol.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: listcontrol.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// ---------------------------------------------------------------------------
// &lt;copyright file="ListControl.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// &lt;/copyright>
// ---------------------------------------------------------------------------
var Microsoft;
(function (Microsoft) {
    (function (Office) {
        (function (Controls) {
            /**
            * Microsoft.Office.Controls.Fundamental module
            * @namespace Microsoft.Office.Controls.Fundamental
            */
            (function (Fundamental) {
                /**
                * IDisposable interface
                * @interface Microsoft.Office.Controls.Fundamental.IDisposable
                * @see {@link Microsoft.Office.Controls.Fundamental.Disposer}
                */
                /**
                * Dispose this object
                * @method Microsoft.Office.Controls.Fundamental.IDisposable#Dispose
                */
                var Disposer = (function () {
                    /**
                    * This callback is called when this object is disposing
                    * @callback Microsoft.Office.Controls.Fundamental.Disposer~DisposeCallback
                    */
                    /**
                    * This class is designed to manage lifecycle. A class which have lifecycle management
                    * should be designed as following pattern
                    *
                    *     class classWithLifecycle {
                    *         public disposer;
                    *
                    *         constructor() {
                    *             this.disposer = new Disposer(() => {
                    *                 // Do whatever you want to do in disposing
                    *             });
                    *         }
                    *
                    *         // This function is optional, keep the compatibility to IDisposable interface.
                    *         // The owner disposer will call this.disposer.dispose first and then call this.dispose
                    *         // as second choice
                    *         public dispose() {
                    *             this.disposer.dispose();
                    *         }
                    *     }
                    *
                    * The object owner need to call theObject.disposer.dispose() method to dispose the object.
                    * The benefits of using this are:
                    * 1. The Disposer class can handle the double dispose issue
                    * 2. Object owner can use [addDisposable]{@link Microsoft.Office.Controls.Fundamental.Disposer#addDisposable} method to add the object to its disposer and it will
                    * be disposed automatically the owner is disposing
                    * 3. The constructor takes one callback to do extra dispose work. So developer can write dispose
                    * logic close to the constructor and easy to find what didn't do in disposing
                    *
                    * @constructor Microsoft.Office.Controls.Fundamental.Disposer
                    * @param {Microsoft.Office.Controls.Fundamental.Disposer~DisposeCallback=} disposeCallback - a callback will be called in disposing
                    */
                    function Disposer(disposeCallback) {
                        this.isDisposed = false;
                        this.isDisposing = false;
                        this._disposeCallback = disposeCallback;
                        this._disposables = [];
                    }
                    /**
                    * @method Microsoft.Office.Controls.Fundamental.Disposer#addDisposable
                    * @param {object} disposable - an object which will be disposed when "this" is disposed. The object should implement {@link Microsoft.Office.Controls.Fundamental.IDisposable} or expose dispose function
                    */
                    Disposer.prototype.addDisposable = function (disposable) {
                        if (this.isDisposed || this.isDisposing) {
                            if (disposable.disposer) {
                                disposable.disposer.dispose();
                            } else if (disposable.dispose) {
                                disposable.dispose();
                            }

                            return;
                        }

                        this._disposables.push(disposable);
                    };

                    /**
                    * @method Microsoft.Office.Controls.Fundamental.Disposer#dispose
                    */
                    Disposer.prototype.dispose = function () {
                        if (this.isDisposed || this.isDisposing) {
                            return;
                        }

                        this.isDisposing = true;

                        if (this._disposeCallback) {
                            this._disposeCallback();
                        }

                        for (var i = 0; i &lt; this._disposables.length; i++) {
                            if (this._disposables[i].disposer) {
                                this._disposables[i].disposer.dispose();
                            } else if (this._disposables[i].dispose) {
                                this._disposables[i].dispose();
                            }
                        }

                        this._disposables = null;
                        this.isDisposed = true;
                    };
                    return Disposer;
                })();
                Fundamental.Disposer = Disposer;
            })(Controls.Fundamental || (Controls.Fundamental = {}));
            var Fundamental = Controls.Fundamental;
        })(Office.Controls || (Office.Controls = {}));
        var Controls = Office.Controls;
    })(Microsoft.Office || (Microsoft.Office = {}));
    var Office = Microsoft.Office;
})(Microsoft || (Microsoft = {}));

var Microsoft;
(function (Microsoft) {
    (function (Office) {
        // import $ = require('jquery');
        // import angular = require('angular');
        // import css = require('css!assets/css/listcontrol.css');
        //
        // (css);
        // export module Microsoft.Office.Controls {
        //     export module Support {
        (function (Controls) {
            (function (Support) {
                function createError(number, name, message) {
                    return new Error(number + ': [' + name + '] ' + message);
                }
                Support.createError = createError;

                var TextDirection = (function () {
                    function TextDirection(rtl) {
                        this.options = new Support.PropertyBag();
                        this.rtl(rtl);
                    }
                    TextDirection._staticInitialize = function () {
                        if (TextDirection._staticInitialized) {
                            return;
                        }

                        var div = $('&lt;div style="direction: rtl; posistion:absolute; left: 0px; right: 0px; width: 50px; height: 50px; overflow: auto">&lt;div style="posistion:absolute; left: 0px; right: 0px; width: 51px; height: 50px">&lt;/div>&lt;/div>');

                        $(document.body).append(div);

                        TextDirection._zeroEnd = div.scrollLeft() == 0 ? 'front' : 'end';

                        div.scrollLeft(1);

                        if (div.scrollLeft() == 1) {
                            TextDirection._scrollFrontDirection = 1;
                        } else {
                            TextDirection._scrollFrontDirection = -1;
                        }

                        div.remove();

                        TextDirection._staticInitialized = true;
                    };

                    TextDirection.zeroEnd = function () {
                        TextDirection._staticInitialize();
                        return TextDirection._zeroEnd;
                    };

                    TextDirection.scrollFrontDirection = function () {
                        TextDirection._staticInitialize();
                        return TextDirection._scrollFrontDirection;
                    };

                    TextDirection.prototype.rtl = function (value) {
                        var _this = this;
                        if (typeof value === "undefined") { value = undefined; }
                        return this.options.$property({
                            name: 'rtl',
                            args: arguments,
                            afterChange: function (sender, args) {
                                if (args.newValue) {
                                    _this.front('right');
                                    _this.end('left');
                                } else {
                                    _this.front('left');
                                    _this.end('right');
                                }
                            }
                        });
                    };

                    TextDirection.prototype.front = function (value) {
                        if (typeof value === "undefined") { value = undefined; }
                        return this.options.$property({
                            name: 'front',
                            args: arguments
                        });
                    };

                    TextDirection.prototype.end = function (value) {
                        if (typeof value === "undefined") { value = undefined; }
                        return this.options.$property({
                            name: 'end',
                            args: arguments
                        });
                    };

                    TextDirection.prototype.clone = function () {
                        var clonedObject = new Support.TextDirection(this.rtl());

                        clonedObject.options = $.extend(true, new Support.PropertyBag(), this.options);
                        return clonedObject;
                    };
                    TextDirection.RTL = 1;
                    TextDirection.LTR = 0;
                    TextDirection._staticInitialized = false;
                    return TextDirection;
                })();
                Support.TextDirection = TextDirection;

                var CssTextBuilder = (function () {
                    function CssTextBuilder() {
                        this._buffer = '';
                        this._state = CssTextBuilder._selectorState;
                    }
                    CssTextBuilder.prototype.append = function (text) {
                        this.pushSelector(text);
                    };

                    CssTextBuilder.prototype.push = function (text) {
                        this.pushSelector(text);
                    };
                    CssTextBuilder.prototype.pushSelector = function (selector) {
                        if (this._state == CssTextBuilder._propertyState) {
                            this._buffer += '}';
                            this._state = CssTextBuilder._selectorState;
                        }

                        this._buffer += selector;
                    };

                    CssTextBuilder.prototype.property = function (name, value, unit) {
                        if (arguments.length > 2 &amp;&amp; isNaN(value)) {
                            throw (0, 'CssTextBuilder', 'cannot use unit when the second argument are NaN');
                        }

                        if (this._state == CssTextBuilder._selectorState) {
                            this._buffer += '{';
                            this._state = CssTextBuilder._propertyState;
                        }

                        this._buffer += name;
                        this._buffer += ':';
                        this._buffer += value;

                        if (unit) {
                            this._buffer += unit;
                        }

                        this._buffer += ';';
                    };

                    CssTextBuilder.prototype.propertyBegin = function () {
                        switch (this._state) {
                            case CssTextBuilder._selectorState:
                                this._buffer += '{';
                                this._state = CssTextBuilder._propertyState;
                                break;

                            case CssTextBuilder._propertyState:
                                throw createError(0, 'CssTextBuilder', 'cannot use propertyBegin in propertyState');
                        }
                    };

                    CssTextBuilder.prototype.propertyEnd = function () {
                        switch (this._state) {
                            case CssTextBuilder._selectorState:
                                throw createError(0, 'CssTextBuilder', 'cannot use propertyEnd in selectorState');
                                break;

                            case CssTextBuilder._propertyState:
                                this._buffer += '}';
                                this._state = CssTextBuilder._selectorState;
                                break;
                        }
                    };

                    CssTextBuilder.prototype.toString = function () {
                        if (this._state == CssTextBuilder._propertyState) {
                            this._buffer += '}';
                        }

                        return this._buffer;
                    };
                    CssTextBuilder._selectorState = 0;
                    CssTextBuilder._propertyState = 1;
                    return CssTextBuilder;
                })();
                Support.CssTextBuilder = CssTextBuilder;

                var StringBuilder = (function () {
                    function StringBuilder() {
                        this._buffer = '';
                    }
                    StringBuilder.prototype.append = function (text) {
                        this._buffer += text;
                    };

                    StringBuilder.prototype.toString = function () {
                        return this._buffer;
                    };
                    return StringBuilder;
                })();
                Support.StringBuilder = StringBuilder;

                var Updater = (function () {
                    function Updater(checker, updater) {
                        this._checker = checker;
                        this._updater = updater;
                        this._isFirstTime = true;
                    }
                    Updater.prototype.update = function () {
                        var value = typeof (this._checker) == "function" ? this._checker() : this._checker;

                        if (this._isFirstTime) {
                            this._isFirstTime = false;
                            this._lastValue = JSON.stringify(value);
                            this._updater(value, value);
                            return true;
                        } else if (JSON.stringify(value) !== this._lastValue) {
                            var lastValue = JSON.parse(this._lastValue);

                            this._lastValue = JSON.stringify(value);
                            this._updater(value, lastValue);
                            return true;
                        }

                        return false;
                    };

                    Updater.prototype.reset = function () {
                        this._isFirstTime = true;
                        this._lastValue = undefined;
                    };

                    Updater.prototype.ignore = function () {
                        var value = typeof (this._checker) == "function" ? this._checker() : this._checker;

                        if (this._isFirstTime) {
                            this._isFirstTime = false;
                            this._lastValue = value;
                        } else if (JSON.stringify(value) !== this._lastValue) {
                            this._lastValue = JSON.stringify(value);
                        }
                    };
                    return Updater;
                })();
                Support.Updater = Updater;

                var UpdaterGroup = (function () {
                    function UpdaterGroup() {
                        var _this = this;
                        this._updaters = [];
                        this.disposer = new Controls.Fundamental.Disposer(function () {
                            _this._updaters = null;
                        });
                    }
                    UpdaterGroup.prototype.add = function (updaters) {
                        if (this.disposer.isDisposed) {
                            return;
                        }

                        if ($.isArray(updaters)) {
                            for (var i = 0; i &lt; updaters.length; i++) {
                                this._updaters.push(updaters[i]);
                            }
                        } else {
                            this._updaters.push(updaters);
                        }
                    };

                    UpdaterGroup.prototype.update = function () {
                        if (this.disposer.isDisposed) {
                            return;
                        }

                        var result = false;

                        for (var i = 0; i &lt; this._updaters.length; i++) {
                            result = this._updaters[i].update() ? true : result;
                        }

                        return result;
                    };

                    UpdaterGroup.prototype.reset = function () {
                        if (this.disposer.isDisposed) {
                            return;
                        }

                        for (var i = 0; i &lt; this._updaters.length; i++) {
                            this._updaters[i].reset();
                        }
                    };

                    UpdaterGroup.prototype.ignore = function () {
                        if (this.disposer.isDisposed) {
                            return;
                        }

                        var result = false;

                        for (var i = 0; i &lt; this._updaters.length; i++) {
                            result = this._updaters[i].ignore() ? true : result;
                        }
                        return result;
                    };
                    return UpdaterGroup;
                })();
                Support.UpdaterGroup = UpdaterGroup;

                var DynamicStylesheetUpdater = (function () {
                    function DynamicStylesheetUpdater(id) {
                        var _this = this;
                        this._generators = [];
                        this._stylesheet = new DynamicStylesheet(id);
                        this._generators = [];
                        this._updater = new Updater(function () {
                            if (_this.disposer.isDisposed) {
                                return;
                            }

                            return $.map(_this._generators, function (generator) {
                                return generator();
                            }).join('');
                        }, function (newValue) {
                            if (_this.disposer.isDisposed) {
                                return;
                            }

                            _this._stylesheet.content(newValue);
                        });
                        this.disposer = new Controls.Fundamental.Disposer(function () {
                            _this._generators = null;
                            _this._updater = null;
                        });
                    }
                    DynamicStylesheetUpdater.prototype.add = function (generator) {
                        if (this.disposer.isDisposed) {
                            return;
                        }

                        this._generators.push(generator);
                    };

                    DynamicStylesheetUpdater.prototype.reset = function () {
                        if (this.disposer.isDisposed) {
                            return;
                        }

                        this._updater.reset();
                        this._stylesheet.content('');
                    };

                    DynamicStylesheetUpdater.prototype.getUpdater = function () {
                        if (this.disposer.isDisposed) {
                            return;
                        }

                        return this._updater;
                    };
                    return DynamicStylesheetUpdater;
                })();
                Support.DynamicStylesheetUpdater = DynamicStylesheetUpdater;

                var EventSite = (function () {
                    function EventSite() {
                        var _this = this;
                        this._sites = {};
                        this.disposer = new Controls.Fundamental.Disposer(function () {
                            return _this._sites = null;
                        });
                    }
                    EventSite.prototype.on = function (event, callback) {
                        if (this.disposer.isDisposed) {
                            return;
                        }

                        var site = this._sites[event];

                        if (!site) {
                            this._sites[event] = site = [];
                        }

                        site.push(callback);
                    };

                    EventSite.prototype.off = function (event, callback) {
                        if (this.disposer.isDisposed) {
                            return;
                        }

                        if (!this._sites[event]) {
                            return;
                        }

                        this._sites[event] = $.grep(this._sites[event], function (c) {
                            return c != callback;
                        });
                    };

                    EventSite.prototype.emit = function (event, sender, args) {
                        if (this.disposer.isDisposed) {
                            return;
                        }

                        var site = this._sites[event];

                        if (!site) {
                            return;
                        }

                        for (var i = 0; i &lt; site.length; i++) {
                            site[i](sender, args);
                        }
                    };
                    return EventSite;
                })();
                Support.EventSite = EventSite;

                var Calculator = (function () {
                    function Calculator() {
                    }
                    Calculator.calculateScrollTopAfterSwitchView = function (oldCanvasHeight, newCanvasHeight, oldViewportHeight, newViewportHeight, oldViewportScrollTop) {
                        var oldCanvasViewportHeight = oldCanvasHeight - oldViewportHeight;
                        var newCanvasViewportHeight = newCanvasHeight - newViewportHeight;

                        if (newCanvasViewportHeight &lt; 0) {
                            return 0;
                        } else {
                            return Math.floor(oldViewportScrollTop / oldCanvasViewportHeight * newCanvasViewportHeight);
                        }
                    };

                    Calculator.changeInLimitedRange = function (value, offset, min, max) {
                        value += offset;

                        if (value &lt; min) {
                            value = min;
                        } else if (value > max) {
                            value = max;
                        }

                        return value;
                    };

                    Calculator.compareValueArray = function (values0, values1) {
                        for (var i = 0; i &lt; values0.length; i++) {
                            if (values0[i] &lt; values1[i]) {
                                return -1;
                            } else if (values0[i] > values1[i]) {
                                return 1;
                            }
                        }

                        return 0;
                    };

                    Calculator.intersection = function (firstLower, firstUpper, secondLower, secondUpper) {
                        if (isNaN(firstLower + firstUpper + secondLower + secondUpper) || firstLower > secondUpper || secondLower > firstUpper) {
                            return null;
                        } else {
                            return {
                                lower: Math.max(firstLower, secondLower),
                                upper: Math.min(firstUpper, secondUpper)
                            };
                        }
                    };

                    Calculator.union = function (firstLower, firstUpper, secondLower, secondUpper) {
                        if (isNaN(firstLower + firstUpper + secondLower + secondUpper) || firstLower > secondUpper || secondLower > firstUpper) {
                            return null;
                        } else {
                            return {
                                lower: Math.min(firstLower, secondLower),
                                upper: Math.max(firstUpper, secondUpper)
                            };
                        }
                    };
                    return Calculator;
                })();
                Support.Calculator = Calculator;

                var EventAttacher = (function () {
                    function EventAttacher(element, events, callback) {
                        events = events.split(' ');
                        this.disposer = new Controls.Fundamental.Disposer(function () {
                            for (var i = 0; i &lt; events.length; i++) {
                                element.off(events[i], callback);
                            }
                        });

                        for (var i = 0; i &lt; events.length; i++) {
                            element.on(events[i], callback);
                        }
                    }
                    return EventAttacher;
                })();
                Support.EventAttacher = EventAttacher;

                var DynamicStylesheet = (function () {
                    function DynamicStylesheet(id) {
                        var _this = this;
                        this._element = $('&lt;style type="text/css">&lt;/style>');

                        if (id) {
                            this._element.attr('id', id);
                        }

                        $(document.head).append(this._element);
                        this._stylesheetText = '';
                        this.disposer = new Controls.Fundamental.Disposer(function () {
                            _this._element.remove();
                            _this._element = null;
                            _this._stylesheetText = null;
                        });
                    }
                    DynamicStylesheet.prototype.content = function (stylesheetText) {
                        if (this.disposer.isDisposed) {
                            return;
                        }

                        if (arguments.length == 0) {
                            return this._stylesheetText;
                        } else {
                            if (!stylesheetText) {
                                stylesheetText = '';
                            }

                            if (this._stylesheetText != stylesheetText) {
                                this._stylesheetText = stylesheetText;

                                if (this._element[0].styleSheet &amp;&amp; !this._element[0].sheet) {
                                    this._element[0].styleSheet.cssText = this._stylesheetText;
                                } else {
                                    this._element.html(this._stylesheetText);
                                }
                            }
                        }
                    };
                    return DynamicStylesheet;
                })();
                Support.DynamicStylesheet = DynamicStylesheet;

                var PropertyBag = (function () {
                    function PropertyBag(base0, base1) {
                        if (typeof base0 === "undefined") { base0 = {}; }
                        if (typeof base1 === "undefined") { base1 = {}; }
                        $.extend(true, this, base0, base1);
                    }
                    PropertyBag.prototype.$property = function (options) {
                        options.target = this;

                        return PropertyBag.property(options);
                    };

                    PropertyBag.property = function (options) {
                        var target = options.target, name = options.name, args = options.args, afterRead = options.afterRead, beforeChange = options.beforeChange, afterChange = options.afterChange;

                        if (args.length > 0) {
                            var oldValue = target[name], newValue = args[0];

                            if (oldValue == newValue || (typeof (oldValue) == 'number' &amp;&amp; isNaN(oldValue) &amp;&amp; isNaN(newValue))) {
                                return newValue;
                            }

                            if (beforeChange) {
                                var beforeChangeArgs = { name: name, newValue: newValue, oldValue: oldValue, cancel: false };

                                beforeChange(target, beforeChangeArgs);

                                if (beforeChangeArgs.cancel) {
                                    return;
                                }

                                newValue = beforeChangeArgs.newValue;
                                oldValue = beforeChangeArgs.oldValue;
                            }

                            target[name] = newValue;

                            if (afterChange) {
                                var afterChangeArgs = { name: name, newValue: newValue, oldValue: oldValue };

                                afterChange(target, afterChangeArgs);
                                return afterChange.newValue;
                            }

                            return target[name];
                        } else {
                            var afterReadArgs = { name: name, newValue: target[name] };

                            if (afterRead) {
                                afterRead(target, afterReadArgs);
                            }

                            return afterReadArgs.newValue;
                        }
                    };
                    return PropertyBag;
                })();
                Support.PropertyBag = PropertyBag;

                var BrowserDetector = (function () {
                    function BrowserDetector() {
                    }
                    BrowserDetector.staticInitialize = function () {
                        if (window.requestAnimationFrame) {
                            BrowserDetector.requestAnimationFrame = function (handler) {
                                return window.requestAnimationFrame(handler);
                            };
                        } else {
                            BrowserDetector.requestAnimationFrame = function (handler) {
                                return window.setTimeout(handler, 16.67);
                            };
                        }

                        if (window.performance &amp;&amp; window.performance.now) {
                            BrowserDetector.now = function () {
                                return window.performance.now();
                            };
                        } else {
                            BrowserDetector.now = function () {
                                return (new Date()).valueOf();
                            };
                        }
                    };

                    BrowserDetector.isTouchEvent = function (type) {
                        switch (type) {
                            case 'touchstart':
                            case 'touchmove':
                            case 'touchend':
                            case 'touchcancel':
                                return true;

                            default:
                                return false;
                        }
                    };

                    BrowserDetector.getChangedPointerIdentifier = function (event) {
                        var isTouch = Support.BrowserDetector.isTouchEvent(event.type);

                        if (isTouch) {
                            var result = [];

                            for (var i = 0; i &lt; event.originalEvent.changedTouches.length; i++) {
                                result.push('touch.' + event.originalEvent.changedTouches[0].identifier);
                            }

                            return result;
                        } else {
                            return ['mouse'];
                        }
                    };
                    return BrowserDetector;
                })();
                Support.BrowserDetector = BrowserDetector;

                BrowserDetector.staticInitialize();

                // FIXME: [low][1 day] change to promise
                var AccumulateTimeoutInvoker = (function () {
                    function AccumulateTimeoutInvoker(callback, timeout) {
                        var _this = this;
                        this._timeout = timeout;
                        this._callback = callback;
                        this.disposer = new Controls.Fundamental.Disposer(function () {
                            if (_this._handler) {
                                window.clearTimeout(_this._handler);
                                _this._handler = null;
                            }
                        });
                    }
                    AccumulateTimeoutInvoker.prototype.invoke = function (args) {
                        var _this = this;
                        if (typeof args === "undefined") { args = null; }
                        if (this._handler) {
                            window.clearTimeout(this._handler);
                            this._handler = null;
                        }

                        this._handler = window.setTimeout(function () {
                            _this._handler = null;
                            _this._callback(args);
                        }, this._timeout);
                    };

                    AccumulateTimeoutInvoker.prototype.dispose = function () {
                        this.disposer.dispose();
                    };
                    return AccumulateTimeoutInvoker;
                })();
                Support.AccumulateTimeoutInvoker = AccumulateTimeoutInvoker;

                // Viewport: the coordinate is the offset between the point and the front top conner of document, rtl is taken into account
                // ViewportRelative: the coordinate is the offset between two points, rtl is taken into account
                (function (CoordinateType) {
                    CoordinateType[CoordinateType["Viewport"] = 0] = "Viewport";
                    CoordinateType[CoordinateType["ViewportRelative"] = 1] = "ViewportRelative";
                })(Support.CoordinateType || (Support.CoordinateType = {}));
                var CoordinateType = Support.CoordinateType;

                var Coordinate = (function () {
                    function Coordinate(type, x, y, rtl, width) {
                        if (typeof rtl === "undefined") { rtl = false; }
                        type = parseInt(type);
                        x = parseFloat(x);
                        y = parseFloat(y);
                        width = parseFloat(width);
                        rtl = !!rtl;

                        if (Support.CoordinateType[type] == undefined) {
                            throw createError(0, 'Coordinate', 'type must be a value of CoordinateType');
                        }

                        if (!isNaN(width) &amp;&amp; width &lt; 0) {
                            throw createError('0', 'Coordinate', 'width must be greater or equal than zero');
                        }

                        this._options = new Support.PropertyBag({
                            type: type,
                            x: x,
                            y: y,
                            width: width,
                            rtl: rtl
                        });
                    }
                    Coordinate._addViewportByViewportRelative = function (left, right) {
                        var xOffset = right._options.x, yOffset = right._options.y;

                        if (left._options.rtl != right._options.rtl) {
                            xOffset = -xOffset;
                        }

                        var x = left._options.x + xOffset, y = left._options.y + yOffset, rtl = left._options.rtl, width = left._options.width;

                        return new Coordinate(0 /* Viewport */, x, y, rtl, width);
                    };

                    Coordinate._addViewportRelativeByViewportRelative = function (left, right) {
                        var xOffset = right._options.x, yOffset = right._options.y;

                        if (left._options.rtl != right._options.rtl) {
                            xOffset = -xOffset;
                        }

                        var x = left._options.x + xOffset, y = left._options.y + yOffset, rtl = left._options.rtl;

                        return new Coordinate(1 /* ViewportRelative */, x, y, rtl, NaN);
                    };

                    Coordinate._minusViewportByViewportRelative = function (left, right) {
                        var xOffset = right._options.x, yOffset = right._options.y;

                        if (left._options.rtl != right._options.rtl) {
                            xOffset = -xOffset;
                        }

                        var x = left._options.x - xOffset, y = left._options.y - yOffset, rtl = left._options.rtl, width = left._options.width;

                        return new Coordinate(0 /* Viewport */, x, y, rtl, width);
                    };

                    Coordinate._minusViewportRelativeByViewportRelative = function (left, right) {
                        var xOffset = right._options.x, yOffset = right._options.y;

                        if (left._options.rtl != right._options.rtl) {
                            xOffset = -xOffset;
                        }

                        var x = left._options.x - xOffset, y = left._options.y - yOffset, rtl = left._options.rtl;

                        return new Coordinate(1 /* ViewportRelative */, x, y, rtl, NaN);
                    };

                    Coordinate._minusViewportByViewport = function (left, right) {
                        if (left._options.rtl != right._options.rtl &amp;&amp; left._options.width != right._options.width) {
                            throw createError(0, 'Coordinate', 'width does not match');
                        }

                        var xOffset = right._options.x, yOffset = right._options.y;

                        if (left._options.rtl != right._options.rtl) {
                            xOffset = right._options.width - xOffset;
                        }

                        var x = left._options.x - xOffset, y = left._options.y - right._options.y, rtl = left._options.rtl, width = left._options.width;

                        return new Coordinate(1 /* ViewportRelative */, x, y, rtl, width);
                    };

                    Coordinate.prototype.rtl = function (rtl) {
                        var _this = this;
                        return this._options.$property({
                            name: 'rtl',
                            args: arguments,
                            beforeChange: function (sender, args) {
                                if (_this._options.type == 0 /* Viewport */) {
                                    if (isNaN(_this._options.width)) {
                                        throw createError(0, 'Coordinate', 'missing width to toggle rtl');
                                    }

                                    _this._options.x = _this._options.width - _this._options.x;
                                }
                            }
                        });
                    };

                    Coordinate.prototype.x = function (x) {
                        return this._options.$property({
                            name: 'x',
                            args: arguments
                        });
                    };

                    Coordinate.prototype.y = function (y) {
                        return this._options.$property({
                            name: 'y',
                            args: arguments
                        });
                    };

                    Coordinate.prototype.front = function (front) {
                        return this.x.apply(this, arguments);
                    };

                    Coordinate.prototype.top = function (top) {
                        return this.y.apply(this, arguments);
                    };

                    Coordinate.prototype.width = function (width) {
                        return this._options.$property({
                            name: 'width',
                            args: arguments,
                            beforeChange: function (sender, args) {
                                args.newValue = parseFloat(args.newValue);

                                if (!isNaN(args.newValue) &amp;&amp; args.newValue &lt; 0) {
                                    throw createError('0', 'Coordinate', 'width must be greater or equal than zero');
                                }
                            }
                        });
                    };

                    Coordinate.prototype.add = function (target) {
                        if (this._options.rtl != target._options.rtl) {
                            throw createError(0, 'Coordinate', 'cannot mix calculating ltr and rtl');
                        }

                        var leftType = this._options.type, rightType = target._options.type;
                        var func = Coordinate['_add' + Support.CoordinateType[leftType] + 'By' + Support.CoordinateType[rightType]];

                        if (!func) {
                            throw createError(0, 'Coordinate', 'cannot add ' + Support.Coordinate[rightType] + ' to ' + Support.Coordinate[leftType]);
                        }

                        return func(this, target);
                    };

                    Coordinate.prototype.minus = function (target) {
                        if (this._options.rtl != target._options.rtl) {
                            throw createError(0, 'Coordinate', 'cannot mix calculating ltr and rtl');
                        }

                        var leftType = this._options.type, rightType = target._options.type;
                        var func = Coordinate['_minus' + Support.CoordinateType[leftType] + 'By' + Support.CoordinateType[rightType]];

                        if (!func) {
                            throw createError(0, 'Coordinate', 'cannot minus ' + Support.Coordinate[rightType] + ' to ' + Support.Coordinate[leftType]);
                        }

                        return func(this, target);
                    };

                    Coordinate.prototype.type = function (type) {
                        return this._options.type;
                    };
                    return Coordinate;
                })();
                Support.Coordinate = Coordinate;

                var CoordinateFactory = (function () {
                    function CoordinateFactory() {
                    }
                    CoordinateFactory.fromElement = function (rtl, element) {
                        var offset = element.offset();
                        var coordinate;

                        if (rtl) {
                            coordinate = new Support.Coordinate(0 /* Viewport */, offset.left + element.width(), offset.top, false, $(document).width());
                            coordinate.rtl(rtl);
                        } else {
                            coordinate = new Support.Coordinate(0 /* Viewport */, offset.left, offset.top);
                        }

                        return coordinate;
                    };

                    CoordinateFactory.fromEvent = function (rtl, event) {
                        var result = {};

                        if (Support.BrowserDetector.isTouchEvent(event.type)) {
                            for (var i = 0; i &lt; event.originalEvent.touches.length; i++) {
                                var touch = event.originalEvent.touches[i];
                                var coordinate;

                                if (rtl) {
                                    coordinate = new Support.Coordinate(0 /* Viewport */, touch.pageX, touch.pageY, false, $(document).width());
                                } else {
                                    coordinate = new Support.Coordinate(0 /* Viewport */, touch.pageX, touch.pageY, false);
                                }

                                coordinate.rtl(rtl);
                                result['touch.' + touch.identifier] = coordinate;
                            }
                            ;
                        } else {
                            var coordinate;

                            if (rtl) {
                                coordinate = new Support.Coordinate(0 /* Viewport */, event.pageX, event.pageY, false, $(document).width());
                            } else {
                                coordinate = new Support.Coordinate(0 /* Viewport */, event.pageX, event.pageY, false);
                            }

                            coordinate.rtl(rtl);
                            result['mouse'] = coordinate;
                        }

                        return result;
                    };

                    CoordinateFactory.scrollFromElement = function (rtl, element) {
                        var scrollLeft = element.scrollLeft(), scrollFront = scrollLeft, scrollOverflowWidth = element[0].scrollWidth - element[0].clientWidth, scrollTop = element[0].scrollTop;

                        if (rtl) {
                            // scrollFront = scrollOverflowWidth - scrollLeft;
                            if (TextDirection.zeroEnd() == 'front' &amp;&amp; TextDirection.scrollFrontDirection() == 1) {
                                scrollFront = scrollLeft;
                            } else if (TextDirection.zeroEnd() == 'front' &amp;&amp; TextDirection.scrollFrontDirection() == -1) {
                                // FireFox
                                scrollFront = -scrollLeft;
                            } else if (TextDirection.zeroEnd() == 'end' &amp;&amp; TextDirection.scrollFrontDirection() == 1) {
                                // Chrome
                                scrollFront = Math.max(0, scrollOverflowWidth - scrollLeft);
                            } else if (TextDirection.zeroEnd() == 'end' &amp;&amp; TextDirection.scrollFrontDirection() == -1) {
                                // Unknown
                                scrollFront = Math.max(0, scrollLeft - scrollOverflowWidth);
                            }
                        }

                        return new Support.Coordinate(1 /* ViewportRelative */, scrollFront, scrollTop, rtl, NaN);
                    };
                    return CoordinateFactory;
                })();
                Support.CoordinateFactory = CoordinateFactory;

                var RenderingSchedulerState;
                (function (RenderingSchedulerState) {
                    RenderingSchedulerState[RenderingSchedulerState["Ready"] = 0] = "Ready";
                    RenderingSchedulerState[RenderingSchedulerState["Active"] = 1] = "Active";
                    RenderingSchedulerState[RenderingSchedulerState["Suspending"] = 2] = "Suspending";
                    RenderingSchedulerState[RenderingSchedulerState["Suspended"] = 3] = "Suspended";
                    RenderingSchedulerState[RenderingSchedulerState["Stopped"] = 4] = "Stopped";
                })(RenderingSchedulerState || (RenderingSchedulerState = {}));

                var RenderingScheduler = (function () {
                    function RenderingScheduler() {
                        var _this = this;
                        this._workers = [];
                        this._state = 0 /* Ready */;
                        this._handlerSet = 0;
                        this._workerThreshold = RenderingScheduler.InitialWorkerThreshold;
                        this._recentInvokeTime = [];
                        this._creationTime = Support.BrowserDetector.now();
                        this.disposer = new Controls.Fundamental.Disposer(function () {
                            _this._state = 4 /* Stopped */;
                            _this._workers = null;
                        });
                    }
                    RenderingScheduler.prototype.dispose = function () {
                        this.disposer.dispose();
                    };

                    RenderingScheduler.prototype.addWorker = function (worker, context, priority) {
                        if (typeof context === "undefined") { context = null; }
                        if (typeof priority === "undefined") { priority = 1000; }
                        this._workers.push({ priority: priority, worker: worker, context: context });
                        this._workers.sort(function (left, right) {
                            return left.priority == right.priority ? 0 : left.priority &lt; right.priority ? -1 : 1;
                        });
                    };

                    RenderingScheduler.prototype.suspend = function (tillNoAction) {
                        if (this._state == 0 /* Ready */ || this._state == 4 /* Stopped */) {
                            throw Support.createError(0, 'RenderingScheduler', 'cannot suspend since it is not started or stopped already');
                        }

                        if (tillNoAction) {
                            this._state = 2 /* Suspending */;
                        } else {
                            this._state = 3 /* Suspended */;
                        }
                    };

                    RenderingScheduler.prototype.resume = function () {
                        if (this._state == 0 /* Ready */ || this._state == 4 /* Stopped */) {
                            throw Support.createError(0, 'RenderingScheduler', 'cannot resume since it is not started or stopped already');
                        }

                        this._state = 1 /* Active */;
                        this._schedule();
                    };

                    RenderingScheduler.prototype.start = function (run) {
                        if (this._state != 0 /* Ready */) {
                            throw Support.createError(0, 'RenderingScheduler', 'cannot start from non-ready state');
                        }

                        if (run) {
                            this._state = 1 /* Active */;
                            this._schedule();
                        } else {
                            this._state = 3 /* Suspended */;
                        }
                    };

                    RenderingScheduler.prototype._doWork = function () {
                        if (this._state == 3 /* Suspended */ || this._state == 2 /* Suspending */ || this._state == 4 /* Stopped */) {
                            return;
                        }

                        var startTime = Support.BrowserDetector.now(), endTime;

                        this._recentInvokeTime.push(startTime);

                        while (this._recentInvokeTime[0] &lt; startTime - RenderingScheduler.CalculatePeriod) {
                            this._recentInvokeTime.splice(0, 1);
                        }

                        var fps = this._recentInvokeTime.length + 1000 / RenderingScheduler.CalculatePeriod;

                        if (fps &lt; RenderingScheduler.FPSLowerBound) {
                            this._workerThreshold *= RenderingScheduler.Factor;
                        } else {
                            this._workerThreshold /= RenderingScheduler.Factor;
                        }

                        if (this._workerThreshold > RenderingScheduler.ThresholdUpperBound) {
                            this._workerThreshold = RenderingScheduler.ThresholdUpperBound;
                        } else if (this._workerThreshold &lt; RenderingScheduler.ThresholdLowerBound) {
                            this._workerThreshold = RenderingScheduler.ThresholdLowerBound;
                        }

                        if (this._creationTime > startTime - RenderingScheduler.StartTimePeriod) {
                            this._workerThreshold = RenderingScheduler.ThresholdUpperBound;
                        }

                        var count = 0;
                        var workerIndex = 0;

                        while (workerIndex &lt; this._workers.length) {
                            var result = this._workers[workerIndex].worker(this._workers[workerIndex].context);

                            if (typeof (result) == 'undefined' || !result) {
                                workerIndex++;
                            }

                            count++;

                            if (this._state == 3 /* Suspended */ || this._state == 4 /* Stopped */) {
                                return;
                            }

                            endTime = Support.BrowserDetector.now();

                            if (endTime - startTime > this._workerThreshold) {
                                break;
                            }
                        }

                        // console.log('fps: ' + fps + ', threshold: ' + this._workerThreshold + 'ms, start: ' + startTime + '; end: ' + endTime + '; count: ' + count);
                        if (this._state == 2 /* Suspending */) {
                            this._state = 3 /* Suspended */;
                            this._recentInvokeTime = [];
                            this._workerThreshold = RenderingScheduler.InitialWorkerThreshold;
                            return;
                        }

                        this._schedule();
                    };

                    RenderingScheduler.prototype._schedule = function () {
                        var _this = this;
                        if (this._handlerSet == 0) {
                            Support.BrowserDetector.requestAnimationFrame(function () {
                                _this._handlerSet--;
                                _this._doWork();
                            });

                            this._handlerSet++;
                        }
                    };
                    RenderingScheduler.InitialWorkerThreshold = 400;
                    RenderingScheduler.CalculatePeriod = 500;
                    RenderingScheduler.FPSUpperBound = 30;
                    RenderingScheduler.FPSLowerBound = 10;
                    RenderingScheduler.ThresholdUpperBound = 400;
                    RenderingScheduler.ThresholdLowerBound = 5;
                    RenderingScheduler.StartTimePeriod = 3000;
                    RenderingScheduler.Factor = 0.5;
                    return RenderingScheduler;
                })();
                Support.RenderingScheduler = RenderingScheduler;
            })(Controls.Support || (Controls.Support = {}));
            var Support = Controls.Support;

            var Constants = (function () {
                function Constants() {
                }
                Constants.RatioToOperationScrollArea = 0.2;
                Constants.OperationScrollNumber = 20;
                return Constants;
            })();

            (function (SelectionMode) {
                SelectionMode[SelectionMode["SingleRow"] = 0] = "SingleRow";
                SelectionMode[SelectionMode["MultipleRows"] = 1] = "MultipleRows";
                SelectionMode[SelectionMode["Cell"] = 2] = "Cell";
                SelectionMode[SelectionMode["Range"] = 3] = "Range";
            })(Controls.SelectionMode || (Controls.SelectionMode = {}));
            var SelectionMode = Controls.SelectionMode;

            (function (RangeType) {
                RangeType[RangeType["Row"] = 0] = "Row";
                RangeType[RangeType["Column"] = 1] = "Column";
                RangeType[RangeType["Range"] = 2] = "Range";
            })(Controls.RangeType || (Controls.RangeType = {}));
            var RangeType = Controls.RangeType;

            var RenderState;
            (function (RenderState) {
                RenderState[RenderState["Initial"] = 0] = "Initial";
                RenderState[RenderState["OutDated"] = 1] = "OutDated";
                RenderState[RenderState["Painted"] = 2] = "Painted";
            })(RenderState || (RenderState = {}));
            ;

            (function (ViewType) {
                ViewType[ViewType["Table"] = 0] = "Table";
                ViewType[ViewType["Stack"] = 1] = "Stack";
            })(Controls.ViewType || (Controls.ViewType = {}));
            var ViewType = Controls.ViewType;

            (function (CursorMovement) {
                CursorMovement[CursorMovement["Forward"] = 0] = "Forward";
                CursorMovement[CursorMovement["Backward"] = 1] = "Backward";
                CursorMovement[CursorMovement["Up"] = 2] = "Up";
                CursorMovement[CursorMovement["Down"] = 3] = "Down";
                CursorMovement[CursorMovement["LineFirst"] = 4] = "LineFirst";
                CursorMovement[CursorMovement["LineEnd"] = 5] = "LineEnd";
                CursorMovement[CursorMovement["PageUp"] = 6] = "PageUp";
                CursorMovement[CursorMovement["PageDown"] = 7] = "PageDown";
                CursorMovement[CursorMovement["Top"] = 8] = "Top";
                CursorMovement[CursorMovement["Bottom"] = 9] = "Bottom";
            })(Controls.CursorMovement || (Controls.CursorMovement = {}));
            var CursorMovement = Controls.CursorMovement;

            /// &lt;summary>
            /// Column definition, used by list control
            /// &lt;/summary>
            var ColumnDefinition = (function () {
                function ColumnDefinition() {
                }
                return ColumnDefinition;
            })();
            Controls.ColumnDefinition = ColumnDefinition;

            var TableViewEditOperation = (function () {
                function TableViewEditOperation() {
                    var _this = this;
                    this.disposer = new Controls.Fundamental.Disposer(function () {
                        _this._events.emit('close', _this, null);

                        if (_this._deferred.state() == 'pending') {
                            _this._deferred.reject();
                        }

                        if (_this._editElement) {
                            _this._editElement.remove();
                        }
                    });
                }
                TableViewEditOperation.prototype.start = function (tableView, runtime, rowIndex, columnIndex) {
                    var _this = this;
                    this._tableView = tableView;
                    this._runtime = runtime;
                    this._rowIndex = rowIndex;
                    this._columnUniqueId = tableView.visibleColumnMap()[columnIndex];
                    this._columnIndex = columnIndex;
                    this.disposer.addDisposable(this._events = new Support.EventSite());
                    this._deferred = $.Deferred();
                    var column = this._runtime.options.columns[this._columnUniqueId];

                    this._editor = column.cellEditor;

                    if (!this._editor) {
                        this._deferred.reject();
                        return this._deferred.promise();
                    }

                    var cellRange = this._tableView.getCellRect(this._rowIndex, this._columnIndex);

                    this._editElement = $('&lt;div class="msoc-list-table-cell-editing" tabindex="">&lt;/div>');
                    this._editElement.css('top', cellRange.top);
                    this._editElement.css('height', cellRange.height);
                    this._editElement.css(this._runtime.direction.front(), cellRange.front);
                    this._editElement.css('width', cellRange.width);

                    this._runtime.elements.canvas.eq(TableView.CursorCanvasIndex).append(this._editElement);

                    this.disposer.addDisposable(new Support.EventAttacher(this._runtime.events, 'beforeMouseDownFocus', function (sender, args) {
                        if (args.event.target == _this._editElement[0]) {
                            args.element = $(event.target);
                        } else if ($.contains(_this._editElement[0], args.event.target)) {
                            args.cancel = true;
                        }
                    }));

                    this.disposer.addDisposable(this._stylesheet = new Support.DynamicStylesheet(this._runtime.id + '_edit'));

                    var cssText = new Support.CssTextBuilder(), row = this._runtime.getRowByIndex(rowIndex);

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-row.msoc-list-table-row-');
                    cssText.push(row.rowUniqueId);
                    cssText.push('>.msoc-list-table-cell-');
                    cssText.push(this._columnUniqueId);
                    cssText.property('visibility', 'hidden');

                    this._stylesheet.content(cssText.toString());

                    var row = this._runtime.options.rows[this._rowIndex];
                    var cellData = row[column.raw.field];

                    this._editor.edit({
                        element: this._editElement[0],
                        keepRect: function (height, width) {
                            var cellRect = _this._tableView.getCellRect(_this._rowIndex, _this._columnIndex);

                            _this._runtime.scrollIntoView(cellRect.top, cellRect.front, Math.max(cellRect.height, height), Math.max(cellRect.width, width));
                        },
                        events: this._events,
                        width: cellRange.width,
                        height: cellRange.height,
                        row: row,
                        rowIndex: this._rowIndex,
                        column: column.raw,
                        columnIndex: this._tableView.getColumnIndexById(this._columnUniqueId),
                        columnId: this._columnUniqueId,
                        cellData: cellData
                    });

                    this.disposer.addDisposable(new Support.EventAttacher(this._events, 'accept', function (sender, args) {
                        return _this._deferred.resolve(args);
                    }));
                    this.disposer.addDisposable(new Support.EventAttacher(this._events, 'reject', function () {
                        return _this._deferred.reject();
                    }));

                    return this._deferred.promise();
                };

                TableViewEditOperation.prototype.dispose = function () {
                    this.disposer.dispose();
                };
                return TableViewEditOperation;
            })();

            var TableViewKeySelectOperation = (function () {
                function TableViewKeySelectOperation() {
                    this.disposer = new Controls.Fundamental.Disposer(function () {
                    });
                }
                TableViewKeySelectOperation.prototype.start = function (tableView, runtime, event, selectionUpdater) {
                    this._tableView = tableView;
                    this._visibleColumnMap = this._tableView.visibleColumnMap();
                    this._runtime = runtime;

                    var shiftKey = event.shiftKey, deferred = $.Deferred();

                    if (this._runtime.selection.selectionMode() == 0 /* SingleRow */ &amp;&amp; this._runtime.selection.selectionMode() == 2 /* Cell */) {
                        deferred.reject();
                        return deferred.promise();
                    }

                    if (!this._runtime.selection.cursor().isValid()) {
                        deferred.reject();
                        return deferred.promise();
                    }

                    var selectedRange = this._runtime.selection.rangeOfCursor();

                    if (event.type == 'keypress' &amp;&amp; event.keyCode == 32) {
                        switch (this._runtime.selection.selectionMode()) {
                            case 1 /* MultipleRows */:
                                if (selectedRange) {
                                    deferred.resolve({
                                        action: 'deselect',
                                        range: new Range(0 /* Row */, this._runtime.selection.cursor().rowIndex, this._runtime.selection.cursor().rowIndex, NaN, NaN)
                                    });
                                } else {
                                    deferred.resolve({
                                        action: 'select',
                                        range: new Range(0 /* Row */, this._runtime.selection.cursor().rowIndex, this._runtime.selection.cursor().rowIndex, NaN, NaN)
                                    });
                                }

                                return deferred.promise();

                            case 3 /* Range */:
                                if (selectedRange) {
                                    deferred.resolve({
                                        action: 'deselect',
                                        range: selectedRange
                                    });
                                } else {
                                    deferred.resolve({
                                        action: 'select',
                                        range: new Range(2 /* Range */, this._runtime.selection.cursor().rowIndex, this._runtime.selection.cursor().rowIndex, this._runtime.selection.cursor().columnIndex, this._runtime.selection.cursor().columnIndex)
                                    });
                                }

                                return deferred.promise();
                        }
                    }

                    if (!shiftKey) {
                        deferred.reject();
                        return deferred.promise();
                    }

                    return deferred.promise();
                };

                TableViewKeySelectOperation.prototype.dispose = function () {
                    this.disposer.dispose();
                };
                return TableViewKeySelectOperation;
            })();

            var TableViewMouseSelectOperation = (function () {
                function TableViewMouseSelectOperation() {
                    var _this = this;
                    this.disposer = new Controls.Fundamental.Disposer(function () {
                        _this._runtime.selection = _this._oldSelection;
                        _this._selectionUpdater.update();
                    });
                }
                TableViewMouseSelectOperation.prototype.start = function (tableView, runtime, event, selectionUpdater) {
                    var _this = this;
                    this._tableView = tableView;
                    this._visibleColumnMap = this._tableView.visibleColumnMap();
                    this._runtime = runtime;
                    this._oldSelection = this._runtime.selection;
                    this._selectionUpdater = selectionUpdater;
                    this._cellElement = $(event.target).closest('.msoc-list-table-cell');
                    this._rtl = this._runtime.direction.rtl();
                    this._deferred = $.Deferred();
                    var rowUniqueId = this._cellElement.attr('data-rowUniqueId');
                    var columnUniqueId = this._cellElement.attr('data-columnUniqueId');

                    if (!rowUniqueId || !columnUniqueId) {
                        this._runtime.selection = this._oldSelection;
                        this._deferred.reject();
                        return this._deferred.promise();
                    }

                    if (this._oldSelection.selectionMode() == 0 /* SingleRow */ || this._oldSelection.selectionMode() == 2 /* Cell */) {
                        this._runtime.selection = this._oldSelection;
                        this._deferred.reject();
                        return this._deferred.promise();
                    }

                    this._firstColumnIndex = this._visibleColumnMap.indexOf(columnUniqueId);
                    this._firstRowIndex = this._runtime.getRowByUniqueId(rowUniqueId).rowIndex;

                    this._selectionMode = this._runtime.selection.selectionMode();

                    this.disposer.addDisposable(new Support.EventAttacher($(window), 'mouseup', function (event) {
                        return _this._onMouseUp(event);
                    }));
                    this.disposer.addDisposable(new Support.EventAttacher($(window), 'mousemove', function (event) {
                        return _this._onMouseMove(event);
                    }));
                    return this._deferred.promise();
                };

                TableViewMouseSelectOperation.prototype._onMouseUp = function (event) {
                    if (event.which == 1) {
                        this._runtime.selection = this._oldSelection;

                        if (this._selectedRange) {
                            this._deferred.resolve({
                                range: this._selectedRange,
                                action: 'select'
                            });
                        } else {
                            this._deferred.reject();
                        }
                    }
                };

                TableViewMouseSelectOperation.prototype._onMouseMove = function (event) {
                    var cellElement = $(event.target).closest('.msoc-list-table-cell');
                    var rowUniqueId = cellElement.attr('data-rowUniqueId');
                    var columnUniqueId = cellElement.attr('data-columnUniqueId');

                    if (!rowUniqueId || !columnUniqueId) {
                        return;
                    }

                    var columnIndex = this._visibleColumnMap.indexOf(columnUniqueId);
                    var rowIndex = this._runtime.getRowByUniqueId(rowUniqueId).rowIndex;
                    var rtl = this._runtime.direction.rtl();

                    if (this._selectionMode != 1 /* MultipleRows */ &amp;&amp; this._selectionMode != 3 /* Range */) {
                        return;
                    }

                    var pointerToViewportCoordinate = Support.CoordinateFactory.fromEvent(this._rtl, event)['mouse'].minus(Support.CoordinateFactory.fromElement(this._rtl, this._runtime.elements.headerViewport));
                    var frontOffset, topOffset;

                    if (pointerToViewportCoordinate.front() &lt; this._runtime.viewportClientWidth * Constants.RatioToOperationScrollArea) {
                        frontOffset = -Constants.OperationScrollNumber;
                    } else if (pointerToViewportCoordinate.front() > this._runtime.viewportClientWidth * (1 - Constants.RatioToOperationScrollArea)) {
                        frontOffset = Constants.OperationScrollNumber;
                    }

                    if (pointerToViewportCoordinate.top() &lt; this._runtime.viewportClientHeight * Constants.RatioToOperationScrollArea) {
                        topOffset = -Constants.OperationScrollNumber;
                    } else if (pointerToViewportCoordinate.top() > this._runtime.viewportClientHeight * (1 - Constants.RatioToOperationScrollArea)) {
                        topOffset = Constants.OperationScrollNumber;
                    }

                    if (frontOffset != 0 || topOffset != 0) {
                        this._runtime.scroll(topOffset, frontOffset);
                    }

                    if (isNaN(rowIndex) || isNaN(columnIndex)) {
                        return;
                    }

                    if ((this._selectionMode == 1 /* MultipleRows */ &amp;&amp; this._lastRowIndex != rowIndex) || (this._selectionMode == 3 /* Range */ &amp;&amp; (this._lastRowIndex != rowIndex || this._lastColumnIndex != columnIndex))) {
                        this._lastRowIndex = rowIndex;
                        this._lastColumnIndex = columnIndex;

                        if (this._selectionMode == 0 /* SingleRow */ || this._selectionMode == 1 /* MultipleRows */) {
                            this._selectedRange = new Range(0 /* Row */, this._firstRowIndex, rowIndex, NaN, NaN);
                        } else {
                            this._selectedRange = new Range(2 /* Range */, this._firstRowIndex, rowIndex, this._firstColumnIndex, columnIndex);
                        }

                        this._runtime.selection = this._oldSelection.clone();
                        this._runtime.selection.select(this._selectedRange);
                        this._selectionUpdater.update();
                    }
                };

                TableViewMouseSelectOperation.prototype.dispose = function () {
                    this.disposer.dispose();
                };
                return TableViewMouseSelectOperation;
            })();

            var TableViewReorderColumnOperation = (function () {
                function TableViewReorderColumnOperation() {
                    var _this = this;
                    this.disposer = new Controls.Fundamental.Disposer(function () {
                        _this._runtime.elements.root.removeClass('msoc-list-table-operation-ReorderColumn');
                        _this._runtime.elements.canvas.eq(TableView.CursorCanvasIndex).show();
                        _this._selectionStylesheet.content(_this._selectionStylesheetText);
                        _this._headerCellElement.removeClass('msoc-list-table-header-cell-moving');

                        if (_this._headerCellCoverElement) {
                            _this._headerCellCoverElement.remove();
                        }
                    });
                }
                TableViewReorderColumnOperation.prototype.start = function (tableView, runtime, headerCellElement, isTouch, pointerId, pointerDownCoordinate, selectionStylesheet) {
                    var _this = this;
                    this._deferred = $.Deferred();
                    this._tableView = tableView;
                    this._runtime = runtime;
                    this._runtime.elements.root.addClass('msoc-list-table-operation-ReorderColumn');
                    this._selectionStylesheet = selectionStylesheet;
                    this._rtl = this._runtime.direction.rtl();
                    this._headerCellElement = headerCellElement;
                    this._isTouch = isTouch;
                    this._pointerId = pointerId;
                    this._startPointToHeaderElement = Support.CoordinateFactory.fromElement(this._rtl, this._headerCellElement).minus(pointerDownCoordinate);
                    this._pointerDownCoordinate = pointerDownCoordinate;
                    this._startPointToHeaderElement.rtl(this._rtl);
                    this._started = false;
                    this._visibleColumnMap = this._tableView.visibleColumnMap();
                    this._reorderColumnUniqueId = this._headerCellElement.attr('data-columnUniqueId');
                    this._reorderColumnIndex = this._visibleColumnMap.indexOf(this._reorderColumnUniqueId);
                    this._selectionStylesheetText = this._selectionStylesheet.content();

                    var args = {
                        fromColumnIndex: this._reorderColumnIndex,
                        cancel: false
                    };

                    this._runtime.events.emit('table.beforeColumnReorder', this, args);

                    if (!!args.cancel) {
                        this._deferred.reject();
                        return this._deferred.promise();
                    }

                    this.disposer.addDisposable(this._transitionStylesheet = new Support.DynamicStylesheet(this._runtime.id + '_moving_column_transition'));
                    this.disposer.addDisposable(this._movingStylesheet = new Support.DynamicStylesheet(this._runtime.id + '_moving_column'));
                    this.disposer.addDisposable(this._currentColumnStylesheet = new Support.DynamicStylesheet(this._runtime.id + '_moving_current_column'));
                    this._runtime.elements.canvas.eq(TableView.CursorCanvasIndex).hide();
                    this._lastNewPlaceIndex = -1;

                    this._selectionStylesheet.content('');

                    var cssText = new Support.CssTextBuilder();

                    this._runtime.buildCssRootSelector(cssText, '.msoc-list-table-operation-ReorderColumn');
                    cssText.push('.msoc-list-table-header-cell');
                    cssText.property('transition', this._runtime.direction.front() + ' 200ms');

                    this._runtime.buildCssRootSelector(cssText, '.msoc-list-table-operation-ReorderColumn');
                    cssText.push('.msoc-list-table-header-cell.msoc-list-table-header-cell-');
                    cssText.push(this._reorderColumnUniqueId);
                    cssText.property('transition', 'none');

                    this._runtime.buildCssRootSelector(cssText, '.msoc-list-table-operation-ReorderColumn');
                    cssText.push('.msoc-list-table-header-cell-v-border-');
                    cssText.push(this._reorderColumnUniqueId);
                    cssText.property('display', 'none');

                    this._transitionStylesheet.content(cssText.toString());

                    this.disposer.addDisposable(new Support.EventAttacher($(window), this._isTouch ? 'touchend' : 'mouseup', function (event) {
                        return _this._onPointerUp(event);
                    }));
                    this.disposer.addDisposable(new Support.EventAttacher($(window), this._isTouch ? 'touchmove' : 'mousemove', function (event) {
                        return _this._onPointerMove(event);
                    }));

                    this._headerViewportCoordinate = Support.CoordinateFactory.fromElement(this._rtl, this._runtime.elements.headerViewport);
                    return this._deferred.promise();
                };

                TableViewReorderColumnOperation.prototype._onPointerUp = function (event) {
                    if (event.which == 1 || (this._isTouch &amp;&amp; Support.BrowserDetector.getChangedPointerIdentifier(event).indexOf(this._pointerId) >= 0)) {
                        if (this._started &amp;&amp; this._lastNewPlaceIndex >= 0 &amp;&amp; this._lastNewPlaceIndex != this._reorderColumnIndex) {
                            this._deferred.resolve(this._reorderColumnIndex, this._lastNewPlaceIndex);
                        } else {
                            this._deferred.reject();
                        }
                    }
                };

                TableViewReorderColumnOperation.prototype._onPointerMove = function (event) {
                    var pointerCoordinate = Support.CoordinateFactory.fromEvent(this._rtl, event)[this._pointerId];

                    if (!this._started) {
                        var offsetMovement = pointerCoordinate.minus(this._pointerDownCoordinate);

                        if (offsetMovement.x() > 5 || offsetMovement.x() &lt; -5 || offsetMovement.y() > 5 || offsetMovement.y() &lt; -5) {
                            this._started = true;
                        } else {
                            return;
                        }
                    }

                    var headerWidth = this._runtime.elements.headerViewport.width();
                    var pointerToHeaderViewCoordinate = pointerCoordinate.minus(this._headerViewportCoordinate);

                    this._headerCellElement.addClass('msoc-list-table-header-cell-moving');

                    if (!this._headerCellCoverElement) {
                        this._headerCellElement.append(this._headerCellCoverElement = $('&lt;div>&lt;/div>'));
                        this._headerCellCoverElement.css('position', 'absolute');
                        this._headerCellCoverElement.css('top', '0px');
                        this._headerCellCoverElement.css('bottom', '0px');
                        this._headerCellCoverElement.css('left', '0px');
                        this._headerCellCoverElement.css('right', '0px');
                    }

                    pointerToHeaderViewCoordinate.rtl(this._rtl);

                    if (pointerToHeaderViewCoordinate.front() &lt; headerWidth * Constants.RatioToOperationScrollArea) {
                        this._runtime.scroll(0, -Constants.OperationScrollNumber);
                    } else if (pointerToHeaderViewCoordinate.front() > headerWidth * (1 - Constants.RatioToOperationScrollArea)) {
                        this._runtime.scroll(0, Constants.OperationScrollNumber);
                    }

                    var pointerCoordinate = Support.CoordinateFactory.scrollFromElement(this._rtl, this._runtime.elements.headerViewport).add(pointerToHeaderViewCoordinate);
                    var currentColumnCssText = new Support.CssTextBuilder();
                    var headerCellRect = this._tableView.getHeaderCellRect(this._reorderColumnUniqueId);

                    this._runtime.buildCssRootSelector(currentColumnCssText, '.msoc-list-table-operation-ReorderColumn');
                    currentColumnCssText.push('.msoc-list-table-header-cell-');
                    currentColumnCssText.push(this._reorderColumnUniqueId);
                    currentColumnCssText.property(this._runtime.direction.front(), pointerCoordinate.front() - headerCellRect.width / 2, 'px');
                    currentColumnCssText.property('z-index', 1);
                    currentColumnCssText.property('filter', 'alpha(opacity=90)');
                    currentColumnCssText.property('-moz-opacity', 0.9);
                    currentColumnCssText.property('-khtml-opacity', 0.9);
                    currentColumnCssText.property('opacity', 0.9);

                    this._runtime.buildCssRootSelector(currentColumnCssText, '.msoc-list-table-operation-ReorderColumn');
                    currentColumnCssText.push('.msoc-list-table-header-cell-v-border-');
                    currentColumnCssText.push(this._reorderColumnUniqueId);
                    currentColumnCssText.property('display', 'none');

                    this._currentColumnStylesheet.content(currentColumnCssText.toString());

                    var newPlaceIndex = this.getNewPlaceIndex(pointerCoordinate.front());

                    if (newPlaceIndex != this._lastNewPlaceIndex) {
                        var args = {
                            fromColumnIndex: this._reorderColumnIndex,
                            toColumnIndex: newPlaceIndex,
                            cancel: false
                        };

                        this._runtime.events.emit('table.beforeColumnReorder', this, args);

                        if (!args.cancel) {
                            this._lastNewPlaceIndex = newPlaceIndex;

                            if (newPlaceIndex != this._reorderColumnIndex) {
                                var movingToFront = this._reorderColumnIndex > newPlaceIndex, fromIndex = movingToFront ? newPlaceIndex : this._reorderColumnIndex, toIndex = movingToFront ? this._reorderColumnIndex : newPlaceIndex, front = this._runtime.options.columns[this._visibleColumnMap[fromIndex]].table.front;

                                if (movingToFront) {
                                    front += this._tableView.getColumnWidth(this._reorderColumnUniqueId) + this._runtime.options.theme.value('table.cellVBorder').width;
                                }

                                var cssText = new Support.CssTextBuilder();

                                for (var i = fromIndex; i &lt; toIndex; i++) {
                                    if (i == this._reorderColumnIndex) {
                                        continue;
                                    }

                                    var width = this._tableView.getColumnWidth(this._visibleColumnMap[i]);

                                    this._runtime.buildCssRootSelector(cssText, '.msoc-list-table-operation-ReorderColumn');
                                    cssText.push('.msoc-list-table-header-cell-');
                                    cssText.push(this._visibleColumnMap[i]);
                                    cssText.property(this._runtime.direction.front(), front, 'px');

                                    front += width + this._runtime.options.theme.value('table.cellVBorder').width;
                                }

                                this._movingStylesheet.content(cssText.toString());
                            }
                        }
                    }
                };

                TableViewReorderColumnOperation.prototype.getNewPlaceIndex = function (x) {
                    var newPlaceIndex = this._visibleColumnMap.length;

                    for (var i = 0; i &lt; this._visibleColumnMap.length; i++) {
                        var column = this._runtime.options.columns[this._visibleColumnMap[i]];

                        if (column.table.front + this._tableView.getColumnWidth(this._visibleColumnMap[i]) * 0.3 > x) {
                            newPlaceIndex = i;
                            break;
                        }
                    }

                    return newPlaceIndex;
                };

                TableViewReorderColumnOperation.prototype.dispose = function () {
                    this.disposer.dispose();
                };
                return TableViewReorderColumnOperation;
            })();

            var TableViewResizeColumnOperation = (function () {
                function TableViewResizeColumnOperation() {
                    var _this = this;
                    this.disposer = new Controls.Fundamental.Disposer(function () {
                        _this._selectionStylesheet.content(_this._selectionStylesheetText);
                        _this._splitters[0].remove();
                        _this._splitters[1].remove();
                        _this._runtime.elements.canvasContainer.css('width', _this._oldCanvasContainerWidth);
                        _this._runtime.elements.headerCanvasContainer.css('width', _this._oldHeaderCanvasContainerWidth);

                        // this._runtime.scrollTo(NaN, this._baseScrollCoordinate.front());
                        _this._headerCellElement.removeClass('msoc-list-table-header-cell-resizing');
                        _this._headerCellElement.attr('style', '');
                    });
                }
                TableViewResizeColumnOperation.prototype.start = function (tableView, runtime, columnUniqueId, isTouch, pointerId, pointers, initialFront, initialWidth, selectionStylesheet) {
                    var _this = this;
                    this._deferred = $.Deferred();
                    this._tableView = tableView;
                    this._runtime = runtime;
                    this._resizeColumnUniqueId = columnUniqueId;
                    this._headerCellElement = this._tableView.getHeaderCellElement(this._resizeColumnUniqueId);
                    this._isTouch = isTouch;
                    this._pointerId = pointerId;
                    this._rtl = this._runtime.direction.rtl();
                    this._startPointToHeaderViewportCoordinate = Support.CoordinateFactory.fromElement(this._rtl, this._runtime.elements.headerViewport).minus(pointers[pointerId]);
                    this._startPointToHeaderViewportCoordinate.rtl(this._rtl);
                    this._selectionStylesheet = selectionStylesheet;
                    this._initialFront = initialFront;
                    this._initialWidth = this._lastWidth = initialWidth;
                    this._oldCanvasContainerWidth = this._runtime.elements.canvasContainer.css('width');
                    this._oldHeaderCanvasContainerWidth = this._runtime.elements.canvasContainer.css('width');
                    this._baseScrollCoordinate = Support.CoordinateFactory.scrollFromElement(this._rtl, this._runtime.elements.viewport);
                    this._headerCellElement.addClass('msoc-list-table-header-cell-resizing');
                    this._selectionStylesheetText = this._selectionStylesheet.content();
                    this._selectionStylesheet.content('');
                    this.disposer.addDisposable(new Support.EventAttacher($(window), this._isTouch ? 'touchend' : 'mouseup', function (event) {
                        return _this._onPointerUp(event);
                    }));
                    this.disposer.addDisposable(new Support.EventAttacher($(window), this._isTouch ? 'touchmove' : 'mousemove', function (event) {
                        return _this._onPointerMove(event);
                    }));
                    this._splitters = [$('&lt;div class="msoc-list-table-resizer">&lt;/div>'), $('&lt;div class="msoc-list-table-resizer">&lt;/div>')];
                    this._runtime.elements.headerCanvas.eq(TableView.CursorCanvasIndex).append(this._splitters[0]);
                    this._runtime.elements.canvas.eq(TableView.CursorCanvasIndex).append(this._splitters[1]);
                    var scrollFrontCoordinate = Support.CoordinateFactory.scrollFromElement(this._rtl, this._runtime.elements.viewport);
                    var baseResizerCoordinate = scrollFrontCoordinate.add(this._startPointToHeaderViewportCoordinate);

                    this._splitters[0].css(this._runtime.direction.front(), baseResizerCoordinate.front() + 'px');
                    this._splitters[0].css('height', this._runtime.elements.headerCanvasContainer.height() + 'px');
                    this._splitters[1].css(this._runtime.direction.front(), baseResizerCoordinate.front() + 'px');
                    this._splitters[1].css('height', this._runtime.elements.canvasContainer.height() + 'px');
                    this._headerCanvasWidth = this._runtime.canvasWidth;
                    this._headerViewportCoordinate = Support.CoordinateFactory.fromElement(this._rtl, this._runtime.elements.headerViewport);
                    return this._deferred.promise();
                };

                TableViewResizeColumnOperation.prototype.dispose = function () {
                    this.disposer.dispose();
                };

                TableViewResizeColumnOperation.prototype._onPointerUp = function (event) {
                    if (event.which == 1 || this._isTouch) {
                        if (this._lastWidth >= 43 &amp;&amp; this._lastWidth != this._initialWidth) {
                            this._deferred.resolve(this._resizeColumnUniqueId, this._lastWidth);
                        } else {
                            this._deferred.reject();
                        }
                    }
                };

                TableViewResizeColumnOperation.prototype._onPointerMove = function (event) {
                    var headerWidth = this._runtime.viewportWidth;
                    var pointerCoordinate = Support.CoordinateFactory.fromEvent(this._rtl, event)[this._pointerId].minus(this._headerViewportCoordinate);
                    var scrollCoordinate = Support.CoordinateFactory.scrollFromElement(this._rtl, this._runtime.elements.headerViewport);

                    if (pointerCoordinate.front() &lt; headerWidth * Constants.RatioToOperationScrollArea) {
                        if (scrollCoordinate.front() - Constants.OperationScrollNumber > this._baseScrollCoordinate.front()) {
                            // Do not scroll front when we are already scroll to the position we started with
                            this._runtime.scroll(0, -Constants.OperationScrollNumber);
                        } else if (scrollCoordinate.front() > this._baseScrollCoordinate.front()) {
                            this._runtime.scroll(0, scrollCoordinate.front() - this._baseScrollCoordinate.front());
                        }
                    } else if (pointerCoordinate.front() > headerWidth * (1 - Constants.RatioToOperationScrollArea)) {
                        if (this._headerCanvasWidth &lt; scrollCoordinate.front() + this._runtime.viewportClientWidth + Constants.OperationScrollNumber) {
                            // Extend the canvas when we hit the end of it
                            this._runtime.elements.canvasContainer.css('width', (this._headerCanvasWidth + Constants.OperationScrollNumber) + 'px');
                            this._runtime.elements.headerCanvasContainer.css('width', (this._headerCanvasWidth + Constants.OperationScrollNumber) + 'px');
                            this._headerCanvasWidth += Constants.OperationScrollNumber;
                        }

                        this._runtime.scroll(0, Constants.OperationScrollNumber);
                    }

                    var minResizeFront = this._initialFront + 43;

                    var resizerFront = Math.max(scrollCoordinate.front() + pointerCoordinate.front(), minResizeFront);

                    var newWidth = resizerFront - this._initialFront;

                    this._lastWidth = newWidth;
                    this._headerCellElement.css('width', newWidth + 'px');
                    this._headerCellElement.css('z-index', 1);
                    this._headerCellElement.css('filter', 'alpha(opacity=90)');
                    this._headerCellElement.css('-moz-opacity', 0.9);
                    this._headerCellElement.css('-khtml-opacity', 0.9);
                    this._headerCellElement.css('opacity', 0.9);

                    this._splitters[0].css(this._runtime.direction.front(), resizerFront + 'px');
                    this._splitters[1].css(this._runtime.direction.front(), resizerFront + 'px');
                };
                return TableViewResizeColumnOperation;
            })();

            var TableView = (function () {
                function TableView(runtime) {
                    var _this = this;
                    this._runtime = runtime;
                    this._options = this._runtime.options;
                    this._elements = this._runtime.elements;

                    this.disposer = new Controls.Fundamental.Disposer(function () {
                        _this._isActivate = false;
                        _this._elements = null;
                    });

                    this._isActivate = false;
                    this._properties = new Support.PropertyBag();
                    this._visibleColumnMap = [];
                    this._renderRange = new Range(2 /* Range */, NaN, NaN, NaN, NaN);

                    this.disposer.addDisposable(this._dynamicStylesheetUpdater = new Support.DynamicStylesheetUpdater(this._runtime.id + '_table_root'));
                    this.disposer.addDisposable(this._rowTopStylesheetUpdater = new Support.DynamicStylesheetUpdater(this._runtime.id + '_table_render_row'));
                    this.disposer.addDisposable(this._selectionStylesheet = new Support.DynamicStylesheet(this._runtime.id + '_table_selection'));
                    this.disposer.addDisposable(this._updaters = new Support.UpdaterGroup());
                    this.disposer.addDisposable(this._renderingScheduler = new Support.RenderingScheduler());

                    this._renderContext = {
                        renderedRows: [],
                        renderedHeaderCells: []
                    };

                    this._renderingScheduler.addWorker(function (context) {
                        return _this._renderHeaderCellWorker(context);
                    }, this._renderContext, 800);
                    this._renderingScheduler.addWorker(function (context) {
                        return _this._renderCellWorker(context);
                    }, this._renderContext, 1000);
                    this._renderingScheduler.addWorker(function (context) {
                        return _this._removeCellWorker(context);
                    }, this._renderContext, 2000);
                    this._renderingScheduler.start(false);

                    this._dynamicStylesheetUpdater.add(function () {
                        return _this._getLayoutStylesheet();
                    });
                    this._dynamicStylesheetUpdater.add(function () {
                        return _this._getHoverStylesheet();
                    });
                    this._rowTopStylesheetUpdater.add(function () {
                        return _this._getRowTopStylesheet();
                    });

                    this._updaters.add(this._layoutUpdater = this._getLayoutUpdater());
                    this._updaters.add(this._renderRangeUpdater = this._getRenderRangeUpdater());
                    this._updaters.add(this._cursorUpdater = this._getCursorUpdater());
                    this._updaters.add(this._selectionUpdater = this._getSelectionUpdater());
                    this._updaters.add(this._rowTopStylesheetUpdater.getUpdater());
                    this._updaters.add(this._dynamicStylesheetUpdater.getUpdater());

                    this._attachEvents();
                }
                TableView.prototype.dispose = function () {
                    this.disposer.dispose();
                };

                TableView.prototype.name = function () {
                    return 'table';
                };

                TableView.prototype.type = function () {
                    return 0 /* Table */;
                };

                TableView.prototype.activate = function () {
                    if (this.disposer.isDisposed) {
                        return;
                    }

                    this._isActivate = true;
                    this._elements.canvas.eq(TableView.MainCanvasIndex).addClass('msoc-list-canvas-primary');
                    this._elements.headerCanvas.eq(TableView.MainCanvasIndex).addClass('msoc-list-canvas-primary');
                    this._renderContext.renderedRows = [];
                    this._renderContext.renderedHeaderCells = [];
                    this._renderingScheduler.resume();
                    this._renderRangeUpdater.update();
                    this._runtime.selection.columnCount(this._visibleColumnMap.length);
                };

                TableView.prototype.deactivate = function () {
                    if (this.disposer.isDisposed) {
                        return;
                    }

                    this._elements.viewport.attr('style', '');
                    this._elements.canvas.attr('style', '');
                    this._elements.canvasContainer.attr('style', '');
                    this._elements.headerViewport.attr('style', '');
                    this._elements.headerCanvas.attr('style', '');
                    this._elements.headerCanvasContainer.attr('style', '');
                    this._elements.headerCanvas.eq(TableView.MainCanvasIndex).html('');
                    this._elements.canvas.eq(TableView.MainCanvasIndex).html('');
                    this._elements.canvas.eq(TableView.CursorCanvasIndex).html('');
                    this._elements.canvas.eq(TableView.MainCanvasIndex).removeClass('msoc-list-canvas-primary');
                    this._elements.headerCanvas.eq(TableView.MainCanvasIndex).removeClass('msoc-list-canvas-primary');
                    this._updaters.reset();
                    this._renderingScheduler.suspend(false);
                    this._isActivate = false;
                };

                TableView.prototype.updateUI = function () {
                    if (!this._isFunctional()) {
                        return false;
                    }

                    return this._updaters.update();
                };

                TableView.prototype.controller = function () {
                    var _this = this;
                    return {
                        columns: function () {
                            return _this._columns.apply(_this, arguments);
                        },
                        edit: function () {
                            return _this._edit.apply(_this, arguments);
                        },
                        hideColumnByIndex: function () {
                            return _this._hideColumnByIndex.apply(_this, arguments);
                        },
                        showColumnByIndex: function () {
                            return _this._showColumnByIndex.apply(_this, arguments);
                        },
                        getColumnIdByIndex: function () {
                            return _this.getColumnIdByIndex.apply(_this, arguments);
                        },
                        getColumnIndexById: function () {
                            return _this.getColumnIndexById.apply(_this, arguments);
                        }
                    };
                };

                TableView.prototype.visibleColumnMap = function () {
                    return this._visibleColumnMap;
                };

                TableView.prototype.getHeaderCellElement = function (columnUniqueId) {
                    var renderedHeaderCell = this._renderContext.renderedHeaderCells[columnUniqueId];

                    if (!renderedHeaderCell) {
                        return;
                    }

                    if (!renderedHeaderCell.cellElement) {
                        renderedHeaderCell.cellElement = $(renderedHeaderCell.headerCellContentElement).parent();
                    }

                    return renderedHeaderCell.cellElement;
                };

                TableView.prototype.getHeaderCellRect = function (columnUniqueId) {
                    var headerRowHeight = this.getHeaderRowHeight(), column = this._options.columns[columnUniqueId];

                    return {
                        top: 0,
                        height: headerRowHeight,
                        front: column.table.front,
                        width: this.getColumnWidth(columnUniqueId)
                    };
                };

                TableView.prototype.getHeaderRowHeight = function () {
                    return this._options.theme.value('table.headerRowHeight');
                };

                TableView.prototype.getColumnWidth = function (columnUniqueId) {
                    var column = this._options.columns[columnUniqueId];

                    return isNaN(column.table.width) ? this._options.theme.value('table.cellWidth') : column.table.width;
                };

                TableView.prototype.getRowHeight = function () {
                    return this._options.theme.value('table.rowHeight');
                };

                TableView.prototype.getCellRect = function (rowIndex, columnIndex) {
                    var rowHeight = this.getRowHeight(), cellHBorder = this._options.theme.value('table.cellHBorder');

                    if (rowIndex &lt; 0 || isNaN(rowIndex) || rowIndex >= this._options.rowCount || columnIndex &lt; 0 || isNaN(columnIndex) || columnIndex > this._visibleColumnMap.length - 1) {
                        return {
                            top: NaN,
                            height: NaN,
                            front: NaN,
                            width: NaN
                        };
                    }

                    var columnUniqueId = this._visibleColumnMap[columnIndex], column = this._options.columns[columnUniqueId];

                    return {
                        top: rowIndex * rowHeight + rowIndex * cellHBorder.width,
                        height: rowHeight,
                        front: column.table.front,
                        width: this.getColumnWidth(columnUniqueId)
                    };
                };

                TableView.prototype.invalidate = function () {
                    this._invalidateRange(this._renderRange);
                };

                TableView.prototype.invalidateRange = function (range) {
                    this._invalidateRange(range);
                };

                TableView.prototype.invalidateHeaderRange = function (range) {
                    if (!range) {
                        range = new Range(2 /* Range */, 0, 0, 0, this._visibleColumnMap.length - 1);
                    }

                    if (!range.isValid()) {
                        return;
                    }

                    for (var columnIndex = range.front(); columnIndex &lt;= range.end(); columnIndex++) {
                        var columnUniqueId = this._visibleColumnMap[columnIndex];

                        this._invalidateHeaderCell(columnUniqueId);
                    }
                };

                TableView.prototype.getColumnIndexById = function (columnUniqueId) {
                    var index = this._visibleColumnMap.indexOf(columnUniqueId);

                    return index &lt; 0 ? NaN : index;
                };

                TableView.prototype.getColumnIdByIndex = function (columnIndex) {
                    var columnUniqueId = this._visibleColumnMap[columnIndex];

                    return columnUniqueId;
                };

                TableView.prototype._attachEvent = function (site, name, callback, checkFuntional) {
                    var _this = this;
                    if (typeof checkFuntional === "undefined") { checkFuntional = true; }
                    var actualCallback = callback;

                    if (checkFuntional) {
                        actualCallback = function () {
                            if (!_this._isFunctional()) {
                                return;
                            }

                            return callback.apply(null, arguments);
                        };
                    }

                    this.disposer.addDisposable(new Support.EventAttacher(site, name, actualCallback));
                };

                TableView.prototype._attachEvents = function () {
                    var _this = this;
                    this._attachEvent(this._runtime.events, 'addColumns', function (sender, args) {
                        var columns = args.columns, lastColumn = _this._visibleColumnMap.length > 0 ? _this._options.columns[_this._visibleColumnMap[_this._visibleColumnMap.length - 1]] : null;

                        for (var columnIndex = 0; columnIndex &lt; columns.length; columnIndex++) {
                            var column = columns[columnIndex];
                            _this._visibleColumnMap.push(column.columnUniqueId);

                            column.table = {};

                            if (column.raw.table) {
                                if (isNaN(column.raw.table.width)) {
                                    column.table.height = NaN;
                                } else if (column.raw.table.width &lt;= 0) {
                                    throw Support.createError(0, 'TableView', 'invalid width: ' + column.raw.table.width);
                                } else {
                                    column.table.width = column.raw.table.width;
                                }
                            }

                            if (lastColumn) {
                                column.table.front = lastColumn.table.front + _this.getColumnWidth(column.columnUniqueId) + _this._options.theme.value('table.cellVBorder').width;
                            } else {
                                column.table.front = 0;
                            }

                            lastColumn = column;
                        }

                        _this._updateColumnPosition();
                        _this._renderRangeUpdater.update();

                        if (_this._isFunctional()) {
                            _this._runtime.selection.columnCount(_this._visibleColumnMap.length);
                        }
                    }, false);

                    this._attachEvent(this._runtime.events, 'selectionChange', function () {
                        return _this._selectionUpdater.update();
                    });
                    this._attachEvent(this._runtime.events, 'selectionModeChange', function () {
                        return _this._selectionUpdater.update();
                    });
                    this._attachEvent(this._runtime.events, 'viewportScroll', function (sender, args) {
                        return _this._syncHeaderHScroll(sender, args);
                    });
                    this._attachEvent(this._runtime.events, 'propertyChange', function (sender, args) {
                        return _this._propertyChange(sender, args);
                    });
                    this._attachEvent(this._runtime.events, 'updateRows', function (sender, args) {
                        return _this._onUpdateRows(sender, args);
                    });
                    this._attachEvent(this._runtime.events, 'removeRows', function (sender, args) {
                        return _this._onRemoveInsertRows.apply(_this, arguments);
                    });
                    this._attachEvent(this._runtime.events, 'insertRows', function (sender, args) {
                        return _this._onRemoveInsertRows.apply(_this, arguments);
                    });
                    this._attachEvent(this._runtime.events, 'updateHeaderCell', function (sender, args) {
                        return _this._invalidateHeaderCell(args.columnUniqueId);
                    });
                    this._attachEvent(this._runtime.events, 'cursorChange', function (sender, args) {
                        return _this._onCursorChange(args.newValue);
                    });
                    this._attachEvent(this._elements.viewport, 'mousedown', function (event) {
                        return _this._viewportMouseDown(event);
                    });
                    this._attachEvent(this._elements.viewport, 'click', function (event) {
                        return _this._viewportClick(event);
                    });
                    this._attachEvent(this._elements.viewport, 'dblclick', function (event) {
                        return _this._viewportDblClick(event);
                    });
                    this._attachEvent(this._elements.headerViewport, 'click', function (event) {
                        return _this._headerViewportClick(event);
                    });
                    this._attachEvent(this._elements.headerViewport, 'contextmenu', function (event) {
                        return _this._headerViewportContextMenu(event);
                    });
                    this._attachEvent(this._elements.headerViewport, 'mousedown', function (event) {
                        return _this._headerPointerDown(event);
                    });
                    this._attachEvent(this._elements.headerViewport, 'touchstart', function (event) {
                        return _this._headerPointerDown(event);
                    });
                    this._attachEvent(this._elements.root, 'keydown', function (event) {
                        return _this._rootKeyDown(event);
                    });
                };

                TableView.prototype._columns = function (columns) {
                    if (arguments.length > 0) {
                        this._visibleColumnMap = [];

                        for (var columnIndex = 0; columnIndex &lt; columns.length; columnIndex++) {
                            var columnUniqueId = columns[columnIndex].columnId, width = columns[columnIndex].width, column = this._options.columns[columnUniqueId];

                            if (!column) {
                                throw Support.createError(0, 'TableView', 'invalid column id: ' + columnUniqueId);
                            }

                            if (typeof (width) != 'undefined') {
                                width = parseFloat(width);

                                if (isNaN(width)) {
                                    column.table.width = NaN;
                                } else if (width &lt;= 0) {
                                    throw Support.createError(0, 'TableView', 'invalid width: ' + columns[columnIndex].width);
                                } else {
                                    column.table.width = width;
                                }
                            }

                            this._visibleColumnMap.push(columnUniqueId);
                        }

                        this._updateColumnPosition();

                        if (this._isFunctional()) {
                            this._runtime.selection.columnCount(this._visibleColumnMap.length);
                        }
                    } else {
                        var columns = [];
                        for (var columnIndex = 0; columnIndex &lt; this._visibleColumnMap.length; columnIndex++) {
                            var columnUniqueId = this._visibleColumnMap[columnIndex], column = this._options.columns[columnUniqueId];

                            columns.push({
                                columnId: columnUniqueId,
                                columnIndex: columnIndex,
                                width: column.table.width
                            });
                        }

                        return columns;
                    }
                };

                TableView.prototype._edit = function (rowIndex, columnIndex) {
                    this._startEditing('table.edit', rowIndex, columnIndex);
                };

                TableView.prototype._hideColumnByIndex = function (columnIndex) {
                    if (columnIndex &lt; 0 || columnIndex >= this._visibleColumnMap.length) {
                        throw Support.createError(0, 'TableView', 'Invalidate columnIndex:' + columnIndex + ', validate range is [0, ' + this._visibleColumnMap.length + ']');
                    }

                    this._visibleColumnMap.splice(columnIndex, 1);
                    this._runtime.selection.remove(new Range(1 /* Column */, NaN, NaN, columnIndex, columnIndex));
                    this._updateColumnPosition();
                    this._invalidateHeader();
                    this._runtime.updateUI(1);
                };

                TableView.prototype._showColumnByIndex = function (columnIndex, columnUniqueId) {
                    if (columnIndex &lt; 0 || columnIndex > this._visibleColumnMap.length) {
                        throw Support.createError(0, 'TableView', 'Invalidate columnIndex:' + columnIndex + ', validate range is [0, ' + this._visibleColumnMap.length + ']');
                    }

                    var column = this._options.columns[columnUniqueId];

                    if (!column) {
                        throw Support.createError(0, 'TableView', 'Column with id ' + columnUniqueId + ' does not exist');
                    }

                    this._visibleColumnMap.splice(columnIndex, 0, columnUniqueId);
                    this._runtime.selection.insert(new Range(1 /* Column */, NaN, NaN, columnIndex, columnIndex));
                    this._updateColumnPosition();
                    this._invalidateHeader();
                    this._runtime.updateUI(1);
                };

                TableView.prototype._onRemoveInsertRows = function (sender, args) {
                    this._renderRangeUpdater.update();
                    this._rowTopStylesheetUpdater.getUpdater().update();
                    this._layoutUpdater.update();

                    if (args.range.top() &lt;= this._renderRange.bottom()) {
                        this._adjustOddEvenRow();
                    }
                };

                TableView.prototype._onUpdateRows = function (sender, args) {
                    this._rowTopStylesheetUpdater.getUpdater().update();
                    this._invalidateRows(args.range);
                };

                TableView.prototype._onCursorChange = function (cursor) {
                    this._cursorUpdater.update();

                    if (!cursor.isValid()) {
                        return;
                    }

                    var rowIndex = cursor.rowIndex, columnIndex = cursor.columnIndex;

                    var columnUniqueId = this._visibleColumnMap[columnIndex], column = this._options.columns[columnUniqueId], render = column.cellRender, row = this._options.rows[rowIndex];

                    if (typeof (row) == 'undefined') {
                        return;
                    }

                    this._runtime.readerText(render.title({
                        view: this.type(),
                        rowData: row,
                        cellData: row[column.raw.field]
                    }));
                };

                TableView.prototype._isFunctional = function () {
                    return !this.disposer.isDisposed &amp;&amp; this._isActivate;
                };

                TableView.prototype._rootKeyDown = function (event) {
                    var shiftKey = event.shiftKey, currentCursor = this._runtime.selection.cursor(), newCursor, args;

                    if (!shiftKey) {
                        switch (event.which) {
                            case 38:
                                // up
                                newCursor = this._runtime.selection.moveCursor(2 /* Up */);
                                break;

                            case 40:
                                // down
                                newCursor = this._runtime.selection.moveCursor(3 /* Down */);
                                break;

                            case 37:
                                // left
                                newCursor = this._runtime.selection.moveCursor(1 /* Backward */);
                                break;

                            case 39:
                                // right
                                newCursor = this._runtime.selection.moveCursor(0 /* Forward */);
                                break;
                        }

                        if (newCursor) {
                            args = { oldCursorPosition: currentCursor, newCursorPosition: newCursor, cancel: false };
                            this._runtime.events.emit('table.beforeCursorChange', this, args);

                            if (!args.cancel) {
                                var cellPosition = this.getCellRect(args.newCursorPosition.rowIndex, args.newCursorPosition.columnIndex);
                                this._runtime.selection.cursor(args.newCursorPosition);
                                this._runtime.scrollIntoView(cellPosition.top, cellPosition.front, cellPosition.height, cellPosition.width);
                            }
                        }
                    }

                    this._startKeySelect('table.keySelect', event);
                };

                TableView.prototype._getHeaderCellFromEvent = function (event) {
                    var headerCellElement = $(event.target).closest('.msoc-list-table-header-cell');
                    var columnUniqueId = headerCellElement.attr('data-columnUniqueId');

                    if (!columnUniqueId) {
                        return null;
                    } else {
                        return { headerCellElement: headerCellElement, columnUniqueId: columnUniqueId, columnIndex: this._visibleColumnMap.indexOf(columnUniqueId) };
                    }
                };

                TableView.prototype._headerViewportClick = function (event) {
                    var headerCell = this._getHeaderCellFromEvent(event);

                    if (!headerCell) {
                        return;
                    }

                    var columnUniqueId = headerCell.columnUniqueId, column = this._options.columns[columnUniqueId];

                    this._runtime.events.emit('table.headerRowClick', this, {
                        columnId: headerCell.columnUniqueId,
                        columnIndex: headerCell.columnIndex,
                        column: column.raw,
                        event: event
                    });
                };

                TableView.prototype._headerViewportContextMenu = function (event) {
                    var headerCell = this._getHeaderCellFromEvent(event);

                    if (!headerCell) {
                        return;
                    }

                    var columnUniqueId = headerCell.columnUniqueId, column = this._options.columns[columnUniqueId];

                    this._runtime.events.emit('table.headerRowContextMenu', this, {
                        columnUniqueId: columnUniqueId,
                        column: column.raw,
                        event: event
                    });
                };

                TableView.prototype._getCellFromEvent = function (event) {
                    var cellElement = $(event.target).closest('.msoc-list-table-cell'), rowUniqueId = cellElement.attr('data-rowUniqueId'), columnUniqueId = cellElement.attr('data-columnUniqueId');

                    if (!columnUniqueId || !rowUniqueId) {
                        return null;
                    } else {
                        var rowIndex = this._runtime.getRowByUniqueId(rowUniqueId).rowIndex, columnIndex = this._visibleColumnMap.indexOf(columnUniqueId);

                        return { cellElement: cellElement, rowIndex: rowIndex, rowUniqueId: rowUniqueId, columnUniqueId: columnUniqueId, columnIndex: columnIndex };
                    }
                };

                TableView.prototype._viewportClick = function (event) {
                    var cell = this._getCellFromEvent(event);

                    if (!cell) {
                        return;
                    }

                    var columnUniqueId = cell.columnUniqueId, column = this._options.columns[columnUniqueId], beforeCursorChangeArgs = {
                        oldCursorPosition: this._runtime.selection.cursor(),
                        newCursorPosition: new Position(cell.rowIndex, cell.columnIndex),
                        cancel: false
                    };

                    this._runtime.events.emit('table.beforeCursorChange', this, beforeCursorChangeArgs);

                    if (!beforeCursorChangeArgs.cancel) {
                        this._runtime.selection.cursor(beforeCursorChangeArgs.newCursorPosition);
                    }

                    this._runtime.events.emit('table.rowClick', this, {
                        rowIndex: cell.rowIndex,
                        columnUniqueId: columnUniqueId,
                        columnIndex: cell.columnIndex,
                        column: column.raw,
                        event: event
                    });
                };

                TableView.prototype._viewportDblClick = function (event) {
                    // Left button
                    if (event.which == 1) {
                        var cell = this._getCellFromEvent(event);

                        if (!cell) {
                            return;
                        }

                        this._startEditing('table.edit', cell.rowIndex, cell.columnIndex);
                    }
                };

                TableView.prototype._viewportMouseDown = function (event) {
                    if (!this._isFunctional()) {
                        return;
                    }

                    // Left button
                    if (event.which == 1) {
                        this._startMouseSelect('table.mouseSelect', event);
                    }
                };

                // FIXME: [medium][5 days] Select by touch
                // FIXME: [high][3 days] Select by keyboard
                TableView.prototype._startKeySelect = function (name, event) {
                    var _this = this;
                    return this._runtime.operator.start(name, new TableViewKeySelectOperation(), this, this._runtime, event).done(function (result) {
                        var args = {
                            range: result.range,
                            reason: 'keyboard',
                            cancel: false
                        };

                        _this._runtime.events.emit(result.action == 'select' ? 'table.beforeSelect' : 'table.beforeDeselect', _this, args);

                        if (!args.cancel) {
                            if (result.action == 'select') {
                                _this._runtime.selection.select(args.range, true);
                            } else {
                                _this._runtime.selection.deselect(args.range);
                            }

                            _this._selectionUpdater.update();
                        }
                    });
                };

                TableView.prototype._startMouseSelect = function (name, event) {
                    var _this = this;
                    return this._runtime.operator.start(name, new TableViewMouseSelectOperation(), this, this._runtime, event, this._selectionUpdater).done(function (result) {
                        var args = {
                            range: result.range,
                            reason: 'mouse',
                            cancel: false
                        };

                        _this._runtime.events.emit(result.action == 'select' ? 'table.beforeSelect' : 'table.beforeDeselect', _this, args);

                        if (!args.cancel) {
                            if (result.action == 'select') {
                                _this._runtime.selection.select(args.range, false);
                            } else {
                                _this._runtime.selection.deselect(args.range);
                            }

                            _this._selectionUpdater.update();
                        }
                    });
                };

                TableView.prototype._headerPointerDown = function (event) {
                    if (!this._isFunctional()) {
                        return;
                    }

                    if (!Support.BrowserDetector.isTouchEvent(event.type) &amp;&amp; event.which != 1) {
                        // Not mouse left button down or touch down
                        return;
                    }

                    var headerCellElement = $(event.target).closest('.msoc-list-table-header-cell');
                    var headerCellSplitterElement = $(event.target).closest('.msoc-list-table-header-cell-splitter');

                    if (headerCellElement.length > 0) {
                        if (headerCellSplitterElement.length > 0) {
                            var columnUniqueId = headerCellElement.attr('data-columnUniqueId');

                            if (headerCellSplitterElement.hasClass('msoc-list-table-header-cell-splitter-front')) {
                                var columnIndex = this._visibleColumnMap.indexOf(columnUniqueId);

                                columnUniqueId = this._visibleColumnMap[columnIndex - 1];
                            }
                            this._startResizeColumn('table.resizeColumn', columnUniqueId, event);
                        } else {
                            this._startReorderColumn('table.reorderColumn', headerCellElement, event);
                        }
                    }
                };

                TableView.prototype._startEditing = function (name, rowIndex, columnIndex) {
                    var _this = this;
                    return this._runtime.operator.start(name, new TableViewEditOperation(), this, this._runtime, rowIndex, columnIndex).done(function (newValue) {
                        var row = _this._options.rows[rowIndex], columnUniqueId = _this._visibleColumnMap[columnIndex], column = _this._options.columns[columnUniqueId], rowUniqueId = _this._runtime.getRowByIndex(rowIndex).rowUniqueId;

                        row[column.raw.field] = newValue;

                        _this._invalidateCell(rowUniqueId, columnUniqueId);
                    });
                };

                TableView.prototype._startResizeColumn = function (name, columnUniqueId, event) {
                    var _this = this;
                    var isTouch = Support.BrowserDetector.isTouchEvent(event.type);
                    var pointerId = Support.BrowserDetector.getChangedPointerIdentifier(event);
                    var pointers = Support.CoordinateFactory.fromEvent(this._runtime.direction.rtl(), event);
                    var column = this._options.columns[columnUniqueId];

                    return this._runtime.operator.start(name, new TableViewResizeColumnOperation(), this, this._runtime, columnUniqueId, isTouch, pointerId, pointers, column.table.front, this.getColumnWidth(columnUniqueId), this._selectionStylesheet).done(function (columnUniqueId, width) {
                        column.table.width = width;
                        _this._updateColumnPosition();
                        _this._invalidateColumn(columnUniqueId);
                        _this._runtime.updateUI(1);
                    });
                };

                TableView.prototype._startReorderColumn = function (name, headerCellElement, event) {
                    var _this = this;
                    var isTouch = Support.BrowserDetector.isTouchEvent(event.type);
                    var pointerId = Support.BrowserDetector.getChangedPointerIdentifier(event)[0];
                    var coordinate = Support.CoordinateFactory.fromEvent(this._runtime.direction.rtl(), event)[pointerId];

                    return this._runtime.operator.start(name, new TableViewReorderColumnOperation(), this, this._runtime, headerCellElement, isTouch, pointerId, coordinate, this._selectionStylesheet).done(function (oldColumnIndex, newColumnIndex) {
                        if (oldColumnIndex == 0 || newColumnIndex == 0) {
                            var headerCellElement = _this.getHeaderCellElement(_this._visibleColumnMap[0]);

                            if (headerCellElement) {
                                headerCellElement.removeClass('msoc-list-table-header-cell-first');
                            }
                        }

                        var columnUniqueId = _this._visibleColumnMap.splice(oldColumnIndex, 1)[0];

                        _this._visibleColumnMap.splice(newColumnIndex - (oldColumnIndex &lt; newColumnIndex ? 1 : 0), 0, columnUniqueId);

                        if (oldColumnIndex == 0 || newColumnIndex == 0) {
                            var headerCellElement = _this.getHeaderCellElement(_this._visibleColumnMap[0]);

                            if (headerCellElement) {
                                headerCellElement.addClass('msoc-list-table-header-cell-first');
                            }
                        }

                        _this._updateColumnPosition();
                        _this._runtime.updateUI(1);
                    });
                };

                TableView.prototype._getRenderRange = function () {
                    var topRow, bottomRow, frontColumn, endColumn;
                    var viewportScrollCoordinateFront = this._runtime.viewportScrollCoordinate.front();

                    topRow = Math.floor(this._runtime.viewportScrollCoordinate.top() / (this.getRowHeight() + this._options.theme.value('table.cellHBorder').width));
                    topRow = Math.max(0, topRow);
                    bottomRow = Math.floor((this._runtime.viewportScrollCoordinate.top() + this._runtime.viewportHeight) / (this.getRowHeight() + this._options.theme.value('table.cellHBorder').width));
                    bottomRow = Math.min(this._options.rowCount - 1, bottomRow);
                    frontColumn = 0;
                    endColumn = this._visibleColumnMap.length - 1;

                    for (var columnIndex = 0; columnIndex &lt; this._visibleColumnMap.length; columnIndex++) {
                        var column = this._options.columns[this._visibleColumnMap[columnIndex]], front = column.table.front;

                        if (front &lt;= viewportScrollCoordinateFront) {
                            frontColumn = columnIndex;
                        }

                        if (front &lt; viewportScrollCoordinateFront + this._runtime.viewportClientWidth) {
                            endColumn = columnIndex;
                        } else {
                            break;
                        }
                    }

                    return new Range(2 /* Range */, topRow, bottomRow, frontColumn, endColumn);
                };

                TableView.prototype._updateColumnPosition = function () {
                    var cellVBorderWidth = this._options.theme.value('table.cellVBorder').width, accumulateFront = 0;

                    for (var i = 0; i &lt; this._visibleColumnMap.length; i++) {
                        var columnUniqueId = this._visibleColumnMap[i], column = this._options.columns[columnUniqueId];

                        column.table.front = accumulateFront;
                        accumulateFront += this.getColumnWidth(columnUniqueId) + cellVBorderWidth;
                    }

                    this._renderRangeUpdater.update();
                };

                TableView.prototype._getFullRange = function () {
                    if (this._options.rowCount &lt;= 0 || this._visibleColumnMap.length &lt;= 0) {
                        return new Range(2 /* Range */, NaN, NaN, NaN, NaN);
                    }

                    return new Range(2 /* Range */, 0, this._options.rowCount - 1, 0, this._visibleColumnMap.length - 1);
                };

                TableView.prototype._getRenderRangeUpdater = function () {
                    var _this = this;
                    var eventSender = new Support.AccumulateTimeoutInvoker(function () {
                        if (_this._renderRange.isValid()) {
                            _this._runtime.events.emit('table.beforeRender', _this, {
                                renderRange: _this._renderRange
                            });
                        }
                    }, 16.67);

                    return new Support.Updater(function () {
                        var renderRange = _this._getRenderRange();
                        var rowUniqueIds = [];

                        if (renderRange.isValid()) {
                            for (var rowIndex = renderRange.top(); rowIndex &lt;= renderRange.bottom(); rowIndex++) {
                                var row = _this._runtime.getRowByIndex(rowIndex);

                                if (row) {
                                    rowUniqueIds.push(row.rowUniqueId);
                                }
                            }

                            rowUniqueIds.sort();
                        }

                        return {
                            renderRange: renderRange,
                            rowUniqueIds: rowUniqueIds
                        };
                    }, function (newValue) {
                        var renderRange = newValue.renderRange;

                        _this._renderRange = renderRange;

                        eventSender.invoke();
                    });
                };

                TableView.prototype._syncHeaderHScroll = function (sender, args) {
                    this._elements.headerViewport.scrollLeft(this._runtime.viewportScrollLeft);
                    this._renderRangeUpdater.update();
                };

                TableView.prototype._propertyChange = function (sender, args) {
                    switch (args.name) {
                        case 'width':
                        case 'height':
                        case 'rowCount':
                            this._renderRangeUpdater.update();
                            break;

                        case 'theme':
                            this._invalidateHeader();
                            this._invalidateRange(this._renderRange);
                            this._updateColumnPosition();
                            break;

                        case 'rtl':
                            this._invalidateHeader();
                            this._invalidateRange(this._renderRange);
                            break;
                    }
                };

                TableView.prototype._getSelectionUpdater = function () {
                    var _this = this;
                    return new Support.Updater(function () {
                        var rowUniqueIdMap = {}, rowUniqueIds = [], columnUniqueIdMap = {}, columnUniqueIds = [], ranges = _this._runtime.selection.ranges();

                        for (var rangeIndex = 0; rangeIndex &lt; ranges.length; rangeIndex++) {
                            var range = ranges[rangeIndex];

                            if (range.type() == 0 /* Row */ || range.type() == 2 /* Range */) {
                                for (var rowIndex = range.top(); rowIndex &lt;= range.bottom(); rowIndex++) {
                                    var row = _this._runtime.getRowByIndex(rowIndex);

                                    if (row) {
                                        rowUniqueIdMap[row.rowUniqueId] = 1;
                                    }
                                }
                            }

                            if (range.type() == 1 /* Column */ || range.type() == 2 /* Range */) {
                                for (var columnIndex = range.front(); columnIndex &lt;= range.end(); columnIndex++) {
                                    columnUniqueIdMap[_this._visibleColumnMap[columnIndex]] = 1;
                                }
                            }
                        }

                        for (var rowUniqueId in rowUniqueIdMap) {
                            rowUniqueIds.push(rowUniqueId);
                        }

                        rowUniqueIds.sort();

                        for (var columnUniqueId in columnUniqueIdMap) {
                            columnUniqueIds.push(columnUniqueId);
                        }

                        columnUniqueIds.sort();

                        return {
                            ranges: _this._runtime.selection.ranges(),
                            rowUniqueIds: rowUniqueIds,
                            columnUniqueIds: columnUniqueIds,
                            rtl: _this._runtime.direction.rtl(),
                            color: _this._options.theme.value('selectionBackgroundColor')
                        };
                    }, function (newValue) {
                        var selectedRanges = newValue.ranges;
                        var cssText = new Support.CssTextBuilder();
                        var color = newValue.color;

                        for (var i = 0; i &lt; selectedRanges.length; i++) {
                            var range = selectedRanges[i];

                            switch (range.type()) {
                                case 0 /* Row */:
                                    for (var rowIndex = range.top(); rowIndex &lt;= range.bottom(); rowIndex++) {
                                        var row = _this._runtime.getRowByIndex(rowIndex);

                                        if (!row) {
                                            continue;
                                        }

                                        _this._runtime.buildCssRootSelector(cssText);
                                        cssText.push('.msoc-list-row.msoc-list-table-row-');
                                        cssText.push(row.rowUniqueId);
                                        cssText.push(',');
                                        _this._runtime.buildCssRootSelector(cssText);
                                        cssText.push('.msoc-list-row.msoc-list-table-row-');
                                        cssText.push(row.rowUniqueId);
                                        cssText.push('>.msoc-list-table-cell,');
                                        _this._runtime.buildCssRootSelector(cssText);
                                        cssText.push('.msoc-list-row.msoc-list-table-row-');
                                        cssText.push(row.rowUniqueId);
                                        cssText.push(':hover>.msoc-list-table-cell');
                                        cssText.property('background-color', color);
                                    }

                                    break;

                                case 1 /* Column */:
                                    for (var columnIndex = range.front(); columnIndex &lt;= range.front(); columnIndex++) {
                                        var columnUniqueId = _this._visibleColumnMap[columnIndex];

                                        _this._runtime.buildCssRootSelector(cssText);
                                        cssText.push('.msoc-list-header-canvas>.msoc-list-table-header-cell-');
                                        cssText.push(columnUniqueId);
                                        cssText.push(',');
                                        _this._runtime.buildCssRootSelector(cssText);
                                        cssText.push('.msoc-list-row>.msoc-list-table-cell-');
                                        cssText.push(columnUniqueId);
                                        cssText.push(',');
                                        _this._runtime.buildCssRootSelector(cssText);
                                        cssText.push('.msoc-list-row>.msoc-list-table-cell-');
                                        cssText.push(columnUniqueId);
                                        cssText.push(':hover');
                                        cssText.property('background-color', color);
                                    }

                                    break;

                                case 2 /* Range */:
                                    for (var rowIndex = range.top(); rowIndex &lt;= range.bottom(); rowIndex++) {
                                        for (var columnIndex = range.front(); columnIndex &lt;= range.end(); columnIndex++) {
                                            var columnUniqueId = _this._visibleColumnMap[columnIndex];
                                            var row = _this._runtime.getRowByIndex(rowIndex);

                                            if (!row) {
                                                continue;
                                            }

                                            _this._runtime.buildCssRootSelector(cssText);
                                            cssText.push('.msoc-list-row.msoc-list-table-row-');
                                            cssText.push(row.rowUniqueId);
                                            cssText.push('>.msoc-list-table-cell-');
                                            cssText.push(columnUniqueId);
                                            cssText.push(',');
                                            _this._runtime.buildCssRootSelector(cssText);
                                            cssText.push('.msoc-list-row.msoc-list-table-row-');
                                            cssText.push(row.rowUniqueId);
                                            cssText.push(':hover>.msoc-list-table-cell-');
                                            cssText.push(columnUniqueId);
                                            cssText.property('background-color', color);
                                        }
                                    }
                                    break;
                            }
                        }

                        _this._selectionStylesheet.content(cssText.toString());
                    });
                };

                TableView.prototype._getLayoutUpdater = function () {
                    var _this = this;
                    return new Support.Updater(function () {
                        var lastColumnIndex = _this._visibleColumnMap.length - 1, rowHeight = _this.getRowHeight(), rowCount = _this._options.rowCount, cellHBorder = _this._options.theme.value('table.cellHBorder'), canvasEndMargin = _this._options.theme.value('table.canvasEndMargin'), canvasBottomMargin = _this._options.theme.value('table.canvasBottomMargin'), lastColumn = _this._options.columns[_this._visibleColumnMap[_this._visibleColumnMap.length - 1]];

                        return {
                            headerRowHeight: _this.getHeaderRowHeight(),
                            headerBottomBorderHeight: _this._options.theme.value('table.headerBottomBorder').width,
                            height: _this._options.height,
                            width: _this._options.width,
                            canvasWidth: lastColumnIndex &lt; 0 ? 0 : lastColumn.table.front + _this.getColumnWidth(lastColumn.columnUniqueId) + canvasEndMargin,
                            canvasHeight: rowCount == 0 ? 0 : rowCount * rowHeight + (rowCount - 1) * cellHBorder.width + canvasBottomMargin,
                            rtl: _this._runtime.direction.rtl()
                        };
                    }, function (newValue, oldValue) {
                        var headerRowHeight = newValue.headerRowHeight;
                        var headerBottomBorderHeight = newValue.headerBottomBorderHeight;
                        var width = newValue.width;
                        var height = newValue.height;
                        var canvasHeight = newValue.canvasHeight;
                        var canvasWidth = newValue.canvasWidth;

                        _this._elements.viewport.css('overflow', 'auto');
                        _this._elements.viewport.css('position', 'absolute');
                        _this._elements.viewport.css('top', (headerRowHeight + headerBottomBorderHeight) + 'px');
                        _this._elements.viewport.css('height', (height - headerRowHeight - headerBottomBorderHeight) + 'px');
                        _this._elements.viewport.css(_this._runtime.direction.front(), '0px');
                        _this._elements.viewport.css('width', '100%');
                        _this._elements.canvasContainer.css('height', canvasHeight + 'px');

                        var viewportClientWidth = _this._elements.viewport[0].clientWidth;

                        if (viewportClientWidth > canvasWidth) {
                            _this._elements.canvasContainer.css('width', viewportClientWidth + 'px');
                        } else {
                            _this._elements.canvasContainer.css('width', canvasWidth + 'px');
                        }

                        if (newValue == oldValue &amp;&amp; _this._runtime.canvasHeight) {
                            var newScrollTop = Support.Calculator.calculateScrollTopAfterSwitchView(_this._runtime.canvasHeight, newValue.canvasHeight, _this._runtime.viewportClientHeight, _this._elements.viewport[0].clientHeight, _this._runtime.viewportScrollCoordinate.top());

                            _this._elements.viewport.scrollTop(newScrollTop);
                            _this._runtime.viewportScrollCoordinate.top(_this._elements.viewport.scrollTop());
                        }

                        _this._elements.headerViewport.css('overflow', 'hidden');
                        _this._elements.headerViewport.css('position', 'absolute');
                        _this._elements.headerViewport.css('width', '100%');
                        _this._elements.headerViewport.css('height', (headerRowHeight + headerBottomBorderHeight) + 'px');

                        if (viewportClientWidth > canvasWidth) {
                            _this._elements.headerCanvasContainer.css('width', viewportClientWidth + 'px');
                        } else {
                            _this._elements.headerCanvasContainer.css('width', canvasWidth + 'px');
                        }

                        _this._elements.headerCanvasContainer.css('height', (headerRowHeight + headerBottomBorderHeight) + 'px');
                        _this._elements.headerViewport.css(_this._runtime.direction.front(), 0 + 'px');

                        var headerBottomBorder = _this._elements.headerCanvas.eq(TableView.MainCanvasIndex).find('> .msoc-list-table-header-bottom-border');

                        if (headerBottomBorder.length == 0) {
                            _this._elements.headerCanvas.eq(TableView.MainCanvasIndex).append('&lt;div class="msoc-list-table-header-bottom-border">&lt;/div>');
                        }

                        _this._runtime.updateSize();
                    });
                };

                TableView.prototype._getRowTopStylesheet = function () {
                    var renderRange = this._renderRange, cssText = new Support.CssTextBuilder();

                    for (var rowIndex = renderRange.top(); rowIndex &lt;= renderRange.bottom(); rowIndex++) {
                        var row = this._runtime.getRowByIndex(rowIndex);

                        if (!row) {
                            continue;
                        }

                        var cellRect = this.getCellRect(rowIndex, 0);

                        this._runtime.buildCssRootSelector(cssText);
                        cssText.push('.msoc-list-row.msoc-list-table-row-');
                        cssText.push(row.rowUniqueId);
                        cssText.property('top', cellRect.top, 'px');
                        cssText.property('display', 'block');
                    }

                    return cssText.toString();
                };

                TableView.prototype._getCursorUpdater = function () {
                    var _this = this;
                    return new Support.Updater(function () {
                        var cursor = _this._runtime.selection.cursor();

                        return {
                            cellRect: _this.getCellRect(cursor.rowIndex, cursor.columnIndex),
                            thickness: _this._options.theme.value('table.cursorBorder').width,
                            color: _this._options.theme.value('table.cursorBorder').color,
                            style: _this._options.theme.value('table.cursorBorder').style,
                            cursor: _this._options.theme.value('table.cellCursor'),
                            rtl: _this._runtime.direction.rtl()
                        };
                    }, function (newValue) {
                        var cellRect = newValue.cellRect, thickness = newValue.thickness, color = newValue.color, style = newValue.style, cursor = newValue.cursor, canvas = _this._elements.canvas.eq(TableView.CursorCanvasIndex), elements = canvas.find('.msoc-list-table-cursor');

                        if (elements.length == 0) {
                            elements = $('&lt;div class="msoc-list-table-cursor">&lt;/div>&lt;div class="msoc-list-table-cursor">&lt;/div>&lt;div class="msoc-list-table-cursor">&lt;/div>&lt;div class="msoc-list-table-cursor">&lt;/div>');
                            canvas.append(elements);
                        }

                        if (cellRect == null || isNaN(cellRect.width) || cellRect.width &lt; 2 * thickness || cellRect.height &lt; 2 * thickness) {
                            elements.hide();
                        } else {
                            elements.show();
                            elements.css('cursor', cursor);
                            elements.css('border', '');
                            elements.eq(0).css('top', cellRect.top + 'px');
                            elements.eq(0).css('height', thickness + 'px');
                            elements.eq(0).css(_this._runtime.direction.front(), cellRect.front + 'px');
                            elements.eq(0).css(_this._runtime.direction.end(), '');
                            elements.eq(0).css('width', cellRect.width + 'px');
                            elements.eq(0).css('border-top-width', thickness + 'px');
                            elements.eq(0).css('border-top-color', color);
                            elements.eq(0).css('border-top-style', style);

                            elements.eq(1).css('top', cellRect.top + 'px');
                            elements.eq(1).css('height', cellRect.height + 'px');
                            elements.eq(1).css(_this._runtime.direction.front(), (cellRect.front + cellRect.width - thickness) + 'px');
                            elements.eq(1).css(_this._runtime.direction.end(), '');
                            elements.eq(1).css('width', thickness + 'px');
                            elements.eq(1).css('border-' + _this._runtime.direction.end() + '-width', thickness + 'px');
                            elements.eq(1).css('border-' + _this._runtime.direction.end() + '-color', color);
                            elements.eq(1).css('border-' + _this._runtime.direction.end() + '-style', style);

                            elements.eq(2).css('top', (cellRect.top + cellRect.height - thickness) + 'px');
                            elements.eq(2).css('height', thickness + 'px');
                            elements.eq(2).css(_this._runtime.direction.front(), cellRect.front + 'px');
                            elements.eq(2).css(_this._runtime.direction.end(), '');
                            elements.eq(2).css('width', cellRect.width + 'px');
                            elements.eq(2).css('border-bottom-width', thickness + 'px');
                            elements.eq(2).css('border-bottom-color', color);
                            elements.eq(2).css('border-bottom-style', style);

                            elements.eq(3).css('top', cellRect.top + 'px');
                            elements.eq(3).css('height', cellRect.height + 'px');
                            elements.eq(3).css(_this._runtime.direction.front(), cellRect.front + 'px');
                            elements.eq(3).css(_this._runtime.direction.end(), '');
                            elements.eq(3).css('width', thickness + 'px');
                            elements.eq(3).css('border-' + _this._runtime.direction.front() + '-width', thickness + 'px');
                            elements.eq(3).css('border-' + _this._runtime.direction.front() + '-color', color);
                            elements.eq(3).css('border-' + _this._runtime.direction.front() + '-style', style);
                        }
                    });
                };

                TableView.prototype._getLayoutStylesheet = function () {
                    var cssText = new Support.CssTextBuilder(), cellPadding = this._options.theme.value('table.cellPadding'), headerCellPadding = this._options.theme.value('table.headerCellPadding'), headerCellVBorder = this._options.theme.value('table.headerCellVBorder'), headerBottomBorder = this._options.theme.value('table.headerBottomBorder'), cellVBorder = this._options.theme.value('table.cellVBorder'), cellHBorder = this._options.theme.value('table.cellHBorder'), oddRowBackgroundColor = this._options.theme.value('table.oddRowBackgroundColor'), evenRowBackgroundColor = this._options.theme.value('table.evenRowBackgroundColor'), cellColor = this._options.theme.value('table.cellColor'), headerRowBackgroundColor = this._options.theme.value('table.headerRowBackgroundColor'), headerCellColor = this._options.theme.value('table.headerCellColor'), headerRowHeight = this.getHeaderRowHeight(), rowHeight = this.getRowHeight();

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-table-header-cell');
                    cssText.property('cursor', this._options.theme.value('table.headerCursor'));
                    cssText.property('font-family', this._options.theme.value('table.headerCellFontFamily'));
                    cssText.property('font-size', this._options.theme.value('table.headerCellFontSize'));
                    cssText.property('background-color', headerRowBackgroundColor);
                    cssText.property('color', headerCellColor);
                    cssText.property('height', headerRowHeight, 'px');
                    cssText.property('display', 'none');

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-table-header-cell-content');
                    cssText.property('top', 0, 'px');
                    cssText.property(this._runtime.direction.front(), 0, 'px');
                    cssText.property(this._runtime.direction.end(), 0, 'px');
                    cssText.property('padding', this._runtime.direction.rtl() ? headerCellPadding.raw.rtl : headerCellPadding.raw.ltr);
                    cssText.property('height', headerRowHeight, 'px');
                    cssText.property('line-height', headerRowHeight, 'px');

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-row');
                    cssText.property('height', rowHeight, 'px');
                    cssText.property('line-height', rowHeight, 'px');
                    cssText.property('width', '100', '%');
                    cssText.property('display', 'none');

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.append('.msoc-list-table-row-border');
                    cssText.property('height', cellHBorder.width, 'px');
                    cssText.property('width', '100', '%');
                    cssText.property('border-bottom', cellHBorder.raw);
                    cssText.property('top', rowHeight, 'px');

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-table-cell');
                    cssText.property('cursor', this._options.theme.value('table.cellCursor'));
                    cssText.property('font-family', this._options.theme.value('table.cellFontFamily'));
                    cssText.property('font-size', this._options.theme.value('table.cellFontSize'));
                    cssText.property('color', cellColor);
                    cssText.property('height', rowHeight, 'px');

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-row.msoc-list-odd');
                    cssText.property('background-color', oddRowBackgroundColor);

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-row.msoc-list-even');
                    cssText.property('background-color', evenRowBackgroundColor);

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-table-header-bottom-border');
                    cssText.property('height', headerBottomBorder.width, 'px');
                    cssText.property('border-bottom', headerBottomBorder.raw);

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-table-header-cell-splitter-front');
                    cssText.property(this._runtime.direction.front(), 0, 'px');
                    cssText.property('width', 2, 'px');

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-table-header-cell-first > .msoc-list-table-header-cell-splitter-front');
                    cssText.property('display', 'none');

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-table-header-cell-splitter-end');
                    cssText.property(this._runtime.direction.end(), -cellVBorder.width, 'px');
                    cssText.property('width', cellVBorder.width + 2, 'px');

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-table-cell-content');
                    cssText.property('top', 0, 'px');
                    cssText.property(this._runtime.direction.front(), 0, 'px');
                    cssText.property(this._runtime.direction.end(), 0, 'px');
                    cssText.property('padding', this._runtime.direction.rtl() ? cellPadding.raw.rtl : cellPadding.raw.ltr);
                    cssText.property('height', rowHeight, 'px');
                    cssText.property('line-height', rowHeight, 'px');

                    for (var columnIndex = 0; columnIndex &lt; this._visibleColumnMap.length; columnIndex++) {
                        var columnUniqueId = this._visibleColumnMap[columnIndex], column = this._options.columns[columnUniqueId], headerCellRect = this.getHeaderCellRect(columnUniqueId);

                        this._runtime.buildCssRootSelector(cssText);
                        cssText.push('.msoc-list-table-header-cell.msoc-list-table-header-cell-');
                        cssText.push(columnUniqueId);
                        cssText.property(this._runtime.direction.front(), headerCellRect.front, 'px');
                        cssText.property('width', headerCellRect.width, 'px');
                        cssText.property('display', 'block');

                        if (columnIndex != this._visibleColumnMap.length - 1) {
                            this._runtime.buildCssRootSelector(cssText);
                            cssText.push('.msoc-list-table-header-cell-v-border-');
                            cssText.push(columnUniqueId);
                            cssText.property(this._runtime.direction.front(), headerCellRect.width, 'px');
                            cssText.property('width', cellVBorder.width, 'px');
                            cssText.property('border-' + this._runtime.direction.end(), headerCellVBorder.raw);
                        }

                        this._runtime.buildCssRootSelector(cssText);
                        cssText.push('.msoc-list-table-cell-');
                        cssText.push(columnUniqueId);
                        cssText.property(this._runtime.direction.front(), headerCellRect.front, 'px');
                        cssText.property('width', headerCellRect.width, 'px');
                    }
                    ;

                    return cssText.toString();
                };

                TableView.prototype._getHoverStylesheet = function () {
                    var cssText = new Support.CssTextBuilder();

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-row:hover,');
                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-row:hover>.msoc-list-table-cell');
                    cssText.property('background-color', this._options.theme.value('hoverBackgroundColor'));

                    return cssText.toString();
                };

                TableView.prototype._invalidateHeader = function () {
                    for (var i in this._renderContext.renderedHeaderCells) {
                        var renderedHeaderCell = this._renderContext.renderedHeaderCells[i];

                        if (renderedHeaderCell &amp;&amp; renderedHeaderCell.state == 2 /* Painted */) {
                            renderedHeaderCell.state = 1 /* OutDated */;
                        }
                    }
                };

                TableView.prototype._invalidateHeaderCell = function (columnUniqueId) {
                    var renderedHeaderCell = this._renderContext.renderedHeaderCells[columnUniqueId];

                    if (renderedHeaderCell &amp;&amp; renderedHeaderCell.state == 2 /* Painted */) {
                        renderedHeaderCell.state = 1 /* OutDated */;
                    }
                };

                TableView.prototype._invalidateColumn = function (columnUniqueId) {
                    this._invalidateHeaderCell(columnUniqueId);

                    for (var i in this._renderContext.renderedRows) {
                        var renderedRow = this._renderContext.renderedRows[i];

                        if (renderedRow.RenderState == 0 /* Initial */) {
                            continue;
                        }

                        var renderedCell = renderedRow.renderedCells[columnUniqueId];

                        if (renderedCell &amp;&amp; renderedCell.state == 2 /* Painted */) {
                            renderedCell.state = 1 /* OutDated */;
                        }
                    }
                };

                TableView.prototype._invalidateRange = function (range) {
                    if (range) {
                        range = Range.intersection(range, this._renderRange);
                    } else if (this._renderRange.isValid()) {
                        range = this._renderRange;
                    }

                    if (!range || !range.isValid()) {
                        return;
                    }

                    for (var rowIndex = range.top(); rowIndex &lt;= range.bottom(); rowIndex++) {
                        var row = this._runtime.getRowByIndex(rowIndex);

                        if (!row) {
                            return;
                        }

                        for (var columnIndex = range.front(); columnIndex &lt;= range.end(); columnIndex++) {
                            var columnUniqueId = this._visibleColumnMap[columnIndex];

                            this._invalidateCell(row.rowUniqueId, columnUniqueId);
                        }
                    }
                };

                TableView.prototype._invalidateRows = function (range) {
                    var range = Range.intersection(range, this._renderRange);

                    if (!range || !range.isValid()) {
                        return;
                    }

                    for (var rowIndex = range.top(); rowIndex &lt;= range.bottom(); rowIndex++) {
                        var row = this._runtime.getRowByIndex(rowIndex);

                        if (!row) {
                            return;
                        }

                        this._invalidateRow(row.rowUniqueId);
                    }
                };

                TableView.prototype._invalidateRow = function (rowUniqueId) {
                    var renderedRow = this._renderContext.renderedRows[rowUniqueId];

                    if (!renderedRow) {
                        return;
                    }

                    for (var i in renderedRow.renderedCells) {
                        var renderedCell = renderedRow.renderedCells[i];

                        if (renderedCell.state == 2 /* Painted */) {
                            renderedCell.state = 1 /* OutDated */;
                        }
                    }
                };

                TableView.prototype._invalidateCell = function (rowUniqueId, columnUniqueId) {
                    var renderedCell = this._renderContext.renderedRows[rowUniqueId] ? this._renderContext.renderedRows[rowUniqueId].renderedCells[columnUniqueId] : null;

                    if (renderedCell &amp;&amp; renderedCell.state == 2 /* Painted */) {
                        renderedCell.state = 1 /* OutDated */;
                    }
                };

                TableView.prototype._adjustOddEvenRow = function () {
                    for (var rowUniqueId in this._renderContext.renderedRows) {
                        if (this._renderContext.renderedRows[rowUniqueId].state == 2 /* Painted */) {
                            var rowElement = this._renderContext.renderedRows[rowUniqueId].rowElement, row = this._runtime.getRowByUniqueId(rowUniqueId);

                            if (row) {
                                rowElement.removeClass('msoc-list-odd msoc-list-even');

                                if (row.rowIndex % 2 == 1) {
                                    rowElement.addClass('msoc-list-odd');
                                } else {
                                    rowElement.addClass('msoc-list-even');
                                }
                            }
                        }
                    }
                };

                TableView.prototype._renderHeaderCellWorker = function (context) {
                    var html = new Support.StringBuilder(), renderRange = this._renderRange;

                    if (!renderRange.isValid()) {
                        return;
                    }

                    var headerRowElment = this._elements.headerCanvas.eq(TableView.MainCanvasIndex);

                    var html = new Support.StringBuilder();
                    var addedColumnUniqueIds = [];
                    var front = renderRange.front();
                    var end = renderRange.end();

                    for (var columnIndex = front; columnIndex &lt;= end; columnIndex++) {
                        var columnUniqueId = this._visibleColumnMap[columnIndex], column = this._options.columns[columnUniqueId];

                        if (!context.renderedHeaderCells[columnUniqueId]) {
                            context.renderedHeaderCells[columnUniqueId] = {
                                state: 0 /* Initial */,
                                headerCellContentElement: null
                            };

                            html.append('&lt;div class="msoc-list-table-header-cell msoc-list-table-header-cell-');
                            html.append(columnUniqueId);

                            if (columnIndex == 0) {
                                html.append(' msoc-list-table-header-cell-first');
                            }

                            html.append('" data-columnUniqueId="');
                            html.append(columnUniqueId);
                            html.append('">');
                            html.append('&lt;div class="msoc-list-table-header-cell-content msoc-list-table-header-cell-content-');
                            html.append(columnUniqueId);
                            html.append('">');
                            html.append('&lt;/div>');
                            html.append('&lt;div class="msoc-list-table-header-cell-v-border msoc-list-table-header-cell-v-border-');
                            html.append(columnUniqueId);
                            html.append('">&lt;/div>');

                            html.append('&lt;div class="msoc-list-table-header-cell-splitter msoc-list-table-header-cell-splitter-front">&lt;/div>');
                            html.append('&lt;div class="msoc-list-table-header-cell-splitter msoc-list-table-header-cell-splitter-end">&lt;/div>');
                            html.append('&lt;/div>');

                            addedColumnUniqueIds.push(columnUniqueId);
                        }
                    }

                    var headerCellHtml = html.toString();

                    if (headerCellHtml.length > 0) {
                        headerRowElment[0].insertAdjacentHTML('beforeend', headerCellHtml);

                        var headerCellContentElements = headerRowElment.find('> .msoc-list-table-header-cell > .msoc-list-table-header-cell-content');

                        for (var i = 0; i &lt; addedColumnUniqueIds.length; i++) {
                            var columnUniqueId = addedColumnUniqueIds[i];

                            context.renderedHeaderCells[columnUniqueId].headerCellContentElement = headerCellContentElements[headerCellContentElements.length - addedColumnUniqueIds.length + i];
                        }
                    }

                    for (var i = renderRange.front(); i &lt;= renderRange.end(); i++) {
                        var columnUniqueId = this._visibleColumnMap[i], column = this._options.columns[columnUniqueId];

                        if (context.renderedHeaderCells[columnUniqueId].state != 2 /* Painted */) {
                            this._runtime.renderHeaderCellContent({
                                element: context.renderedHeaderCells[columnUniqueId].headerCellContentElement,
                                columnUniqueId: columnUniqueId,
                                rect: this.getHeaderCellRect(columnUniqueId)
                            });

                            context.renderedHeaderCells[columnUniqueId].state = 2 /* Painted */;
                        }
                    }
                };

                TableView.prototype._renderCellWorker = function (context) {
                    var html = new Support.StringBuilder(), renderRange = this._renderRange;

                    if (!renderRange.isValid()) {
                        return;
                    }

                    for (var rowIndex = renderRange.top(); rowIndex &lt;= renderRange.bottom(); rowIndex++) {
                        var row = this._runtime.getRowByIndex(rowIndex);
                        var painted = false;

                        if (!row) {
                            continue;
                        }

                        var rowUniqueId = row.rowUniqueId;

                        if (!context.renderedRows[rowUniqueId]) {
                            context.renderedRows[rowUniqueId] = {
                                state: 0 /* Initial */,
                                front: NaN,
                                end: NaN,
                                rowElement: null,
                                renderedCells: {}
                            };
                        }

                        if (context.renderedRows[rowUniqueId].state == 0 /* Initial */) {
                            html.append('&lt;div class="msoc-list-row msoc-list-table-row-');
                            html.append(row.rowUniqueId);

                            if (row.rowIndex % 2 == 1) {
                                html.append(' msoc-list-odd');
                            } else {
                                html.append(' msoc-list-even');
                            }

                            html.append('"');
                            html.append(' data-rowUniqueId="');
                            html.append(row.rowUniqueId);
                            html.append('">');

                            if (rowIndex != this._options.rowCount - 1) {
                                html.append('&lt;div class="msoc-list-table-row-border">&lt;/div>');
                            }

                            html.append('&lt;/div>');

                            var mainCanvasDiv = this._elements.canvas[TableView.MainCanvasIndex];

                            mainCanvasDiv.insertAdjacentHTML('beforeend', html.toString());
                            context.renderedRows[rowUniqueId].rowElement = $(mainCanvasDiv.lastChild);
                            context.renderedRows[rowUniqueId].state = 2 /* Painted */;
                            painted = true;
                        }

                        var rowElement = context.renderedRows[rowUniqueId].rowElement;
                        var renderedCells = context.renderedRows[rowUniqueId].renderedCells;
                        var front = renderRange.front();
                        var end = renderRange.end();

                        html = new Support.StringBuilder();
                        var addedColumnUniqueIds = [];

                        for (var columnIndex = front; columnIndex &lt;= end; columnIndex++) {
                            var columnUniqueId = this._visibleColumnMap[columnIndex], column = this._options.columns[columnUniqueId];

                            if (!renderedCells[columnUniqueId]) {
                                renderedCells[columnUniqueId] = {
                                    state: 0 /* Initial */,
                                    cellContentElement: null
                                };

                                html.append('&lt;div class="msoc-list-table-cell msoc-list-table-cell-');
                                html.append(columnUniqueId);
                                html.append('"');
                                html.append(' data-rowUniqueId="');
                                html.append(row.rowUniqueId);
                                html.append('"');
                                html.append(' data-columnUniqueId="');
                                html.append(columnUniqueId);
                                html.append('">');
                                html.append('&lt;div class="msoc-list-table-cell-content msoc-list-table-cell-content-');
                                html.append(columnUniqueId);
                                html.append('">');
                                html.append('&lt;/div>');
                                html.append('&lt;/div>');

                                addedColumnUniqueIds.push(columnUniqueId);
                            }
                        }

                        var cellHtml = html.toString();

                        if (cellHtml.length > 0) {
                            rowElement[0].insertAdjacentHTML('beforeend', html.toString());

                            var cellContentElements = rowElement.find('> .msoc-list-table-cell > div');

                            for (var i = 0; i &lt; addedColumnUniqueIds.length; i++) {
                                var columnUniqueId = addedColumnUniqueIds[i];

                                renderedCells[columnUniqueId].cellContentElement = cellContentElements[cellContentElements.length - addedColumnUniqueIds.length + i];
                            }

                            painted = true;
                        }

                        for (var i = renderRange.front(); i &lt;= renderRange.end(); i++) {
                            var columnUniqueId = this._visibleColumnMap[i], column = this._options.columns[columnUniqueId];

                            if (renderedCells[columnUniqueId].state != 2 /* Painted */) {
                                this._runtime.renderCellContent({
                                    element: renderedCells[columnUniqueId].cellContentElement,
                                    row: row,
                                    rowIndex: rowIndex,
                                    columnUniqueId: columnUniqueId,
                                    columnIndex: this._visibleColumnMap.indexOf(columnUniqueId),
                                    rect: this.getCellRect(rowUniqueId, i)
                                });

                                renderedCells[columnUniqueId].state = 2 /* Painted */;
                                painted = true;
                            }
                        }

                        if (painted) {
                            return true;
                        }
                    }
                };

                TableView.prototype._removeCellWorker = function (context) {
                    for (var rowUniqueId in context.renderedRows) {
                        var row = this._runtime.getRowByUniqueId(rowUniqueId);

                        if (!row) {
                            // In the case a row has been deleted from table
                            var rowElement = context.renderedRows[rowUniqueId].rowElement;

                            if (rowElement) {
                                rowElement.remove();
                            }

                            delete context.renderedRows[rowUniqueId];
                            return true;
                        } else if (row.rowIndex &lt; this._renderRange.top() || row.rowIndex > this._renderRange.bottom()) {
                            // The row is not showed in the render area
                            var rowElement = context.renderedRows[rowUniqueId].rowElement;

                            if (rowElement) {
                                rowElement.remove();
                            }

                            delete context.renderedRows[rowUniqueId];
                            return true;
                        } else {
                            var renderedCells = context.renderedRows[rowUniqueId].renderedCells;
                            var removed = false;

                            for (var columnUniqueId in renderedCells) {
                                var columnIndex = this._visibleColumnMap.indexOf(columnUniqueId);

                                if (columnIndex &lt; this._renderRange.front() || columnIndex > this._renderRange.end()) {
                                    var cellContentElement = renderedCells[columnUniqueId].cellContentElement;

                                    if (cellContentElement) {
                                        $(cellContentElement).parent().remove();
                                    }

                                    delete renderedCells[columnUniqueId];
                                    removed = true;
                                }
                            }

                            if (removed) {
                                return true;
                            }
                        }
                    }
                };
                TableView.MainCanvasIndex = 1;
                TableView.CursorCanvasIndex = 2;
                return TableView;
            })();

            var StackView = (function () {
                function StackView(runtime) {
                    var _this = this;
                    this.disposer = new Controls.Fundamental.Disposer(function () {
                        _this._isActivate = false;
                        _this._elements = null;
                    });
                    this._isActivate = false;
                    this._properties = new Support.PropertyBag({
                        headerWidth: 100,
                        selectionIndicator: false
                    });
                    this._visibleColumnMap = [];
                    this._runtime = runtime;
                    this._options = this._runtime.options;
                    this._elements = this._runtime.elements;
                    this._updaters = new Support.UpdaterGroup();
                    this.disposer.addDisposable(this._updaters);
                    this.disposer.addDisposable(this._rowTopStylesheetUpdater = new Support.DynamicStylesheetUpdater(this._runtime.id + '_stack_render_row'));
                    this.disposer.addDisposable(this._selectionStylesheetUpdater = new Support.DynamicStylesheetUpdater(this._runtime.id + '_stack_selection'));
                    this.disposer.addDisposable(this._layoutStylesheetUpdater = new Support.DynamicStylesheetUpdater(this._runtime.id + '_stack_root'));
                    this.disposer.addDisposable(this._renderingScheduler = new Support.RenderingScheduler());
                    this._renderContext = {
                        renderedRows: []
                    };
                    this._renderingScheduler.addWorker(function (context) {
                        return _this._renderCellWorker(context);
                    }, this._renderContext, 1000);
                    this._renderingScheduler.addWorker(function (context) {
                        return _this._removeCellWorker(context);
                    }, this._renderContext, 2000);
                    this._renderingScheduler.start(false);

                    this._selectionStylesheetUpdater.add(function () {
                        return _this._getSelectionStylesheet();
                    });
                    this._layoutStylesheetUpdater.add(function () {
                        return _this._getLayoutStylesheet();
                    });
                    this._rowTopStylesheetUpdater.add(function () {
                        return _this._getRowTopStylesheet();
                    });

                    this._updaters.add(this._layoutUpdater = this._getLayoutUpdater());
                    this._updaters.add(this._renderRangeUpdater = this._getRenderRangeUpdater());
                    this._updaters.add(this._layoutStylesheetUpdater.getUpdater());
                    this._updaters.add(this._rowTopStylesheetUpdater.getUpdater());
                    this._updaters.add(this._selectionStylesheetUpdater.getUpdater());
                    this._attachEvents();
                }
                StackView.prototype.dispose = function () {
                    this.disposer.dispose();
                };

                StackView.prototype.name = function () {
                    return 'stack';
                };

                StackView.prototype.type = function () {
                    return 1 /* Stack */;
                };

                StackView.prototype.activate = function () {
                    if (this.disposer.isDisposed) {
                        return;
                    }

                    this._isActivate = true;
                    this._elements.headerViewport.css('display', 'none');
                    this._elements.canvas.eq(StackView.MainCanvasIndex).addClass('msoc-list-canvas-primary');
                    this._elements.headerCanvas.eq(StackView.MainCanvasIndex).addClass('msoc-list-canvas-primary');
                    this._renderContext.renderedRows = [];
                    this._renderContext.renderedHeaderCells = [];
                    this._renderingScheduler.resume();
                    this._renderRangeUpdater.update();
                    this._runtime.selection.columnCount(1);
                };

                StackView.prototype.deactivate = function () {
                    if (this.disposer.isDisposed) {
                        return;
                    }

                    this._elements.viewport.attr('style', '');
                    this._elements.canvas.attr('style', '');
                    this._elements.canvasContainer.attr('style', '');
                    this._elements.headerViewport.attr('style', '');
                    this._elements.headerCanvas.attr('style', '');
                    this._elements.headerCanvasContainer.attr('style', '');

                    this._elements.headerCanvas.eq(StackView.MainCanvasIndex).html('');
                    this._elements.canvas.eq(StackView.MainCanvasIndex).html('');
                    this._elements.canvas.eq(StackView.MainCanvasIndex).removeClass('msoc-list-canvas-primary');
                    this._elements.headerCanvas.eq(StackView.MainCanvasIndex).removeClass('msoc-list-canvas-primary');
                    this._updaters.reset();
                    this._layoutStylesheetUpdater.reset();
                    this._renderingScheduler.suspend(false);
                    this._isActivate = false;
                };

                StackView.prototype.updateUI = function () {
                    if (!this._isFunctional()) {
                        return false;
                    }

                    return this._updaters.update();
                };

                StackView.prototype.controller = function () {
                    var _this = this;
                    return {
                        headerWidth: function () {
                            return _this._headerWidth.apply(_this, arguments);
                        },
                        selectionIndicator: function () {
                            return _this._selectionIndicator.apply(_this, arguments);
                        },
                        columns: function () {
                            return _this._columns.apply(_this, arguments);
                        },
                        hideColumnByIndex: function () {
                            return _this._hideColumnByIndex.apply(_this, arguments);
                        },
                        showColumnByIndex: function () {
                            return _this._showColumnByIndex.apply(_this, arguments);
                        },
                        getColumnIdByIndex: function () {
                            return _this.getColumnIdByIndex.apply(_this, arguments);
                        },
                        getColumnIndexById: function () {
                            return _this.getColumnIndexById.apply(_this, arguments);
                        }
                    };
                };

                StackView.prototype.invalidate = function () {
                    this._invalidateRange(this._renderRange);
                };

                StackView.prototype.invalidateRange = function (range) {
                    this._invalidateRange(range);
                };

                StackView.prototype.invalidateHeaderRange = function (range) {
                    if (!range) {
                        range = new Range(2 /* Range */, 0, 0, 0, this._visibleColumnMap.length - 1);
                    }

                    if (!range.isValid()) {
                        return;
                    }

                    for (var columnIndex = range.front(); columnIndex &lt; range.end(); columnIndex++) {
                        var columnUniqueId = this._visibleColumnMap[columnIndex];

                        this._invalidateHeaderCell(columnUniqueId);
                    }
                };

                StackView.prototype.getHeaderCellRect = function (rowIndex, columnUniqueId) {
                    var columnIndex = this._visibleColumnMap.indexOf(columnUniqueId);

                    if (rowIndex &lt; 0 || isNaN(rowIndex) || rowIndex >= this._options.rowCount || columnIndex &lt; 0 || isNaN(columnIndex) || columnIndex > this._visibleColumnMap.length - 1) {
                        return {
                            top: NaN,
                            height: NaN,
                            front: NaN,
                            width: NaN
                        };
                    }

                    var rowHeight = this._getRowHeight(), selectionIndicatorWidth = this._options.theme.value('stack.selectionIndicatorWidth'), cellHBorder = this._options.theme.value('stack.cellHBorder'), column = this._options.columns[columnUniqueId], front = this._properties.selectionIndicator ? selectionIndicatorWidth : 0;

                    return {
                        top: rowIndex * rowHeight + rowIndex * cellHBorder.width + column.stack.top,
                        height: this._getColumnHeight(columnUniqueId),
                        front: front,
                        width: this._properties.headerWidth
                    };
                };

                StackView.prototype.getCellRect = function (rowIndex, columnUniqueId) {
                    var columnIndex = this._visibleColumnMap.indexOf(columnUniqueId);

                    if (rowIndex &lt; 0 || isNaN(rowIndex) || rowIndex >= this._options.rowCount || columnIndex &lt; 0 || isNaN(columnIndex) || columnIndex > this._visibleColumnMap.length - 1) {
                        return {
                            top: NaN,
                            height: NaN,
                            front: NaN,
                            width: NaN
                        };
                    }

                    var rowHeight = this._getRowHeight(), selectionIndicatorWidth = this._options.theme.value('stack.selectionIndicatorWidth'), headerEndBorder = this._options.theme.value('stack.headerEndBorder'), cellHBorder = this._options.theme.value('stack.cellHBorder'), column = this._options.columns[columnUniqueId], front = this._properties.headerWidth + headerEndBorder.width + (this._properties.selectionIndicator ? selectionIndicatorWidth : 0);

                    return {
                        top: rowIndex * rowHeight + rowIndex * cellHBorder.width + column.stack.top,
                        height: this._getColumnHeight(columnUniqueId),
                        front: front,
                        width: this._runtime.viewportClientWidth - front
                    };
                };

                StackView.prototype.getColumnIndexById = function (columnUniqueId) {
                    var index = this._visibleColumnMap.indexOf(columnUniqueId);

                    return index >= 0 ? NaN : index;
                };

                StackView.prototype.getColumnIdByIndex = function (columnIndex) {
                    var columnUniqueId = this._visibleColumnMap[columnIndex];

                    return columnUniqueId;
                };

                StackView.prototype._headerWidth = function () {
                    var _this = this;
                    return this._properties.$property({
                        name: 'headerWidth',
                        args: arguments,
                        afterChange: function () {
                            _this._runtime.updateUI(1);
                        }
                    });
                };

                StackView.prototype._selectionIndicator = function () {
                    var _this = this;
                    return this._properties.$property({
                        name: 'selectionIndicator',
                        args: arguments,
                        afterChange: function () {
                            _this._runtime.updateUI(1);
                        }
                    });
                };

                StackView.prototype._isFunctional = function () {
                    return !this.disposer.isDisposed &amp;&amp; this._isActivate;
                };

                StackView.prototype._attachEvent = function (site, name, callback, checkFuntional) {
                    var _this = this;
                    if (typeof checkFuntional === "undefined") { checkFuntional = true; }
                    var actualCallback = callback;

                    if (checkFuntional) {
                        actualCallback = function () {
                            if (!_this._isFunctional()) {
                                return;
                            }

                            return callback.apply(null, arguments);
                        };
                    }

                    this.disposer.addDisposable(new Support.EventAttacher(site, name, actualCallback));
                };

                StackView.prototype._attachEvents = function () {
                    var _this = this;
                    this._attachEvent(this._runtime.events, 'addColumns', function (sender, args) {
                        var columns = args.columns, lastColumn = _this._visibleColumnMap.length > 0 ? _this._options.columns[_this._visibleColumnMap[_this._visibleColumnMap.length - 1]] : null;

                        for (var columnIndex = 0; columnIndex &lt; columns.length; columnIndex++) {
                            var column = columns[columnIndex];

                            column.stack = {};

                            if (_this._visibleColumnMap.length >= 4) {
                                continue;
                            }

                            _this._visibleColumnMap.push(column.columnUniqueId);

                            if (column.raw.stack) {
                                if (isNaN(column.raw.stack.height)) {
                                    column.stack.height = NaN;
                                } else if (column.raw.stack.height &lt;= 0) {
                                    throw Support.createError(0, 'StackView', 'invalid height: ' + column.raw.stack.height);
                                } else {
                                    column.stack.height = column.raw.stack.height;
                                }
                            }

                            if (lastColumn) {
                                column.stack.top = lastColumn.stack.top + _this._getColumnHeight(column.columnUniqueId) + _this._options.theme.value('stack.rowBorder').width;
                            } else {
                                column.stack.top = 0;
                            }

                            lastColumn = column;
                        }

                        _this._renderRangeUpdater.update();

                        if (_this._isFunctional()) {
                            _this._runtime.selection.columnCount(_this._visibleColumnMap.length);
                        }
                    }, false);

                    this._attachEvent(this._runtime.events, 'selectionChange', function () {
                        return _this._selectionStylesheetUpdater.getUpdater().update();
                    });
                    this._attachEvent(this._runtime.events, 'propertyChange', function (sender, args) {
                        return _this._propertyChange(sender, args);
                    });
                    this._attachEvent(this._runtime.events, 'updateRows', function (sender, args) {
                        return _this._onUpdateRows(sender, args);
                    });
                    this._attachEvent(this._runtime.events, 'removeRows', function (sender, args) {
                        return _this._onRemoveInsertRows.apply(_this, arguments);
                    });
                    this._attachEvent(this._runtime.events, 'insertRows', function (sender, args) {
                        return _this._onRemoveInsertRows.apply(_this, arguments);
                    });
                    this._attachEvent(this._runtime.events, 'updateHeaderCell', function (sender, args) {
                        return _this._invalidateHeaderCell(args.columnUniqueId);
                    });
                    this._attachEvent(this._runtime.events, 'viewportScroll', function (sender, args) {
                        return _this._renderRangeUpdater.update();
                    });
                    this._attachEvent(this._elements.viewport, 'click', function (event) {
                        return _this._viewportClick(event);
                    });
                };

                StackView.prototype._columns = function (columns) {
                    if (arguments.length > 0) {
                        this._visibleColumnMap = [];

                        for (var columnIndex = 0; columnIndex &lt; columns.length; columnIndex++) {
                            var columnUniqueId = columns[columnIndex].columnId, height = columns[columnIndex].height, column = this._options.columns[columnUniqueId];

                            if (!column) {
                                throw Support.createError(0, 'StackView', 'invalid column id: ' + columnUniqueId);
                            }

                            if (typeof (height) != 'undefined') {
                                height = parseFloat(height);

                                if (isNaN(height)) {
                                    column.stack.height = NaN;
                                } else if (height &lt;= 0) {
                                    throw Support.createError(0, 'StackView', 'invalid height: ' + columns[columnIndex].height);
                                } else {
                                    column.stack.height = height;
                                }
                            }

                            this._visibleColumnMap.push(columnUniqueId);
                        }

                        this._updateColumnPosition();

                        if (this._isFunctional()) {
                            this._runtime.selection.columnCount(this._visibleColumnMap.length);
                        }
                    } else {
                        var columns = [];
                        for (var columnIndex = 0; columnIndex &lt; this._visibleColumnMap.length; columnIndex++) {
                            var columnUniqueId = this._visibleColumnMap[columnIndex], column = this._options.columns[columnUniqueId];

                            columns.push({
                                columnId: columnUniqueId,
                                columnIndex: columnIndex,
                                height: column.stack.height
                            });
                        }

                        return columns;
                    }
                };

                // FIXME: we should re-calculate the scroll top after show/hide column
                StackView.prototype._hideColumnByIndex = function (columnIndex) {
                    if (columnIndex &lt; 0 || columnIndex >= this._visibleColumnMap.length) {
                        throw Support.createError(0, 'StackView', 'Invalidate columnIndex:' + columnIndex + ', validate range is [0, ' + this._visibleColumnMap.length + ']');
                    }

                    this._visibleColumnMap.splice(columnIndex, 1);
                    this._renderRangeUpdater.update();
                    this._runtime.updateUI(1);
                };

                StackView.prototype._showColumnByIndex = function (columnIndex, columnUniqueId) {
                    if (columnIndex &lt; 0 || columnIndex > this._visibleColumnMap.length) {
                        throw Support.createError(0, 'StackView', 'Invalidate columnIndex:' + columnIndex + ', validate range is [0, ' + this._visibleColumnMap.length + ']');
                    }

                    var column = this._options.columns[columnUniqueId];

                    if (!column) {
                        throw Support.createError(0, 'StackView', 'Column with id ' + columnUniqueId + ' does not exist');
                    }

                    this._visibleColumnMap.splice(columnIndex, 0, columnUniqueId);
                    this._renderRangeUpdater.update();
                    this._runtime.updateUI(1);
                };

                StackView.prototype._getRowFromEvent = function (event) {
                    var rowElement = $(event.target).closest('.msoc-list-row'), rowUniqueId = rowElement.attr('data-rowUniqueId'), row = this._runtime.getRowByUniqueId(rowUniqueId);

                    if (row) {
                        var rowIndex = row.rowIndex;

                        return { rowElement: rowElement, rowIndex: rowIndex, rowUniqueId: rowUniqueId };
                    }
                };

                StackView.prototype._viewportClick = function (event) {
                    var cell = this._getRowFromEvent(event);

                    if (!cell) {
                        return;
                    }

                    var beforeCursorChangeArgs = {
                        oldCursorPosition: this._runtime.selection.cursor(),
                        newCursorPosition: new Position(cell.rowIndex, 0),
                        cancel: false
                    };

                    this._runtime.events.emit('stack.beforeCursorChange', this, beforeCursorChangeArgs);

                    if (!beforeCursorChangeArgs.cancel) {
                        this._runtime.selection.cursor(beforeCursorChangeArgs.newCursorPosition);
                    }

                    this._runtime.events.emit('stack.rowClick', this, {
                        rowIndex: cell.rowIndex,
                        event: event
                    });
                };

                StackView.prototype._getRenderRange = function () {
                    var topRow, bottomRow;

                    topRow = Math.floor(this._runtime.viewportScrollCoordinate.top() / (this._getRowHeight() + this._options.theme.value('stack.rowBorder').width));
                    topRow = Math.max(0, topRow);
                    bottomRow = Math.floor((this._runtime.viewportScrollCoordinate.top() + this._runtime.viewportHeight) / (this._getRowHeight() + this._options.theme.value('stack.rowBorder').width));
                    bottomRow = Math.min(this._options.rowCount - 1, bottomRow);

                    return new Range(2 /* Range */, topRow, bottomRow, 0, this._visibleColumnMap.length - 1);
                };

                StackView.prototype._updateColumnPosition = function () {
                    var cellHBorderWidth = this._options.theme.value('stack.cellHBorder').width, accumulateTop = 0;

                    for (var i = 0; i &lt; this._visibleColumnMap.length; i++) {
                        var columnUniqueId = this._visibleColumnMap[i], column = this._options.columns[columnUniqueId];

                        column.stack.top = accumulateTop;
                        accumulateTop += this._getColumnHeight(columnUniqueId) + cellHBorderWidth;
                    }

                    this._renderRangeUpdater.update();
                    this._runtime.updateUI(1);
                };

                StackView.prototype._getFullRange = function () {
                    if (this._options.rowCount &lt;= 0 || this._visibleColumnMap.length &lt;= 0) {
                        return new Range(2 /* Range */, NaN, NaN, NaN, NaN);
                    }

                    return new Range(2 /* Range */, 0, this._options.rowCount - 1, 0, 0);
                };

                StackView.prototype._getRenderRangeUpdater = function () {
                    var _this = this;
                    var eventSender = new Support.AccumulateTimeoutInvoker(function () {
                        if (_this._renderRange.isValid()) {
                            _this._runtime.events.emit('stack.beforeRender', _this, {
                                renderRange: _this._renderRange
                            });
                        }
                    }, 16.67);

                    return new Support.Updater(function () {
                        var renderRange = _this._getRenderRange();
                        var rowUniqueIds = [];

                        if (renderRange.isValid()) {
                            for (var rowIndex = renderRange.top(); rowIndex &lt;= renderRange.bottom(); rowIndex++) {
                                var row = _this._runtime.getRowByIndex(rowIndex);

                                if (row) {
                                    rowUniqueIds.push(row.rowUniqueId);
                                }
                            }

                            rowUniqueIds.sort();
                        }

                        return {
                            renderRange: renderRange,
                            rowUniqueIds: rowUniqueIds
                        };
                    }, function (newValue) {
                        var renderRange = newValue.renderRange;

                        _this._renderRange = renderRange;

                        eventSender.invoke();
                    });
                };

                StackView.prototype._propertyChange = function (sender, args) {
                    switch (args.name) {
                        case 'height':
                        case 'width':
                        case 'rowCount':
                            this._renderRangeUpdater.update();
                            break;

                        case 'theme':
                            this._invalidateRange(this._renderRange);
                            this._updateColumnPosition();
                            break;

                        case 'rtl':
                            this._invalidateRange(this._renderRange);
                            break;
                    }
                };

                StackView.prototype._onRemoveInsertRows = function (sender, args) {
                    this._renderRangeUpdater.update();
                    this._layoutUpdater.update();
                    this._rowTopStylesheetUpdater.getUpdater().update();

                    if (args.range.top() &lt;= this._renderRange.bottom()) {
                        this._adjustOddEvenRow();
                    }
                };

                StackView.prototype._onUpdateRows = function (sender, args) {
                    this._rowTopStylesheetUpdater.getUpdater().update();
                    this._invalidateRows(args.range);
                };

                StackView.prototype._getColumnHeight = function (columnUniqueId) {
                    var column = this._options.columns[columnUniqueId];

                    return isNaN(column.stack.height) ? this._options.theme.value('stack.cellHeight') : column.stack.height;
                };

                StackView.prototype._getRowHeight = function () {
                    var height = 0, rowPadding = this._options.theme.value('stack.rowPadding');

                    for (var i = 0; i &lt; this._visibleColumnMap.length; i++) {
                        height += this._getColumnHeight(this._visibleColumnMap[i]);
                    }

                    height += rowPadding.top + rowPadding.bottom;

                    return height;
                };

                StackView.prototype._getSelectionStylesheet = function () {
                    if (!this._properties.selectionIndicator) {
                        return;
                    }

                    var cssText = new Support.CssTextBuilder(), selectionBackgroundColor = this._options.theme.value('selectionBackgroundColor'), selectionIndicatorWidth = this._options.theme.value('stack.selectionIndicatorWidth'), selectionIndicatorPadding = this._options.theme.value('stack.selectionIndicatorPadding');

                    if (this._runtime.selection.selectionMode() == 0 /* SingleRow */ || this._runtime.selection.selectionMode() == 1 /* MultipleRows */) {
                        var selectedRanges = this._runtime.selection.ranges();

                        for (var selectedRangeIndex = 0; selectedRangeIndex &lt; selectedRanges.length; selectedRangeIndex++) {
                            var intersectionRange = Range.intersection(this._renderRange, selectedRanges[selectedRangeIndex]);

                            if (intersectionRange) {
                                for (var rowIndex = intersectionRange.top(); rowIndex &lt;= intersectionRange.bottom(); rowIndex++) {
                                    var row = this._runtime.getRowByIndex(rowIndex);

                                    if (!row) {
                                        continue;
                                    }

                                    this._runtime.buildCssRootSelector(cssText);
                                    cssText.push('.msoc-list-stack-row-');
                                    cssText.push(row.rowUniqueId);
                                    cssText.push('>.msoc-list-stack-row-selection');
                                    cssText.property(this._runtime.direction.front(), selectionIndicatorPadding.front, 'px');
                                    cssText.property('width', selectionIndicatorWidth - selectionIndicatorPadding.front - selectionIndicatorPadding.end, 'px');
                                    cssText.property('top', selectionIndicatorPadding.top, 'px');
                                    cssText.property('bottom', selectionIndicatorPadding.bottom, 'px');
                                    cssText.property('background-color', selectionBackgroundColor);
                                }
                            }
                        }
                    }

                    return cssText.toString();
                };

                StackView.prototype._getLayoutStylesheet = function () {
                    var cssText = new Support.CssTextBuilder(), headerCellPadding = this._options.theme.value('stack.headerCellPadding'), headerEndBorder = this._options.theme.value('stack.headerEndBorder'), cellPadding = this._options.theme.value('stack.cellPadding'), rowPadding = this._options.theme.value('stack.rowPadding'), rowBorder = this._options.theme.value('stack.rowBorder'), oddRowBackgroundColor = this._options.theme.value('table.oddRowBackgroundColor'), evenRowBackgroundColor = this._options.theme.value('table.evenRowBackgroundColor'), headerEndBorder = this._options.theme.value('stack.headerEndBorder'), rowHeight = this._getRowHeight(), selectionIndicatorWidth = this._options.theme.value('stack.selectionIndicatorWidth'), accumulateTop = rowPadding.top;

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-row');
                    cssText.property('height', rowHeight, 'px');

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-stack-header-cell');
                    cssText.property(this._runtime.direction.front(), this._properties.selectionIndicator ? selectionIndicatorWidth : 0, 'px');
                    cssText.property('width', this._properties.headerWidth - (this._properties.selectionIndicator ? selectionIndicatorWidth : 0), 'px');
                    cssText.property('cursor', this._options.theme.value('stack.headerCursor'));

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-stack-header-cell-content');
                    cssText.property('font-family', this._options.theme.value('stack.headerCellFontFamily'));
                    cssText.property('font-size', this._options.theme.value('stack.headerCellFontSize'));
                    cssText.property('top', 0, 'px');
                    cssText.property(this._runtime.direction.front(), 0, 'px');
                    cssText.property(this._runtime.direction.end(), 0, 'px');
                    cssText.property('padding', this._runtime.direction.rtl() ? headerCellPadding.raw.rtl : headerCellPadding.raw.ltr);

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-stack-cell');
                    cssText.property(this._runtime.direction.front(), this._properties.headerWidth + this._options.theme.value('stack.headerHBorder').width, 'px');
                    cssText.property(this._runtime.direction.end(), 0, 'px');
                    cssText.property('cursor', this._options.theme.value('stack.cellCursor'));

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-stack-cell-content');
                    cssText.property('font-family', this._options.theme.value('stack.cellFontFamily'));
                    cssText.property('font-size', this._options.theme.value('stack.cellFontSize'));
                    cssText.property('top', 0, 'px');
                    cssText.property(this._runtime.direction.front(), 0, 'px');
                    cssText.property(this._runtime.direction.end(), 0, 'px');
                    cssText.property('padding', this._runtime.direction.rtl() ? cellPadding.raw.rtl : cellPadding.raw.ltr);

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-stack-header-end-border');
                    cssText.property(this._runtime.direction.front(), this._properties.headerWidth, 'px');
                    cssText.property('width', headerEndBorder.width, 'px');
                    cssText.property('border-' + this._runtime.direction.end(), headerEndBorder.raw);

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-stack-row-border');
                    cssText.property('top', rowHeight, 'px');
                    cssText.property('width', '100%');
                    cssText.property('border-bottom', rowBorder.raw);

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-row.msoc-list-odd');
                    cssText.property('background-color', oddRowBackgroundColor);

                    this._runtime.buildCssRootSelector(cssText);
                    cssText.push('.msoc-list-row.msoc-list-even');
                    cssText.property('background-color', evenRowBackgroundColor);

                    for (var columnIndex = 0; columnIndex &lt; this._visibleColumnMap.length; columnIndex++) {
                        var columnUniqueId = this._visibleColumnMap[columnIndex], height = this._getColumnHeight(columnUniqueId);

                        this._runtime.buildCssRootSelector(cssText);
                        cssText.push('.msoc-list-stack-header-cell-');
                        cssText.push(columnUniqueId);
                        cssText.property('top', accumulateTop, 'px');
                        cssText.property('height', height, 'px');

                        this._runtime.buildCssRootSelector(cssText);
                        cssText.push('.msoc-list-stack-header-cell-content-');
                        cssText.push(columnUniqueId);
                        cssText.property('height', height, 'px');
                        cssText.property('line-height', height, 'px');

                        this._runtime.buildCssRootSelector(cssText);
                        cssText.push('.msoc-list-stack-cell-');
                        cssText.push(columnUniqueId);
                        cssText.property('top', accumulateTop, 'px');
                        cssText.property('height', height, 'px');

                        this._runtime.buildCssRootSelector(cssText);
                        cssText.push('.msoc-list-stack-cell-content-');
                        cssText.push(columnUniqueId);
                        cssText.property('height', height, 'px');
                        cssText.property('line-height', height, 'px');

                        accumulateTop += height;
                    }
                    ;

                    return cssText.toString();
                };

                StackView.prototype._getLayoutUpdater = function () {
                    var _this = this;
                    return new Support.Updater(function () {
                        var viewportWidth = _this._runtime.viewportWidth, rowBorder = _this._options.theme.value('stack.rowBorder'), canvasHeight = _this._options.rowCount * _this._getRowHeight() + (_this._options.rowCount - 1) * rowBorder.width;

                        return {
                            width: _this._runtime.width,
                            height: _this._runtime.height,
                            viewportWidth: viewportWidth,
                            canvasHeight: canvasHeight,
                            rtl: _this._runtime.direction.rtl()
                        };
                    }, function (newValue, oldValue) {
                        var width = newValue.width, height = newValue.height, canvasHeight = newValue.canvasHeight;

                        _this._elements.viewport.css('overflow', 'auto');
                        _this._elements.viewport.css('position', 'absolute');
                        _this._elements.viewport.css('top', 0);
                        _this._elements.viewport.css('height', height + 'px');
                        _this._elements.viewport.css('width', '100%');
                        _this._elements.canvasContainer.css('height', canvasHeight);
                        _this._elements.canvasContainer.css('width', _this._elements.viewport[0].clientWidth + 'px');

                        if (newValue == oldValue &amp;&amp; _this._runtime.canvasHeight) {
                            var newScrollTop = Support.Calculator.calculateScrollTopAfterSwitchView(_this._runtime.canvasHeight, newValue.canvasHeight, _this._runtime.viewportClientHeight, _this._elements.viewport[0].clientHeight, _this._runtime.viewportScrollCoordinate.top());

                            _this._elements.viewport.scrollTop(newScrollTop);
                            _this._runtime.viewportScrollCoordinate.top(_this._elements.viewport.scrollTop());
                        }

                        _this._runtime.updateSize();
                    });
                };

                StackView.prototype._getRowTopStylesheet = function () {
                    var renderRange = this._renderRange, cssText = new Support.CssTextBuilder(), headerRowWidth = this._properties.headerWidth, rowBorder = this._options.theme.value('stack.rowBorder');

                    for (var rowIndex = renderRange.top(); rowIndex &lt;= renderRange.bottom(); rowIndex++) {
                        var row = this._runtime.getRowByIndex(rowIndex);

                        if (!row) {
                            continue;
                        }

                        cssText.push('.msoc-list-stack-row-');
                        cssText.push(row.rowUniqueId);
                        cssText.property('top', rowIndex * this._getRowHeight() + rowIndex * rowBorder.width, 'px');
                        cssText.property('height', this._getRowHeight(), 'px');
                        cssText.property('width', '100', '%');
                    }

                    return cssText.toString();
                };

                StackView.prototype._invalidateHeader = function () {
                    for (var i in this._renderContext.renderedHeaderCells) {
                        var renderedHeaderCell = this._renderContext.renderedHeaderCells[i];

                        if (renderedHeaderCell &amp;&amp; renderedHeaderCell.state == 2 /* Painted */) {
                            renderedHeaderCell.state = 1 /* OutDated */;
                        }
                    }
                };

                StackView.prototype._invalidateHeaderCell = function (columnUniqueId) {
                    for (var i in this._renderContext.renderedRows) {
                        var renderedRow = this._renderContext.renderedRows[i];

                        if (renderedRow.RenderState == 0 /* Initial */) {
                            continue;
                        }

                        var renderedHeaderCell = renderedRow.renderedHeaderCells[columnUniqueId];

                        if (renderedHeaderCell.state == 2 /* Painted */) {
                            renderedHeaderCell.state = 1 /* OutDated */;
                        }
                    }
                };

                StackView.prototype._invalidateColumn = function (columnUniqueId) {
                    for (var i in this._renderContext.renderedRows) {
                        var renderedRow = this._renderContext.renderedRows[i];

                        if (renderedRow.RenderState == 0 /* Initial */) {
                            continue;
                        }

                        var renderedCell = renderedRow.renderedCells[columnUniqueId];

                        if (renderedCell &amp;&amp; renderedCell.state == 2 /* Painted */) {
                            renderedCell.state = 1 /* OutDated */;
                        }
                    }
                };

                StackView.prototype._invalidateRange = function (range) {
                    if (!this._renderRange) {
                        return;
                    }

                    var range = Range.intersection(range, this._renderRange);

                    if (!range) {
                        return;
                    }

                    for (var rowIndex = range.top(); rowIndex &lt;= range.bottom(); rowIndex++) {
                        var row = this._runtime.getRowByIndex(rowIndex);

                        if (!row) {
                            return;
                        }

                        for (var columnIndex = range.front(); columnIndex &lt;= range.end(); columnIndex++) {
                            var columnUniqueId = this._visibleColumnMap[columnIndex];

                            this._invalidateCell(row.rowUniqueId, columnUniqueId);
                        }
                    }
                };

                StackView.prototype._invalidateRows = function (range) {
                    if (!this._renderRange) {
                        return;
                    }

                    var range = Range.intersection(range, this._renderRange);

                    if (!range) {
                        return;
                    }

                    for (var rowIndex = range.top(); rowIndex &lt;= range.bottom(); rowIndex++) {
                        var row = this._runtime.getRowByIndex(rowIndex);

                        if (!row) {
                            return;
                        }

                        this._invalidateRow(row.rowUniqueId);
                    }
                };

                StackView.prototype._invalidateRow = function (rowUniqueId) {
                    var renderedRow = this._renderContext.renderedRows[rowUniqueId];

                    if (!renderedRow) {
                        return;
                    }

                    for (var i in renderedRow.renderedCells) {
                        var renderedCell = renderedRow.renderedCells[i];

                        if (renderedCell.state == 2 /* Painted */) {
                            renderedCell.state = 1 /* OutDated */;
                        }
                    }
                };

                StackView.prototype._invalidateCell = function (rowUniqueId, columnUniqueId) {
                    var renderedCell = this._renderContext.renderedRows[rowUniqueId] ? this._renderContext.renderedRows[rowUniqueId].renderedCells[columnUniqueId] : null;

                    if (renderedCell &amp;&amp; renderedCell.state == 2 /* Painted */) {
                        renderedCell.state = 1 /* OutDated */;
                    }
                };

                StackView.prototype._adjustOddEvenRow = function () {
                    for (var rowUniqueId in this._renderContext.renderedRows) {
                        if (this._renderContext.renderedRows[rowUniqueId].state == 2 /* Painted */) {
                            var rowElement = this._renderContext.renderedRows[rowUniqueId].rowElement, row = this._runtime.getRowByUniqueId(rowUniqueId);

                            if (row) {
                                rowElement.removeClass('msoc-list-odd msoc-list-even');

                                if (row.rowIndex % 2 == 1) {
                                    rowElement.addClass('msoc-list-odd');
                                } else {
                                    rowElement.addClass('msoc-list-even');
                                }
                            }
                        }
                    }
                };

                StackView.prototype._renderCellWorker = function (context) {
                    var html = new Support.StringBuilder(), renderRange = this._renderRange;

                    if (!renderRange || !renderRange.isValid()) {
                        return;
                    }

                    for (var rowIndex = renderRange.top(); rowIndex &lt;= renderRange.bottom(); rowIndex++) {
                        var row = this._runtime.getRowByIndex(rowIndex);
                        var painted = false;

                        if (!row) {
                            continue;
                        }

                        var rowUniqueId = row.rowUniqueId;

                        if (!context.renderedRows[rowUniqueId]) {
                            context.renderedRows[rowUniqueId] = {
                                state: 0 /* Initial */,
                                rowElement: null,
                                renderedCells: {},
                                renderedHeaderCells: {}
                            };
                        }

                        if (context.renderedRows[rowUniqueId].state == 0 /* Initial */) {
                            html.append('&lt;div class="msoc-list-row msoc-list-stack-row-');
                            html.append(row.rowUniqueId);

                            if (row.rowIndex % 2 == 1) {
                                html.append(' msoc-list-odd');
                            } else {
                                html.append(' msoc-list-even');
                            }

                            html.append('" data-rowUniqueId="');
                            html.append(row.rowUniqueId);
                            html.append('">');

                            html.append('&lt;div class="msoc-list-stack-row-border">&lt;/div>');
                            html.append('&lt;div class="msoc-list-stack-row-selection">&lt;/div>');
                            html.append('&lt;div class="msoc-list-stack-header-end-border">&lt;/div>');

                            html.append('&lt;/div>');

                            var mainCanvasDiv = this._elements.canvas[StackView.MainCanvasIndex];

                            mainCanvasDiv.insertAdjacentHTML('beforeend', html.toString());
                            context.renderedRows[rowUniqueId].rowElement = $(mainCanvasDiv.lastChild);
                            context.renderedRows[rowUniqueId].state = 2 /* Painted */;
                            painted = true;
                        }

                        var rowElement = context.renderedRows[rowUniqueId].rowElement;
                        var renderedCells = context.renderedRows[rowUniqueId].renderedCells;
                        var renderedHeaderCells = context.renderedRows[rowUniqueId].renderedHeaderCells;
                        var front = renderRange.front();
                        var end = renderRange.end();

                        html = new Support.StringBuilder();
                        var addedColumnUniqueIds = [];

                        for (var columnIndex = front; columnIndex &lt;= end; columnIndex++) {
                            var columnUniqueId = this._visibleColumnMap[columnIndex];

                            if (!renderedCells[columnUniqueId]) {
                                renderedCells[columnUniqueId] = {
                                    state: 0 /* Initial */,
                                    cellContentElement: null
                                };

                                renderedHeaderCells[columnUniqueId] = {
                                    state: 0 /* Initial */,
                                    cellContentElement: null
                                };
                                html.append('&lt;div class="msoc-list-stack-header-cell msoc-list-stack-header-cell-');
                                html.append(columnUniqueId);
                                html.append('">');
                                html.append('&lt;div class="msoc-list-stack-header-cell-content msoc-list-stack-header-cell-content-');
                                html.append(columnUniqueId);
                                html.append('">');
                                html.append('&lt;/div>');
                                html.append('&lt;/div>');

                                html.append('&lt;div class="msoc-list-stack-cell msoc-list-stack-cell-');
                                html.append(columnUniqueId);
                                html.append('">');
                                html.append('&lt;div class="msoc-list-stack-cell-content msoc-list-stack-cell-content-');
                                html.append(columnUniqueId);
                                html.append('">');
                                html.append('&lt;/div>');
                                html.append('&lt;/div>');

                                addedColumnUniqueIds.push(columnUniqueId);
                            }
                        }

                        var cellHtml = html.toString();

                        if (cellHtml.length > 0) {
                            rowElement[0].insertAdjacentHTML('beforeend', html.toString());

                            var headerCellContentElements = rowElement.find('> .msoc-list-stack-header-cell > div');
                            var cellContentElements = rowElement.find('> .msoc-list-stack-cell > div');

                            for (var i = 0; i &lt; addedColumnUniqueIds.length; i++) {
                                var columnUniqueId = addedColumnUniqueIds[i];

                                renderedCells[columnUniqueId].cellContentElement = cellContentElements[cellContentElements.length - addedColumnUniqueIds.length + i];
                                renderedHeaderCells[columnUniqueId].headerCellContentElement = headerCellContentElements[cellContentElements.length - addedColumnUniqueIds.length + i];
                            }

                            painted = true;
                        }

                        for (var i = renderRange.front(); i &lt;= renderRange.end(); i++) {
                            var columnUniqueId = this._visibleColumnMap[i], column = this._options.columns[columnUniqueId];

                            if (renderedCells[columnUniqueId].state != 2 /* Painted */) {
                                this._runtime.renderCellContent({
                                    element: renderedCells[columnUniqueId].cellContentElement,
                                    row: row,
                                    rowIndex: rowIndex,
                                    columnUniqueId: columnUniqueId,
                                    columnIndex: this._visibleColumnMap.indexOf(columnUniqueId),
                                    rect: this.getCellRect(row.rowUniqueId, columnUniqueId)
                                });

                                renderedCells[columnUniqueId].state = 2 /* Painted */;
                                painted = true;
                            }

                            if (renderedHeaderCells[columnUniqueId].state != 2 /* Painted */) {
                                this._runtime.renderHeaderCellContent({
                                    element: renderedHeaderCells[columnUniqueId].headerCellContentElement,
                                    rowUniqueId: row.rowUniqueId,
                                    columnUniqueId: columnUniqueId,
                                    rect: this.getHeaderCellRect(row.rowUniqueId, columnUniqueId)
                                });

                                renderedHeaderCells[columnUniqueId].state = 2 /* Painted */;
                                painted = true;
                            }
                        }

                        if (painted) {
                            return true;
                        }
                    }
                };

                StackView.prototype._removeCellWorker = function (context) {
                    for (var rowUniqueId in context.renderedRows) {
                        rowUniqueId = rowUniqueId;
                        var row = this._runtime.getRowByUniqueId(rowUniqueId);

                        if (!row) {
                            // In the case a row has been deleted from stack
                            var rowElement = context.renderedRows[rowUniqueId].rowElement;

                            if (rowElement) {
                                rowElement.remove();
                            }

                            delete context.renderedRows[rowUniqueId];
                            return true;
                        } else if (row.rowIndex &lt; this._renderRange.top() || row.rowIndex > this._renderRange.bottom()) {
                            // The row is not showed in the render area
                            var rowElement = context.renderedRows[rowUniqueId].rowElement;

                            if (rowElement) {
                                rowElement.remove();
                            }

                            delete context.renderedRows[rowUniqueId];
                            return true;
                        } else {
                            var renderedCells = context.renderedRows[rowUniqueId].renderedCells;
                            var renderedHeaderCells = context.renderedRows[rowUniqueId].renderedHeaderCells;
                            var removed = false;

                            for (var columnUniqueId in renderedCells) {
                                columnUniqueId = columnUniqueId;
                                var columnIndex = this._visibleColumnMap.indexOf(columnUniqueId);

                                if (columnIndex &lt; this._renderRange.front() || columnIndex > this._renderRange.end()) {
                                    var cellContentElement = renderedCells[columnUniqueId].cellContentElement;

                                    if (cellContentElement) {
                                        $(cellContentElement).parent().remove();
                                    }

                                    delete renderedCells[columnUniqueId];

                                    var headerCellContentElement = renderedHeaderCells[columnUniqueId].headerCellContentElement;

                                    if (headerCellContentElement) {
                                        $(headerCellContentElement).parent().remove();
                                    }

                                    delete renderedHeaderCells[columnUniqueId];
                                    removed = true;
                                }
                            }

                            if (removed) {
                                return true;
                            }
                        }
                    }
                };
                StackView.MainCanvasIndex = 1;
                StackView.DefaultColumnHeight = 16;
                return StackView;
            })();

            var Operator = (function () {
                function Operator() {
                    var _this = this;
                    this.disposer = new Controls.Fundamental.Disposer(function () {
                        return _this.stop();
                    });
                }
                Operator.prototype.start = function (name, operation) {
                    var _this = this;
                    var deferred = this._deferred = $.Deferred();

                    if (this._operation) {
                        deferred.reject();
                        return deferred.promise();
                    }

                    var args = Array.prototype.slice.call(arguments, 2);

                    this._operation = operation;
                    this._name = name;
                    this._operation.start.apply(this._operation, args).always(function () {
                        return _this._operation &amp;&amp; _this._operation.disposer.dispose();
                    }).done(function () {
                        return deferred.resolve.apply(deferred, arguments);
                    }).fail(function () {
                        return deferred.reject.apply(deferred, arguments);
                    }).always(function () {
                        return _this.stop();
                    });

                    return deferred.promise();
                };

                Operator.prototype.stop = function () {
                    if (this._operation) {
                        var operation = this._operation;

                        this._operation = null;
                        operation.disposer.dispose();

                        if (this._deferred) {
                            this._deferred.reject();
                        }
                    }

                    this._deferred = null;
                };

                Operator.prototype.name = function () {
                    return this._name;
                };

                Operator.prototype.dispose = function () {
                    this.disposer.dispose();
                };
                return Operator;
            })();
            Controls.Operator = Operator;

            var Theme = (function () {
                function Theme(options) {
                    this._options = new Support.PropertyBag(options);

                    this._inherit();
                    this._check();
                }
                Theme.parsePadding = function (text) {
                    var parts = text.split(' ');

                    if (parts.length != 4) {
                        throw Support.createError(0, 'Theme', 'cannot parse ' + text + ' as padding');
                    }

                    if (!this._checkPixelUnit(parts[0]) || !this._checkPixelUnit(parts[1]) || !this._checkPixelUnit(parts[2]) || !this._checkPixelUnit(parts[3])) {
                        throw Support.createError(0, 'Theme', 'padding can be in pixel only');
                    }

                    return {
                        top: parseInt(parts[0]),
                        end: parseInt(parts[1]),
                        bottom: parseInt(parts[2]),
                        front: parseInt(parts[3]),
                        raw: {
                            ltr: parts[0] + ' ' + parts[1] + ' ' + parts[2] + ' ' + parts[3],
                            rtl: parts[0] + ' ' + parts[3] + ' ' + parts[2] + ' ' + parts[1]
                        },
                        type: 'padding'
                    };
                };

                Theme.parseBorder = function (text) {
                    var parts = text.split(' ');

                    if (parts.length != 3) {
                        throw Support.createError(0, 'Theme', 'cannot parse ' + text + ' as border');
                    }

                    if (!/^\d+px$/.test(parts[1])) {
                        throw Support.createError(0, 'Theme', 'border width can be in pixel only');
                    }

                    return {
                        style: parts[0],
                        width: parseInt(parts[1]),
                        color: parts[2],
                        raw: text,
                        type: 'border'
                    };
                };

                Theme._checkPixelUnit = function (text) {
                    return /^\d+px$/.test(text);
                };

                Theme.prototype.value = function (name, value) {
                    return this._options.$property({
                        name: name,
                        args: Array.prototype.slice.apply(arguments, [1])
                    });
                };

                Theme.prototype._inherit = function () {
                    for (var i = 0; i &lt; Theme._inheritMap.length; i++) {
                        var map = Theme._inheritMap[i];

                        for (var j = 1; j &lt; map.length; j++) {
                            if (!this.value(map[j])) {
                                this.value(map[j], this.value(map[0]));
                            }
                        }
                    }
                };

                Theme.prototype._check = function () {
                    for (var name in this._options) {
                        if (Theme._validValueName.indexOf(name) &lt; 0) {
                            if (name == '$property') {
                                continue;
                            }

                            throw Support.createError(0, 'Theme', name + ' is invalid');
                        }
                    }

                    for (var i = 0; i &lt; Theme._validValueName.length; i++) {
                        var name = Theme._validValueName[i];
                        if (typeof (this._options[name]) == 'undefined') {
                            throw Support.createError(0, 'Theme', 'missing ' + name);
                        }
                    }
                };
                Theme._inheritMap = [
                    ['cellPadding', 'headerCellPadding'],
                    ['cellPadding', 'table.cellPadding', 'stack.cellPadding'],
                    ['headerCellPadding', 'table.headerCellPadding', 'stack.headerCellPadding'],
                    ['backgroundColor', 'rowBackgroundColor'],
                    ['rowBackgroundColor', 'headerRowBackgroundColor', 'alternateRowBackgroundColor'],
                    ['rowBackgroundColor', 'table.evenRowBackgroundColor', 'stack.evenRowBackgroundColor'],
                    ['alternateRowBackgroundColor', 'table.oddRowBackgroundColor', 'stack.oddRowBackgroundColor'],
                    ['headerRowBackgroundColor', 'table.headerRowBackgroundColor'],
                    ['cellFontFamily', 'headerCellFontFamily'],
                    ['cellFontSize', 'headerCellFontSize'],
                    ['cellFontFamily', 'table.cellFontFamily', 'stack.cellFontFamily'],
                    ['cellFontSize', 'table.cellFontSize', 'stack.cellFontSize'],
                    ['headerCellFontFamily', 'table.headerCellFontFamily', 'stack.headerCellFontFamily'],
                    ['headerCellFontSize', 'table.headerCellFontSize', 'stack.headerCellFontSize'],
                    ['cellColor', 'table.cellColor', 'stack.cellColor'],
                    ['headerCellColor', 'table.headerCellColor', 'stack.headerCellColor']
                ];

                Theme._validValueName = [
                    'backgroundColor',
                    'rowBackgroundColor',
                    'alternateRowBackgroundColor',
                    'cellColor',
                    'cellFontFamily',
                    'cellPadding',
                    'headerRowBackgroundColor',
                    'headerCellColor',
                    'headerCellFontFamily',
                    'headerCellFontSize',
                    'headerCellPadding',
                    'hoverBackgroundColor',
                    'selectionBackgroundColor',
                    'cellFontSize',
                    'stack.oddRowBackgroundColor',
                    'stack.evenRowBackgroundColor',
                    'stack.cellColor',
                    'stack.cellCursor',
                    'stack.cellFontFamily',
                    'stack.cellFontSize',
                    'stack.cellHBorder',
                    'stack.cellHeight',
                    'stack.cellPadding',
                    'stack.headerCellColor',
                    'stack.headerCellPadding',
                    'stack.headerCursor',
                    'stack.headerEndBorder',
                    'stack.headerCellFontFamily',
                    'stack.headerCellFontSize',
                    'stack.headerHBorder',
                    'stack.rowBorder',
                    'stack.rowPadding',
                    'table.oddRowBackgroundColor',
                    'table.evenRowBackgroundColor',
                    'table.cellColor',
                    'table.cellCursor',
                    'table.cellFontFamily',
                    'table.cellFontSize',
                    'table.cellHBorder',
                    'table.cellPadding',
                    'table.cellVBorder',
                    'table.cellWidth',
                    'table.cursorBorder',
                    'table.headerBottomBorder',
                    'table.headerRowBackgroundColor',
                    'table.headerCellColor',
                    'table.headerCellPadding',
                    'table.headerCellVBorder',
                    'table.headerCursor',
                    'table.headerCellFontFamily',
                    'table.headerCellFontSize',
                    'table.headerRowHeight',
                    'table.rowHeight',
                    'table.canvasEndMargin',
                    'table.canvasBottomMargin',
                    'stack.selectionIndicatorWidth',
                    'stack.selectionIndicatorPadding'
                ];

                Theme.Default = new Theme({
                    'backgroundColor': '#ffffff',
                    'hoverBackgroundColor': '#fcfcfc',
                    'selectionBackgroundColor': '#cde6f7',
                    'cellPadding': Theme.parsePadding('1px 5px 1px 5px'),
                    'cellFontFamily': '"Segoe UI Web Semilight", "Segoe UI Semilight", "Segoe WP Semilight", "Segoe UI", "Segoe WP", Tahoma, Arial, sans-serif',
                    'cellFontSize': '16px',
                    'cellColor': '#666666',
                    'headerCellColor': '#333333',
                    'headerCellFontSize': '16px',
                    'rowBackgroundColor': 'transparent',
                    'alternateRowBackgroundColor': '#f2f2f2',
                    'stack.cellCursor': 'pointer',
                    'stack.cellHBorder': Theme.parseBorder('solid 1px #cccccc'),
                    'stack.cellHeight': 32,
                    'stack.headerCursor': 'pointer',
                    'stack.selectionIndicatorWidth': 16,
                    'stack.selectionIndicatorPadding': Theme.parsePadding('4px 3px 4px 5px'),
                    'stack.headerCellFontFamily': '"Segoe UI Web Semilight", "Segoe UI Semilight", "Segoe WP Semilight", "Segoe UI", "Segoe WP", Tahoma, Arial, sans-serif',
                    'stack.headerEndBorder': Theme.parseBorder('solid 1px #cccccc'),
                    'stack.headerHBorder': Theme.parseBorder('solid 1px #cccccc'),
                    'stack.rowBorder': Theme.parseBorder('solid 1px #cccccc'),
                    'stack.rowPadding': Theme.parsePadding('5px 3px 5px 3px'),
                    'table.cellCursor': 'cell',
                    'table.cellHBorder': Theme.parseBorder('solid 1px transparent'),
                    'table.cellVBorder': Theme.parseBorder('solid 1px transparent'),
                    'table.cellWidth': 100,
                    'table.cursorBorder': Theme.parseBorder('none 0px transparent'),
                    'table.headerBottomBorder': Theme.parseBorder('solid 1px #eaeaea'),
                    'table.headerCellPadding': Theme.parsePadding('1px 1px 1px 5px'),
                    'table.headerCellVBorder': Theme.parseBorder('solid 1px #eaeaea'),
                    'table.headerCursor': 'pointer',
                    'table.headerCellFontFamily': '"Segoe UI Semibold", "Segoe UI Web Semibold", "Segoe UI Web Semilight", "Segoe UI Semilight", "Segoe WP Semilight", "Segoe UI", "Segoe WP", Tahoma, Arial, sans-serif',
                    'table.headerRowHeight': 32,
                    'table.rowHeight': 34,
                    'table.canvasEndMargin': 0,
                    'table.canvasBottomMargin': 0
                });

                Theme.Zebra = new Theme({
                    'backgroundColor': '#deb887',
                    'hoverBackgroundColor': '#eee9bf',
                    'selectionBackgroundColor': '#ffd700',
                    'cellPadding': Theme.parsePadding('2px 6px 2px 6px'),
                    'cellFontFamily': '"Segoe UI Web Semilight", "Segoe UI Semilight", "Segoe WP Semilight", "Segoe UI", "Segoe WP", Tahoma, Arial, sans-serif',
                    'cellColor': '#666666',
                    'cellFontSize': '13pt',
                    'headerCellColor': '#333333',
                    'headerCellFontSize': '13pt',
                    'stack.cellCursor': 'pointer',
                    'stack.cellFontFamily': '"Segoe UI Web Semilight", "Segoe UI Semilight", "Segoe WP Semilight", "Segoe UI", "Segoe WP", Tahoma, Arial, sans-serif',
                    'stack.selectionIndicatorWidth': 26,
                    'stack.selectionIndicatorPadding': Theme.parsePadding('10px 6px 10px 10px'),
                    'stack.cellHBorder': Theme.parseBorder('solid 1px #cccccc'),
                    'stack.cellHeight': 30,
                    'stack.headerCursor': 'pointer',
                    'stack.headerCellFontFamily': '"Segoe UI Web Semilight", "Segoe UI Semilight", "Segoe WP Semilight", "Segoe UI", "Segoe WP", Tahoma, Arial, sans-serif',
                    'stack.headerHBorder': Theme.parseBorder('solid 1px #ffebcd'),
                    'stack.headerEndBorder': Theme.parseBorder('solid 1px transparent'),
                    'stack.rowBorder': Theme.parseBorder('solid 1px #cd8500'),
                    'stack.rowPadding': Theme.parsePadding('8px 3px 8px 3px'),
                    'table.cellCursor': 'cell',
                    'table.cellFontFamily': '"Segoe UI Web Semilight", "Segoe UI Semilight", "Segoe WP Semilight", "Segoe UI", "Segoe WP", Tahoma, Arial, sans-serif',
                    'table.cellHBorder': Theme.parseBorder('solid 2px #cd8500'),
                    'table.cellVBorder': Theme.parseBorder('solid 2px #ffebcd'),
                    'table.cellWidth': 150,
                    'table.cursorBorder': Theme.parseBorder('dashed 2px #ffa500'),
                    'table.headerBottomBorder': Theme.parseBorder('solid 2px #cd8500'),
                    'table.headerCellVBorder': Theme.parseBorder('solid 2px #cd8500'),
                    'table.headerCursor': 'pointer',
                    'table.headerCellFontFamily': '"Segoe UI Web Semilight", "Segoe UI Semilight", "Segoe WP Semilight", "Segoe UI", "Segoe WP", Tahoma, Arial, sans-serif',
                    'table.headerRowHeight': 28,
                    'table.rowHeight': 30,
                    'table.canvasEndMargin': 300,
                    'table.canvasBottomMargin': 300
                });
                return Theme;
            })();
            Controls.Theme = Theme;

            var SimpleTextHeaderRender = (function () {
                function SimpleTextHeaderRender(getter, alignToEnd) {
                    if (typeof getter === "undefined") { getter = null; }
                    if (typeof alignToEnd === "undefined") { alignToEnd = false; }
                    this._getter = getter;
                    this._alignToEnd = alignToEnd;
                }
                SimpleTextHeaderRender.prototype.title = function (args) {
                    return this._getValue(args);
                };

                SimpleTextHeaderRender.prototype.render = function (args) {
                    var value = this._getValue(args);

                    args.element.textContent = value;
                    $(args.element).attr('title', value);

                    var align;

                    if (this._alignToEnd &amp;&amp; args.view != 1 /* Stack */) {
                        align = args.rtl ? 'left' : 'right';
                    } else {
                        align = args.rtl ? 'right' : 'left';
                    }

                    $(args.element).css('text-align', align);
                };

                SimpleTextHeaderRender.prototype._getValue = function (args) {
                    if (this._getter) {
                        return this._getter({
                            data: args.data
                        });
                    } else {
                        return args.data;
                    }
                };
                return SimpleTextHeaderRender;
            })();
            Controls.SimpleTextHeaderRender = SimpleTextHeaderRender;

            var SimpleTextCellRender = (function () {
                function SimpleTextCellRender(getter, alignToEnd) {
                    if (typeof getter === "undefined") { getter = null; }
                    if (typeof alignToEnd === "undefined") { alignToEnd = false; }
                    this._getter = getter;
                    this._alignToEnd = alignToEnd;
                }
                SimpleTextCellRender.prototype.title = function (args) {
                    return this._getValue(args);
                };

                SimpleTextCellRender.prototype.render = function (args) {
                    var value = this._getValue(args);

                    if (typeof (value) != undefined &amp;&amp; value != null &amp;&amp; value !== '') {
                        args.element.textContent = value;
                        args.element.setAttribute('title', value);

                        if (this._alignToEnd &amp;&amp; args.view != 1 /* Stack */) {
                            args.element.style.textAlign = args.rtl ? 'left' : 'right';
                        }
                    }
                };

                SimpleTextCellRender.prototype._getValue = function (args) {
                    if (this._getter) {
                        return this._getter({
                            rowData: args.rowData,
                            cellData: args.cellData
                        });
                    } else {
                        return args.cellData;
                    }
                };
                return SimpleTextCellRender;
            })();
            Controls.SimpleTextCellRender = SimpleTextCellRender;

            var SimpleTextCellEditor = (function () {
                function SimpleTextCellEditor() {
                }
                SimpleTextCellEditor.prototype.edit = function (args) {
                    var element = args.element, accept = args.accept, reject = args.reject, width = args.width, height = args.height, row = args.row, cellData = args.cellData, rtl = args.rtl, disposer = new Controls.Fundamental.Disposer();

                    var input = $('&lt;input style="position:absolute; left: 0px; top: 0px; width: 100%; height: 100%; border: 0px; outline: 0px;">&lt;/input>');

                    $(element).append(input);
                    input.val(cellData);
                    input.focus();

                    disposer.addDisposable(new Support.EventAttacher(input, 'focusout', function () {
                        disposer.dispose();
                        accept(input.val());
                    }));

                    disposer.addDisposable(new Support.EventAttacher(input, 'keydown', function (event) {
                        if (event.which == 27) {
                            disposer.dispose();
                            reject();
                        }
                    }));
                };
                return SimpleTextCellEditor;
            })();
            Controls.SimpleTextCellEditor = SimpleTextCellEditor;

            var SimpleCellEditor = (function () {
                function SimpleCellEditor(externalEditor, keepHeight, keepWidth) {
                    this._externalEditor = externalEditor;
                    this._keepWidth = keepWidth || 0;
                    this._keepHeight = keepHeight || 0;
                }
                SimpleCellEditor.prototype.edit = function (args) {
                    var _this = this;
                    var element = args.element, events = args.events, row = args.row, rtl = args.rtl, width = args.width, height = args.height, cellData = args.cellData;

                    if (this._keepWidth || this._keepWidth) {
                        window.setTimeout(function () {
                            return args.keepRect(_this._keepHeight, _this._keepWidth);
                        }, 150);
                    }

                    this._externalEditor({
                        element: element,
                        cellData: cellData,
                        row: row,
                        rtl: rtl
                    }).done(function (value) {
                        return events.emit('accept', _this, value);
                    }).fail(function () {
                        return events.emit('reject', _this, null);
                    });
                };
                return SimpleCellEditor;
            })();
            Controls.SimpleCellEditor = SimpleCellEditor;

            var Range = (function () {
                function Range(type, top, bottom, front, end) {
                    if (isNaN(top) || isNaN(bottom) || type == 1 /* Column */) {
                        top = bottom = NaN;
                    } else if (bottom &lt; top) {
                        var t = bottom;

                        bottom = top;
                        top = t;
                    }

                    if (top &lt; 0) {
                        top = bottom = NaN;
                    }

                    if (isNaN(front) || isNaN(end) || type == 0 /* Row */) {
                        front = end = NaN;
                    } else if (end &lt; front) {
                        var f = end;

                        end = front;
                        front = f;
                    }

                    if (front &lt; 0) {
                        front = end = NaN;
                    }

                    if (type == 2 /* Range */) {
                        if (isNaN(front) || isNaN(top)) {
                            front = end = top = bottom = NaN;
                        }
                    }

                    this._options = {
                        type: type,
                        top: top,
                        bottom: bottom,
                        front: front,
                        end: end
                    };
                }
                Range.prototype.isValid = function () {
                    return !isNaN(this.top()) || !isNaN(this.front());
                };

                Range.prototype.type = function () {
                    return this._options.type;
                };

                Range.prototype.top = function () {
                    return this._options.top;
                };

                Range.prototype.bottom = function () {
                    return this._options.bottom;
                };

                Range.prototype.front = function () {
                    return this._options.front;
                };

                Range.prototype.end = function () {
                    return this._options.end;
                };

                Range.prototype.rowCount = function () {
                    if (this._options.type == 1 /* Column */) {
                        return NaN;
                    }
                    return this._options.bottom - this._options.top + 1;
                };

                Range.prototype.columnCount = function () {
                    if (this._options.type == 0 /* Row */) {
                        return NaN;
                    }
                    return this._options.end - this._options.front + 1;
                };

                Range.prototype.equals = function (range) {
                    if (!range) {
                        return false;
                    }

                    if (!!this.isValid() != !!range.isValid()) {
                        return false;
                    }

                    if (this._options.type != range._options.type) {
                        return false;
                    }

                    return this._options.top == range._options.top &amp;&amp; this._options.bottom == range._options.bottom &amp;&amp; this._options.front == range._options.front &amp;&amp; this._options.end == range._options.end;
                };

                Range.compare = function (range0, range1) {
                    switch (range0.type()) {
                        case 0 /* Row */:
                            return Support.Calculator.compareValueArray([range0.type(), range0.top(), range0.bottom()], [range1.type(), range1.top(), range1.bottom()]);

                        case 1 /* Column */:
                            return Support.Calculator.compareValueArray([range0.type(), range0.front(), range0.end()], [range1.type(), range1.front(), range1.end()]);

                        case 2 /* Range */:
                            return Support.Calculator.compareValueArray([range0.type(), range0.top(), range0.front(), range0.bottom(), range0.end()], [range1.type(), range0.top(), range1.front(), range1.bottom(), range1.end()]);
                    }
                };

                Range.intersection = function (range0, range1) {
                    var type0 = range0.type(), type1 = range1.type();

                    if (type0 == type1) {
                        if (type0 == 0 /* Row */) {
                            var intersection = Support.Calculator.intersection(range0.top(), range0.bottom(), range1.top(), range1.bottom());

                            if (intersection) {
                                return new Range(0 /* Row */, intersection.lower, intersection.upper, NaN, NaN);
                            }
                        } else if (type0 == 1 /* Column */) {
                            var intersection = Support.Calculator.intersection(range0.front(), range0.end(), range1.front(), range1.end());

                            if (intersection) {
                                return new Range(1 /* Column */, NaN, NaN, intersection.lower, intersection.upper);
                            }
                        } else if (type0 == 2 /* Range */) {
                            var intersectionRow = Support.Calculator.intersection(range0.top(), range0.bottom(), range1.top(), range1.bottom());
                            var intersectionColumn = Support.Calculator.intersection(range0.front(), range0.end(), range1.front(), range1.end());

                            if (intersectionRow &amp;&amp; intersectionColumn) {
                                return new Range(2 /* Range */, intersectionRow.lower, intersectionRow.upper, intersectionColumn.lower, intersectionColumn.upper);
                            }
                        }
                    } else if (type0 == 2 /* Range */ || type1 == 2 /* Range */) {
                        if (type0 == 2 /* Range */) {
                            var r = range0, range0 = range1, range1 = r, t = type0, type0 = type1, type1 = t;
                        }

                        if (type0 == 0 /* Row */) {
                            var intersection = Support.Calculator.intersection(range0.top(), range0.bottom(), range1.top(), range1.bottom());

                            if (intersection) {
                                return new Range(2 /* Range */, intersection.lower, intersection.upper, range1.front(), range1.end());
                            }
                        } else {
                            var intersection = Support.Calculator.intersection(range0.front(), range0.end(), range1.front(), range1.end());

                            if (intersection) {
                                return new Range(2 /* Range */, range1.top(), range1.bottom(), intersection.lower, intersection.upper);
                            }
                        }
                    }
                };

                Range.union = function (range0, range1) {
                    var type0 = range0.type(), type1 = range1.type();

                    if (type0 == type1) {
                        if (type0 == 0 /* Row */) {
                            var union = Support.Calculator.union(range0.top(), range0.bottom() + 1, range1.top(), range1.bottom() + 1);

                            if (union) {
                                return new Range(0 /* Row */, union.lower, union.upper - 1, NaN, NaN);
                            }
                        } else if (type0 == 1 /* Column */) {
                            var union = Support.Calculator.union(range0.front(), range0.end() + 1, range1.front(), range1.end() + 1);

                            if (union) {
                                return new Range(1 /* Column */, NaN, NaN, union.lower, union.upper - 1);
                            }
                        }
                    }
                };

                Range.moveInto = function (restriction, range) {
                };
                Range.Null = new Range(2 /* Range */, NaN, NaN, NaN, NaN);
                return Range;
            })();
            Controls.Range = Range;

            var Position = (function () {
                function Position(rowIndex, columnIndex) {
                    this.rowIndex = rowIndex;
                    this.columnIndex = columnIndex;
                }
                Position.prototype.isValid = function () {
                    return !isNaN(this.rowIndex) &amp;&amp; !isNaN(this.columnIndex);
                };

                Position.prototype.equals = function (cursor) {
                    if (!this.isValid() &amp;&amp; !cursor.isValid()) {
                        return true;
                    }

                    return this.rowIndex == cursor.rowIndex &amp;&amp; this.columnIndex == cursor.columnIndex;
                };
                Position.Null = new Position(NaN, NaN);
                return Position;
            })();
            Controls.Position = Position;

            var Selection = (function () {
                function Selection(selectionMode) {
                    if (typeof selectionMode === "undefined") { selectionMode = 0 /* SingleRow */; }
                    this.disposer = new Controls.Fundamental.Disposer();
                    this._options = new Support.PropertyBag({
                        ranges: [],
                        rowCount: 0,
                        columnCount: 0,
                        selectionMode: selectionMode,
                        cursor: Position.Null
                    });
                    this.disposer.addDisposable(this._events = new Support.EventSite());
                    this.disposer.addDisposable(this._updaters = new Support.UpdaterGroup());
                    this._updaters.add(this._getSelectionChangeUpdater());
                    this._updaters.add(this._getCursorChangeUpdater());
                    this._updaters.update();
                }
                Selection.prototype.dispose = function () {
                    this.disposer.dispose();
                };

                Selection.prototype.on = function () {
                    return this._events.on.apply(this._events, arguments);
                };

                Selection.prototype.off = function () {
                    return this._events.off.apply(this._events, arguments);
                };

                Selection.prototype.ranges = function () {
                    return this._options.ranges;
                };

                Selection.prototype.rowCount = function () {
                    var _this = this;
                    return this._options.$property({
                        name: 'rowCount',
                        args: arguments,
                        afterChange: function () {
                            _this._options.ranges = _this._normalize(_this._options.ranges);

                            if (!_this._options.ranges) {
                                _this._options.ranges = [];
                            }

                            _this._options.cursor = _this._normalizeCursor(_this._options.cursor);
                            _this._ensureSingleSelection();
                            _this._updaters.update();
                        }
                    });
                };

                Selection.prototype.columnCount = function () {
                    var _this = this;
                    return this._options.$property({
                        name: 'columnCount',
                        args: arguments,
                        afterChange: function () {
                            _this._options.ranges = _this._normalize(_this._options.ranges);

                            if (!_this._options.ranges) {
                                _this._options.ranges = [];
                            }

                            _this._options.cursor = _this._normalizeCursor(_this._options.cursor);
                            _this._ensureSingleSelection();
                            _this._updaters.update();
                        }
                    });
                };

                Selection.prototype.cursor = function () {
                    var _this = this;
                    return this._options.$property({
                        name: 'cursor',
                        args: arguments,
                        beforeChange: function (sender, args) {
                            args.newValue = _this._normalizeCursor(args.newValue);

                            if (args.newValue.equals(args.oldValue)) {
                                args.cancel = true;
                            }
                        },
                        afterChange: function () {
                            _this._ensureSingleSelection();
                            _this._updaters.update();
                        }
                    });
                };

                Selection.prototype.rangeOfCursor = function () {
                    return this.rangeOfPosition(this._options.cursor);
                };

                Selection.prototype.rangeOfPosition = function (position) {
                    for (var index = 0; index &lt; this._options.ranges.length; index++) {
                        var range = this._options.ranges[index];

                        switch (range.type()) {
                            case 0 /* Row */:
                                if (position.rowIndex >= range.top() &amp;&amp; position.rowIndex &lt;= range.bottom()) {
                                    return range;
                                }
                                break;

                            case 1 /* Column */:
                                if (position.columnIndex >= range.front() &amp;&amp; position.columnIndex &lt;= range.end()) {
                                    return range;
                                }
                                break;

                            case 2 /* Range */:
                                if (position.rowIndex >= range.top() &amp;&amp; position.rowIndex &lt;= range.bottom() &amp;&amp; position.columnIndex >= range.front() &amp;&amp; position.columnIndex &lt;= range.end()) {
                                    return range;
                                }
                                break;
                        }
                    }
                };

                Selection.prototype.moveCursor = function (cursorMovement, pageRange) {
                    if (!this._options.cursor.isValid() || this._options.rowCount == 0 || this._options.columnCount == 0) {
                        return Position.Null;
                    }

                    var rowIndex = this._options.cursor.rowIndex, columnIndex = this._options.cursor.columnIndex;

                    switch (cursorMovement) {
                        case 0 /* Forward */:
                            columnIndex++;
                            break;

                        case 1 /* Backward */:
                            columnIndex--;
                            break;

                        case 2 /* Up */:
                            rowIndex--;
                            break;

                        case 3 /* Down */:
                            rowIndex++;
                            break;

                        case 4 /* LineFirst */:
                            columnIndex = 0;
                            break;

                        case 5 /* LineEnd */:
                            columnIndex = this._options.columnCount - 1;
                            break;

                        case 6 /* PageUp */:
                            break;

                        case 7 /* PageDown */:
                            break;

                        case 8 /* Top */:
                            rowIndex = 0;
                            break;

                        case 9 /* Bottom */:
                            rowIndex = this._options.rowCount - 1;
                            break;
                    }

                    return this._normalizeCursor(new Position(rowIndex, columnIndex));
                };

                Selection.prototype.remove = function (range) {
                    if (this._options.ranges.length == 0) {
                        return;
                    }

                    var ranges = this._normalize([range]);

                    if (!ranges) {
                        return;
                    }

                    range = ranges[0];

                    switch (range.type()) {
                        case 0 /* Row */:
                            this._removeRows(range);
                            break;

                        case 1 /* Column */:
                            this._removeColumns(range);
                            break;
                    }

                    this._options.ranges.sort(Range.compare);
                    this._updaters.update();
                };

                Selection.prototype.insert = function (range) {
                    if (this._options.ranges.length == 0) {
                        return;
                    }

                    if (!range.isValid()) {
                        return;
                    }

                    switch (range.type()) {
                        case 0 /* Row */:
                            if (range.top() &lt;= this._options.rowCount) {
                                this._insertRows(range);
                            }
                            break;

                        case 1 /* Column */:
                            if (range.front() &lt;= this._options.columnCount) {
                                this._insertColumns(range);
                            }
                            break;
                    }

                    this._options.ranges.sort(Range.compare);
                    this._updaters.update();
                };

                Selection.prototype.deselect = function (range) {
                    if (this._options.selectionMode == 0 /* SingleRow */ || this._options.selectionMode == 2 /* Cell */) {
                        throw Support.createError(0, 'Selection', 'Deny to deselect in current mode, move cursor instead');
                    }
                    if (this._options.ranges.length == 0) {
                        return;
                    }

                    var ranges = this._normalize([range]);

                    if (!ranges) {
                        return;
                    }

                    range = ranges[0];

                    switch (range.type()) {
                        case 0 /* Row */:
                            this._deselectRow(range);
                            break;

                        case 1 /* Column */:
                            this._deselectColumn(range);
                            break;

                        case 2 /* Range */:
                            switch (this._options.ranges[0].type()) {
                                case 0 /* Row */:
                                    this._deselectRow(range);
                                    break;

                                case 1 /* Column */:
                                    this._deselectColumn(range);
                                    break;

                                case 2 /* Range */:
                                    for (var index = 0; index &lt; this._options.ranges.length; index++) {
                                        if (this._options.ranges[index].equals(range)) {
                                            this._options.ranges.splice(index, 1);
                                            return;
                                        }
                                    }
                                    break;
                            }
                            break;
                    }

                    this._options.ranges.sort(Range.compare);
                    this._updaters.update();
                };

                Selection.prototype.select = function (range, keepSelectedRanges) {
                    if (typeof keepSelectedRanges === "undefined") { keepSelectedRanges = true; }
                    if (this._options.selectionMode == 0 /* SingleRow */ || this._options.selectionMode == 2 /* Cell */) {
                        throw Support.createError(0, 'Selection', 'Deny to select in current mode, move cursor instead');
                    }
                    var ranges = this._normalize([range]);

                    if (!ranges) {
                        return;
                    }

                    range = ranges[0];

                    if (!keepSelectedRanges) {
                        this._options.ranges = [];
                    }

                    switch (this._options.selectionMode) {
                        case 1 /* MultipleRows */:
                            if (range.type() != 0 /* Row */) {
                                throw Support.createError(0, 'Selection', 'invilidate range type [' + RangeType[range.type()] + ']');
                            }

                            this._merge(range);
                            break;

                        case 3 /* Range */:
                            if (this._options.ranges.length == 0 || this._options.ranges[this._options.ranges.length - 1].type() != range.type() || range.type() == 2 /* Range */) {
                                this._options.ranges = [range];
                            } else {
                                this._merge(range);
                            }
                            break;

                        case 2 /* Cell */:
                            if (range.type() != 2 /* Range */) {
                                throw Support.createError(0, 'Selection', 'invilidate range type [' + RangeType[range.type()] + ']');
                            }

                            if (range.rowCount() != 1 || range.columnCount() != 1) {
                                throw Support.createError(0, 'Selection', 'cannot select more than 1 cell');
                            }

                            this._options.ranges = [range];
                            break;
                    }

                    this._options.ranges.sort(Range.compare);
                    this._updaters.update();
                };

                Selection.prototype.clear = function () {
                    this._options.ranges = [];
                    this._ensureSingleSelection();
                    this._options.ranges.sort(Range.compare);
                    this._updaters.update();
                };

                Selection.prototype.selectionMode = function () {
                    var _this = this;
                    return this._options.$property({
                        name: 'selectionMode',
                        args: arguments,
                        afterChange: function () {
                            return _this.clear();
                        }
                    });
                };

                Selection.prototype.rowSelected = function (rowIndex) {
                    for (var i = 0; i &lt; this._options.ranges.length; i++) {
                        var range = this._options.ranges[i];

                        if (range.type() != 0 /* Row */) {
                            return false;
                        }

                        if (range.top() &lt;= rowIndex &amp;&amp; range.bottom() >= rowIndex) {
                            return true;
                        }
                    }
                    ;

                    return false;
                };

                Selection.prototype.clone = function () {
                    var clonedObject = new Selection(this._options.selection);

                    clonedObject._options.ranges = this._options.ranges.slice();
                    clonedObject._options.rowCount = this._options.rowCount;
                    clonedObject._options.columnCount = this._options.columnCount;
                    clonedObject._options.selectionMode = this._options.selectionMode;
                    return clonedObject;
                };

                Selection.prototype._removeRows = function (range) {
                    if (this._options.ranges.length == 0) {
                        return;
                    }

                    var removeTop = range.top(), removeBottom = range.bottom(), cursorRowIndex = this._options.cursor.rowIndex, result = [], count = removeBottom - removeTop + 1;

                    if (this._options.ranges[0].type() == 1 /* Column */) {
                        this._options.rowCount -= count;
                        return;
                    }

                    if (cursorRowIndex >= removeTop &amp;&amp; cursorRowIndex &lt;= removeBottom) {
                        if (removeBottom == this._options.rowCount - 1) {
                            this._options.cursor = new Position(removeTop - 1, this._options.cursor.columnIndex);
                        } else {
                            this._options.cursor = new Position(removeTop, this._options.cursor.columnIndex);
                        }
                    } else if (cursorRowIndex > removeBottom) {
                        this._options.cursor = new Position(cursorRowIndex - count, this._options.cursor.columnIndex);
                    }

                    if (this._options.rowCount > count) {
                        if (this._options.selectionMode == 1 /* MultipleRows */ || this._options.selectionMode == 3 /* Range */) {
                            for (var index = 0; index &lt; this._options.ranges.length; index++) {
                                var range = this._options.ranges[index], rangeTop = range.top(), rangeBottom = range.bottom();

                                if (rangeBottom &lt; removeTop) {
                                    result.push(range);
                                } else if (rangeTop > removeBottom) {
                                    result.push(new Range(range.type(), rangeTop - count, rangeBottom - count, range.front(), range.end()));
                                } else if (rangeTop >= removeTop &amp;&amp; rangeBottom &lt;= removeBottom) {
                                    continue;
                                } else if (rangeTop &lt; removeTop &amp;&amp; rangeBottom > removeBottom) {
                                    result.push(new Range(range.type(), rangeTop, rangeBottom - count, range.front(), range.end()));
                                } else if (rangeTop &lt; removeTop) {
                                    result.push(new Range(range.type(), rangeTop, removeTop - 1, range.front(), range.end()));
                                } else if (rangeBottom > removeBottom) {
                                    result.push(new Range(range.type(), removeTop, rangeBottom - count, range.front(), range.end()));
                                } else {
                                    throw Support.createError(0, 'Selection', 'error code path');
                                }
                            }
                        }
                    }

                    this._options.ranges = result;
                    this._ensureSingleSelection();
                    this._options.rowCount -= count;
                };

                Selection.prototype._removeColumns = function (range) {
                    if (this._options.ranges.length == 0) {
                        return;
                    }

                    var removeFront = range.front(), removeEnd = range.end(), cursorColumnIndex = this._options.cursor.columnIndex, result = [], count = removeEnd - removeFront + 1;

                    if (this._options.ranges[0].type() == 0 /* Row */) {
                        this._options.columnCount -= count;
                        return;
                    }

                    if (cursorColumnIndex >= removeFront &amp;&amp; cursorColumnIndex &lt;= removeEnd) {
                        if (removeEnd == this._options.columnCount - 1) {
                            this._options.cursor = new Position(this._options.cursor.rowIndex, removeFront - 1);
                        } else {
                            this._options.cursor = new Position(this._options.cursor.rowIndex, removeFront);
                        }
                    } else if (cursorColumnIndex > removeEnd) {
                        this._options.cursor = new Position(this._options.cursor.rowIndex, cursorColumnIndex - count);
                    }

                    if (this._options.rowCount > count) {
                        if (this._options.selectionMode == 1 /* MultipleRows */ || this._options.selectionMode == 3 /* Range */) {
                            for (var index = 0; index &lt; this._options.ranges.length; index++) {
                                var range = this._options.ranges[index], rangeFront = range.front(), rangeEnd = range.end();

                                if (rangeEnd &lt; removeFront) {
                                    result.push(range);
                                } else if (rangeFront > removeEnd) {
                                    result.push(new Range(range.type(), range.top(), range.bottom(), rangeFront - count, rangeEnd - count));
                                } else if (rangeFront >= removeFront &amp;&amp; rangeEnd &lt;= removeEnd) {
                                    continue;
                                } else if (rangeFront &lt; removeFront &amp;&amp; rangeEnd > removeEnd) {
                                    result.push(new Range(range.type(), range.top(), range.bottom(), rangeFront, rangeEnd - count));
                                } else if (rangeFront &lt; removeFront) {
                                    result.push(new Range(range.type(), range.top(), range.bottom(), rangeFront, removeFront - 1));
                                } else if (rangeEnd > removeEnd) {
                                    result.push(new Range(range.type(), range.top(), range.bottom(), removeEnd + 1, rangeEnd));
                                } else {
                                    throw Support.createError(0, 'Selection', 'error code path');
                                }
                            }
                        }
                    }

                    this._options.ranges = result;
                    this._ensureSingleSelection();
                    this._options.columnCount -= count;
                };

                Selection.prototype._insertRows = function (range) {
                    if (this._options.ranges.length == 0) {
                        return;
                    }

                    var insertTop = range.top(), insertBottom = range.bottom(), cursorRowIndex = this._options.cursor.rowIndex, result = [], count = insertBottom - insertTop + 1;

                    this._options.rowCount += count;

                    if (this._options.ranges[0].type() == 1 /* Column */) {
                        return;
                    }

                    if (cursorRowIndex >= insertTop) {
                        this._options.cursor = new Position(cursorRowIndex + count, this._options.cursor.columnIndex);
                    }

                    if (this._options.rowCount > count) {
                        if (this._options.selectionMode == 1 /* MultipleRows */ || this._options.selectionMode == 3 /* Range */) {
                            for (var index = 0; index &lt; this._options.ranges.length; index++) {
                                var range = this._options.ranges[index], rangeTop = range.top(), rangeBottom = range.bottom();

                                if (rangeBottom &lt; insertTop) {
                                    result.push(range);
                                } else if (rangeTop >= insertTop) {
                                    result.push(new Range(0 /* Row */, rangeTop + count, rangeBottom + count, range.front(), range.end()));
                                } else if (rangeTop &lt; insertTop &amp;&amp; rangeBottom >= insertTop) {
                                    result.push(new Range(0 /* Row */, rangeTop, rangeBottom + count, range.front(), range.end()));
                                } else {
                                    throw Support.createError(0, 'Selection', 'error code path');
                                }
                            }
                        }
                    }

                    this._options.ranges = result;
                    this._ensureSingleSelection();
                };

                Selection.prototype._insertColumns = function (range) {
                    if (this._options.ranges.length == 0) {
                        return;
                    }

                    var insertFront = range.front(), insertEnd = range.end(), cursorColumnIndex = this._options.cursor.columnIndex, result = [], count = insertEnd - insertFront + 1;

                    this._options.columnCount += count;

                    if (this._options.ranges[0].type() == 0 /* Row */) {
                        return;
                    }

                    if (cursorColumnIndex >= insertFront) {
                        this._options.cursor = new Position(this._options.cursor.rowIndex, cursorColumnIndex + count);
                    }

                    if (this._options.columnCount > count) {
                        if (this._options.selectionMode == 1 /* MultipleRows */ || this._options.selectionMode == 3 /* Range */) {
                            for (var index = 0; index &lt; this._options.ranges.length; index++) {
                                var range = this._options.ranges[index], rangeFront = range.front(), rangeEnd = range.end();

                                if (rangeEnd &lt; insertFront) {
                                    result.push(range);
                                } else if (rangeFront >= insertFront) {
                                    result.push(new Range(1 /* Column */, range.top(), range.bottom(), rangeFront + count, rangeEnd + count));
                                } else if (rangeFront &lt; insertFront &amp;&amp; rangeEnd >= insertFront) {
                                    result.push(new Range(1 /* Column */, range.top(), range.bottom(), rangeFront, rangeEnd + count));
                                } else {
                                    throw Support.createError(0, 'Selection', 'error code path');
                                }
                            }
                        }
                    }

                    this._options.ranges = result;
                    this._ensureSingleSelection();
                };

                Selection.prototype._deselectRow = function (range) {
                    if (range.type() != 0 /* Row */) {
                        throw Support.createError(0, 'Selection', 'cannot deselect range with type [' + RangeType[range.type()] + ']');
                    }

                    var result = [], deselectTop = range.top(), deselectBottom = range.bottom();

                    for (var index = 0; index &lt; this._options.ranges.length; index++) {
                        var range = this._options.ranges[index], rangeTop = range.top(), rangeBottom = range.bottom();

                        if (rangeTop > deselectBottom || rangeBottom &lt; deselectTop) {
                            result.push(range);
                            continue;
                        } else if (rangeTop >= deselectTop &amp;&amp; rangeBottom &lt;= deselectBottom) {
                            continue;
                        } else if (rangeTop &lt; deselectTop &amp;&amp; rangeBottom > deselectBottom) {
                            result.push(new Range(0 /* Row */, rangeTop, deselectTop - 1, NaN, NaN));
                            result.push(new Range(0 /* Row */, deselectBottom + 1, rangeBottom, NaN, NaN));
                        } else if (rangeTop &lt; deselectTop) {
                            result.push(new Range(0 /* Row */, rangeTop, deselectTop - 1, NaN, NaN));
                        } else if (rangeBottom > deselectBottom) {
                            result.push(new Range(0 /* Row */, deselectBottom + 1, rangeBottom, NaN, NaN));
                        } else {
                            throw Support.createError(0, 'Selection', 'error code path');
                        }
                    }

                    this._options.ranges = result;
                };

                Selection.prototype._deselectColumn = function (range) {
                    if (range.type() != 1 /* Column */) {
                        throw Support.createError(0, 'Selection', 'cannot deselect range with type [' + RangeType[range.type()] + ']');
                    }

                    var result = [], deselectFront = range.front(), deselectEnd = range.end();

                    for (var index = 0; index &lt; this._options.ranges.length; index++) {
                        var range = this._options.ranges[index], rangeFront = range.front(), rangeEnd = range.end();

                        if (rangeFront > deselectFront || rangeEnd &lt; deselectEnd) {
                            result.push(range);
                            continue;
                        } else if (rangeFront >= deselectFront &amp;&amp; rangeEnd &lt;= deselectEnd) {
                            continue;
                        } else if (rangeFront &lt; deselectFront &amp;&amp; rangeEnd > deselectEnd) {
                            result.push(new Range(1 /* Column */, NaN, NaN, rangeFront, deselectFront - 1));
                            result.push(new Range(1 /* Column */, NaN, NaN, deselectEnd + 1, rangeEnd));
                        } else if (rangeFront &lt; deselectFront) {
                            result.push(new Range(1 /* Column */, NaN, NaN, rangeFront, deselectFront - 1));
                        } else if (rangeEnd > deselectEnd) {
                            result.push(new Range(1 /* Column */, NaN, NaN, deselectEnd + 1, rangeEnd));
                        } else {
                            throw Support.createError(0, 'Selection', 'error code path');
                        }
                    }

                    this._options.ranges = result;
                };

                Selection.prototype._normalizeCursor = function (cursor) {
                    if (this._options.rowCount == 0 || this._options.columnCount == 0) {
                        return Position.Null;
                    }

                    if (cursor.rowIndex &lt; this._options.rowCount &amp;&amp; cursor.columnCount &lt; this._options.columnCount) {
                        return cursor;
                    }

                    var rowIndex = cursor.rowIndex >= 0 &amp;&amp; !isNaN(cursor.rowIndex) ? cursor.rowIndex : 0, columnIndex = cursor.columnIndex >= 0 &amp;&amp; !isNaN(cursor.columnIndex) ? cursor.columnIndex : 0;

                    return new Position(Math.min(rowIndex, this._options.rowCount - 1), Math.min(columnIndex, this._options.columnCount - 1));
                };

                Selection.prototype._normalize = function (ranges) {
                    if (this._options.rowCount == 0 || this._options.columnCount == 0) {
                        return;
                    }

                    var result = [];

                    for (var index = 0; index &lt; ranges.length; index++) {
                        var range = ranges[index];

                        switch (range.type()) {
                            case 0 /* Row */:
                                if (range.top() >= this._options.rowCount) {
                                    continue;
                                } else if (range.bottom() &lt; this._options.rowCount) {
                                    result.push(range);
                                } else {
                                    result.push(new Range(0 /* Row */, range.top(), this._options.rowCount - 1, NaN, NaN));
                                }
                                break;

                            case 1 /* Column */:
                                if (range.front() >= this._options.columnCount) {
                                    continue;
                                } else if (range.end() &lt; this._options.columnCount) {
                                    result.push(range);
                                } else {
                                    result.push(new Range(1 /* Column */, NaN, NaN, range.front(), this._options.columnCount - 1));
                                }
                                break;

                            case 2 /* Range */:
                                if (range.top() >= this._options.rowCount || range.front() >= this._options.columnCount) {
                                    continue;
                                } else if (range.bottom() &lt; this._options.rowCount &amp;&amp; range.end() &lt; this._options.columnCount) {
                                    result.push(range);
                                } else {
                                    result.push(new Range(2 /* Range */, range.top(), Math.min(range.bottom(), this._options.rowCount - 1), range.front(), Math.min(range.end(), this._options.columnCount - 1)));
                                }
                                break;
                        }
                    }
                    return result.length ? result : null;
                };

                Selection.prototype._merge = function (range) {
                    var merged = true;

                    while (merged) {
                        merged = false;

                        for (var i = 0; i &lt; this._options.ranges.length; i++) {
                            var union = Range.union(this._options.ranges[i], range);

                            if (union) {
                                this._options.ranges.splice(i, 1);
                                range = union;
                                merged = true;
                                break;
                            }
                        }
                    }

                    this._options.ranges.push(range);
                };

                Selection.prototype._ensureSingleSelection = function () {
                    if (this._options.selectionMode == 0 /* SingleRow */) {
                        if (this._options.cursor.isValid()) {
                            this._options.ranges = [new Range(0 /* Row */, this._options.cursor.rowIndex, this._options.cursor.rowIndex, NaN, NaN)];
                        } else {
                            this._options.ranges = [Range.Null];
                        }
                    } else if (this._options.selectionMode == 2 /* Cell */) {
                        if (this._options.cursor.isValid()) {
                            this._options.ranges = [new Range(2 /* Range */, this._options.cursor.rowIndex, this._options.cursor.rowIndex, this._options.cursor.columnIndex, this._options.cursor.columnIndex)];
                        } else {
                            this._options.ranges = [Range.Null];
                        }
                    }
                };

                Selection.prototype._getSelectionChangeUpdater = function () {
                    var _this = this;
                    return new Support.Updater(function () {
                        return _this._options.ranges;
                    }, function (newValue, oldValue) {
                        _this._events.emit('selectionChange', _this, { oldValue: oldValue, newValue: newValue });
                    });
                };

                Selection.prototype._getCursorChangeUpdater = function () {
                    var _this = this;
                    return new Support.Updater(function () {
                        return _this._options.cursor;
                    }, function (newValue, oldValue) {
                        _this._events.emit('cursorChange', _this, { oldValue: oldValue, newValue: newValue });
                    });
                };
                return Selection;
            })();
            Controls.Selection = Selection;

            /// &lt;summary>
            /// List control class
            /// &lt;/summary>
            var ListControl = (function () {
                function ListControl(parent) {
                    var _this = this;
                    this.disposer = new Controls.Fundamental.Disposer(function () {
                        _this._elements.root.remove();
                        _this._options = null;
                        _this._runtime = null;
                        _this._elements = null;
                    });
                    this._initialize(parent);
                }
                ListControl.prototype.dispose = function () {
                    this.disposer.dispose();
                };

                ListControl.prototype.viewType = function (value) {
                    if (this._rendered) {
                        return this._viewType.apply(this, arguments);
                    } else {
                        return this._defaultViewType.apply(this, arguments);
                    }
                };

                ListControl.prototype.width = function (value) {
                    var _this = this;
                    return this._property({
                        name: 'width',
                        args: arguments,
                        afterChange: function (sender, args) {
                            _this._runtime.width = args.newValue;
                            _this._dynamicStylesheetUpdater.getUpdater().update();
                            _this._updateSize();
                        }
                    });
                };

                ListControl.prototype.height = function (value) {
                    var _this = this;
                    return this._property({
                        name: 'height',
                        args: arguments,
                        afterChange: function (sender, args) {
                            _this._runtime.height = args.newValue;
                            _this._dynamicStylesheetUpdater.getUpdater().update();
                            _this._updateSize();
                        }
                    });
                };

                ListControl.prototype.rowCount = function (value) {
                    var _this = this;
                    return this._property({
                        name: 'rowCount',
                        args: arguments,
                        afterChange: function (sender, args) {
                            var oldValue = args.oldValue, newValue = args.newValue;

                            if (newValue &lt; oldValue) {
                                for (var i = newValue; i &lt; oldValue; i++) {
                                    var row = _this._rows[i];

                                    if (row) {
                                        var rowUniqueId = row.rowUniqueId;
                                        delete _this._rowMap[rowUniqueId];
                                    }

                                    delete _this._rows[i];
                                    delete _this._options.rows[i];
                                }
                            }

                            _this._options.rows.length = _this._rows.length = newValue;
                            _this._runtime.selection.rowCount(newValue);
                        }
                    });
                };

                ListControl.prototype.rows = function (value) {
                    var _this = this;
                    return this._property({
                        name: 'rows',
                        args: arguments,
                        beforeChange: function (sender, args) {
                            if (args.newValue == null || typeof (args.newValue) == 'undefined') {
                                args.newValue = [];
                            } else if (!$.isArray(args.newValue)) {
                                throw Support.createError(0, 'ListControl', 'rows must be an array');
                            }

                            var rows = [];

                            _this._rows = [];

                            for (var i = 0; i &lt; args.newValue.length; i++) {
                                if (typeof (args.newValue) != 'undefined') {
                                    var rowUniqueId = _this._generateRowUniqueId();

                                    _this._rows[i] = { rowUniqueId: rowUniqueId };
                                    _this._rowMap[rowUniqueId] = i;
                                }
                            }

                            _this._options.rowCount = rows.length = args.newValue.length;
                            _this._runtime.selection.rowCount(_this._options.rowCount);
                            args.newValue = args.newValue.slice();
                        }
                    });
                };

                ListControl.prototype.getRowById = function (rowUniqueId) {
                    var row = this._runtime.getRowByUniqueId(rowUniqueId);

                    if (row) {
                        return row.raw;
                    }
                };

                ListControl.prototype.getRowByIndex = function (rowIndex) {
                    return this._options.rows[rowIndex];
                };

                ListControl.prototype.getRowsByIndex = function (topRowindex, count) {
                    var rows = [], bottomRowIndex = topRowindex + count - 1;

                    for (var rowIndex = topRowindex; rowIndex &lt;= bottomRowIndex; rowIndex++) {
                        rows.push(this._options.rows[rowIndex]);
                    }

                    return rows;
                };

                ListControl.prototype.updateRowById = function (row, rowUniqueId) {
                    var row = this._runtime.getRowByUniqueId(rowUniqueId);

                    if (row) {
                        this.updateRowsByIndex([row], row.rowIndex, 1);
                    }
                };

                ListControl.prototype.updateRowByIndex = function (row, rowIndex) {
                    // FIXME: [high][1 day] should we add the row count when the index is exceed the row count?
                    this.updateRowsByIndex([row], rowIndex, 1);
                };

                ListControl.prototype.updateRowsByIndex = function (rows, startRowIndex, count) {
                    if (typeof (count) == 'undefined') {
                        count = rows.length;
                    }

                    for (var rowIndex = startRowIndex; rowIndex &lt; startRowIndex + count; rowIndex++) {
                        var newValue = rows[rowIndex - startRowIndex], rowUniqueId;
                        this._options.rows[rowIndex] = newValue;

                        if (typeof (newValue) != 'undefined') {
                            if (!this._rows[rowIndex]) {
                                rowUniqueId = this._generateRowUniqueId();

                                this._rows[rowIndex] = { rowUniqueId: rowUniqueId };
                                this._rowMap[rowUniqueId] = rowIndex;
                            }
                        } else {
                            var row = this._rows[rowIndex];

                            if (row) {
                                rowUniqueId = this._rows[rowIndex].rowUniqueId;

                                delete this._rows[rowIndex];
                                delete this._rowMap[rowUniqueId];
                            }
                        }
                    }

                    this._runtime.events.emit('updateRows', this, { range: new Range(0 /* Row */, startRowIndex, startRowIndex + rows.length - 1, NaN, NaN) });
                    this.updateUI(1);
                };

                ListControl.prototype.removeRowById = function (rowUniqueId) {
                    var row = this._runtime.getRowByUniqueId(rowUniqueId);

                    if (row) {
                        this.removeRowsByIndex(row.rowIndex, 1);
                    }
                };

                ListControl.prototype.removeRowByIndex = function (rowIndex) {
                    this.removeRowsByIndex(rowIndex, 1);
                };

                ListControl.prototype.removeRowsByIndex = function (startRowIndex, count) {
                    // FIXME: [high][1 day] add check here
                    var removedRows = this._rows.splice(startRowIndex, count);
                    this._options.rows.splice(startRowIndex, count);

                    for (var rowIndex = 0; rowIndex &lt; removedRows.length; rowIndex++) {
                        var row = removedRows[rowIndex];

                        if (row) {
                            delete this._rowMap[row.rowUniqueId];
                        }
                    }

                    for (var rowIndex = startRowIndex; rowIndex &lt; this._rows.length; rowIndex++) {
                        var row = this._rows[rowIndex];

                        if (row) {
                            this._rowMap[row.rowUniqueId] = rowIndex;
                        }
                    }

                    this._options.rowCount -= count;
                    this._runtime.selection.remove(new Range(0 /* Row */, startRowIndex, startRowIndex + count - 1, NaN, NaN));

                    this._runtime.events.emit('removeRows', this, { range: new Range(0 /* Row */, startRowIndex, startRowIndex + count - 1, NaN, NaN) });
                    this.updateUI(1);
                };

                ListControl.prototype.insertRowById = function (rowUniqueId) {
                    var row = this._runtime.getRowByUniqueId(rowUniqueId);

                    if (row) {
                        this.insertRowsByIndex(row.rowIndex, 1);
                    }
                };

                ListControl.prototype.insertRowByIndex = function (rowIndex) {
                    this.insertRowsByIndex(rowIndex, 1);
                };

                ListControl.prototype.insertRowsByIndex = function (rows, startRowIndex, count) {
                    if (typeof (count) == 'undefined') {
                        count = rows.length;
                    }

                    var spliceParameters = [startRowIndex, 0];

                    for (var rowIndex = startRowIndex; rowIndex &lt; this._options.rowCount; rowIndex++) {
                        var row = this._rows[rowIndex];

                        if (typeof (row) != 'undefined') {
                            var rowUniqueId = row.rowUniqueId;

                            this._rowMap[rowUniqueId] = rowIndex + count;
                        }
                    }

                    for (var rowIndex = 0; rowIndex &lt; count; rowIndex++) {
                        spliceParameters.push(undefined);
                    }

                    this._rows.splice.apply(this._rows, spliceParameters);
                    this._options.rows.splice.apply(this._options.rows, spliceParameters);

                    for (var rowIndex = startRowIndex; rowIndex &lt; startRowIndex + count; rowIndex++) {
                        var newValue = rows[rowIndex - startRowIndex], rowUniqueId;
                        this._options.rows[rowIndex] = newValue;

                        if (typeof (newValue) != 'undefined') {
                            if (!this._rows[rowIndex]) {
                                rowUniqueId = this._generateRowUniqueId();

                                this._rows[rowIndex] = { rowUniqueId: rowUniqueId };
                                this._rowMap[rowUniqueId] = rowIndex;
                            }
                        } else {
                            var row = this._rows[rowIndex];

                            if (row) {
                                rowUniqueId = this._rows[rowIndex].rowUniqueId;

                                delete this._rows[rowIndex];
                                delete this._rowMap[rowUniqueId];
                            }
                        }
                    }

                    this._options.rowCount += count;
                    this._runtime.selection.insert(new Range(0 /* Row */, startRowIndex, startRowIndex + count - 1, NaN, NaN));
                    this._runtime.events.emit('insertRows', this, { range: new Range(0 /* Row */, startRowIndex, startRowIndex + rows.length - 1, NaN, NaN) });
                    this.updateUI(1);
                };

                ListControl.prototype.theme = function (value) {
                    return this._property({
                        name: 'theme',
                        args: arguments
                    });
                };

                ListControl.prototype.selectedRanges = function () {
                    return this._runtime.selection.ranges().slice();
                };

                ListControl.prototype.selectionMode = function (value) {
                    var _this = this;
                    return this._property({
                        name: 'selectionMode',
                        args: arguments,
                        afterChange: function (sender, args) {
                            _this._runtime.selection.selectionMode(args.newValue);
                        }
                    });
                };

                ListControl.prototype.cursor = function (position) {
                    return this._runtime.selection.cursor.apply(this._runtime.selection, arguments);
                };

                ListControl.prototype.select = function (range, keepSelectedRanges) {
                    if (typeof keepSelectedRanges === "undefined") { keepSelectedRanges = false; }
                    return this._runtime.selection.select(range, keepSelectedRanges);
                };

                ListControl.prototype.deselect = function (range) {
                    this._runtime.selection.deselect(range);
                };

                ListControl.prototype.selectedRangeOfPosition = function (position) {
                    return this._runtime.selection.rangeOfPosition(position);
                };

                ListControl.prototype.selectedRangeOfCursor = function () {
                    return this._runtime.selection.rangeOfCursor();
                };

                ListControl.prototype.rtl = function (value) {
                    var _this = this;
                    return this._property({
                        name: 'rtl',
                        args: arguments,
                        afterChange: function (sender, args) {
                            _this._runtime.direction.rtl(args.newValue);
                            _this._runtime.elements.root.addClass(args.newValue ? 'msoc-rtl' : 'msoc-ltr');
                            _this._runtime.elements.root.removeClass(args.newValue ? 'msoc-ltr' : 'msoc-rtl');
                        }
                    });
                };

                ListControl.prototype.addColumns = function (columnDefinitions) {
                    var uniqueIds = [], columns = [];

                    for (var i = 0; i &lt; columnDefinitions.length; i++) {
                        var columnDefinition = columnDefinitions[i];
                        var columnIndex = this._options.columns.length;
                        var columnUniqueId = this._generateColumnUniqueId();

                        this._options.columns[columnUniqueId] = {
                            columnUniqueId: columnUniqueId,
                            cellRender: !!columnDefinition.cellRender ? columnDefinition.cellRender : new SimpleTextCellRender(),
                            headerRender: !!columnDefinition.headerRender ? columnDefinition.headerRender : new SimpleTextHeaderRender(),
                            cellEditor: columnDefinition.cellEditor,
                            raw: columnDefinition
                        };

                        uniqueIds.push(columnUniqueId);
                        columns.push(this._options.columns[columnUniqueId]);
                    }

                    this._runtime.events.emit('addColumns', this, { columns: columns });
                    return uniqueIds;
                };

                ListControl.prototype.updateUI = function (timeout) {
                    var _this = this;
                    if (typeof timeout === "undefined") { timeout = 0; }
                    if (timeout) {
                        if (!this._updateUIHandler) {
                            this._updateUIHandler = window.setTimeout(function () {
                                _this._updateUIHandler = null;
                                _this._updateUIInternal();
                            }, timeout);
                        }
                    } else {
                        if (this._updateUIHandler) {
                            window.clearTimeout(this._updateUIHandler);
                            this._updateUIHandler = null;
                        }

                        this._updateUIInternal();
                    }
                };

                ListControl.prototype.viewProperty = function (type, name, value) {
                    return this._views[type].property.apply(this._views[type], Array.prototype.slice.call(arguments, 1));
                };

                ListControl.prototype.on = function (eventName, handler) {
                    this._options.events.on(eventName, handler);
                };

                ListControl.prototype.off = function (eventName, handler) {
                    this._options.events.off(eventName, handler);
                };

                ListControl.prototype.invalidateRow = function (rowIndex) {
                    if (this._rendered) {
                        this._views[this._runtime.viewType].invalidateRange(new Range(0 /* Row */, rowIndex, rowIndex, NaN, NaN));
                    }
                };

                ListControl.prototype.invalidateHeaderRange = function (range) {
                    if (this._rendered) {
                        this._views[this._runtime.viewType].invalidateHeaderRange(range);
                    }
                };

                ListControl.prototype.invalidateHeaderCell = function (columnIndex) {
                    if (this._rendered) {
                        this._views[this._runtime.viewType].invalidateHeaderRange(new Range(2 /* Range */, 0, 0, columnIndex, columnIndex));
                    }
                };

                ListControl.prototype.invalidate = function () {
                    if (this._rendered) {
                        this._views[this._runtime.viewType].invalidate();
                    }
                };

                ListControl.prototype.invalidateRange = function (range) {
                    if (this._rendered) {
                        this._views[this._runtime.viewType].invalidateRange(range);
                    }
                };

                ListControl.prototype.getColumnById = function (columnUniqueId) {
                    return this._options.columns[columnUniqueId].raw;
                };

                ListControl.prototype.getColumnIdByIndex = function (columnIndex) {
                    if (this._views[this._runtime.viewType]) {
                        return this._views[this._runtime.viewType].getColumnIdByIndex(columnIndex);
                    }
                };

                ListControl.prototype.getColumnIndexById = function (columnUniqueId) {
                    if (this._views[this._runtime.viewType]) {
                        return this._views[this._runtime.viewType].getColumnIndexById(columnUniqueId);
                    }
                };

                ListControl.prototype.scrollTo = function (top, front) {
                    this._scrollTo(top, front);
                };

                ListControl.prototype.getOperationName = function () {
                    return this._runtime.operator.name();
                };

                ListControl.prototype.stopOperation = function () {
                    return this._runtime.operator.stop();
                };

                ListControl.prototype._initialize = function (parent) {
                    var _this = this;
                    this._lastColumnUniqueId = 0;
                    this._lastRowUniqueId = 0;
                    this._rowMap = {};
                    this._rows = [];
                    this._id = (new Date()).valueOf();
                    this._options = new Support.PropertyBag({
                        columns: [],
                        rows: [],
                        rowCount: 0,
                        theme: Theme.Default,
                        selectionMode: 0 /* SingleRow */,
                        events: null,
                        viewType: NaN,
                        defaultViewType: 0 /* Table */,
                        rtl: false
                    });
                    this._elements = {};
                    this._runtime = {
                        id: 'msocList_' + this._id,
                        rootClass: 'msoc-list-' + this._id,
                        options: this._options,
                        elements: this._elements,
                        owner: this,
                        width: 0,
                        height: 0,
                        viewportScrollLeft: 0,
                        viewportScrollCoordinate: new Support.Coordinate(1 /* ViewportRelative */, 0, 0),
                        events: null,
                        viewType: NaN,
                        operator: null,
                        updateUI: function () {
                            return _this.updateUI.apply(_this, arguments);
                        },
                        direction: new Support.TextDirection(Support.TextDirection.LTR),
                        updateSize: function () {
                            return _this._updateSize.apply(_this, arguments);
                        },
                        selection: new Selection(),
                        scroll: function () {
                            return _this._scroll.apply(_this, arguments);
                        },
                        scrollIntoView: function () {
                            return _this._scrollIntoView.apply(_this, arguments);
                        },
                        scrollTo: function () {
                            return _this._scrollTo.apply(_this, arguments);
                        },
                        readerText: function (text) {
                            _this._elements.root.attr('aria-label', text);
                            _this._elements.screenReader.text(text);
                        },
                        buildCssRootSelector: function (builder, additinalSelector) {
                            builder.push('.');
                            builder.push(_this._runtime.rootClass);
                            builder.push('.msoc-list-view-');
                            builder.push(ViewType[_this._runtime.viewType].toLowerCase());

                            if (additinalSelector) {
                                builder.push(additinalSelector);
                            }

                            builder.push(' ');
                        },
                        getRowByIndex: function (rowIndex) {
                            if (typeof (_this._options.rows[rowIndex]) != 'undefined') {
                                return {
                                    rowIndex: rowIndex,
                                    rowUniqueId: _this._rows[rowIndex].rowUniqueId,
                                    raw: _this._options.rows[rowIndex],
                                    core: _this._rows[rowIndex]
                                };
                            }
                        },
                        getRowByUniqueId: function (rowUniqueId) {
                            if (typeof (_this._rowMap[rowUniqueId]) != 'undefined') {
                                var rowIndex = _this._rowMap[rowUniqueId];

                                return {
                                    rowIndex: rowIndex,
                                    rowUniqueId: rowUniqueId,
                                    raw: _this._options.rows[rowIndex],
                                    core: _this._rows[rowIndex]
                                };
                            }
                        },
                        renderHeaderCellContent: function (options) {
                            return _this._renderHeaderCellContent(options);
                        },
                        renderCellContent: function (options) {
                            return _this._renderCellContent(options);
                        }
                    };

                    this._elements.root = $('&lt;div class="msoc-list ' + this._runtime.rootClass + '" tabindex="0" aria-labelledby="msocListScreenReader_' + this._id + '">' + '&lt;div id="msocListScreenReader_' + this._id + '" class="msoc-list-screen-reader" aria-live="assertive">&lt;/div>' + '&lt;div class="msoc-list-content">' + '&lt;div class="msoc-list-header-viewport">' + '&lt;div class="msoc-list-header-canvas-container">' + '&lt;div class="msoc-list-header-canvas">&lt;/div>' + '&lt;div class="msoc-list-header-canvas">&lt;/div>' + '&lt;div class="msoc-list-header-canvas">&lt;/div>' + '&lt;/div>' + '&lt;/div>' + '&lt;div name="msoc-list-viewport-' + this._id + '" class="msoc-list-viewport">' + '&lt;div class="msoc-list-canvas-container">' + '&lt;div class="msoc-list-canvas">&lt;/div>' + '&lt;div class="msoc-list-canvas">&lt;/div>' + '&lt;div class="msoc-list-canvas">&lt;/div>' + '&lt;/div>' + '&lt;/div>' + '&lt;/div>' + '&lt;/div>');
                    $(parent).append(this._elements.root);
                    this._elements.headerViewport = this._elements.root.find('.msoc-list-header-viewport');
                    this._elements.headerCanvasContainer = this._elements.root.find('.msoc-list-header-canvas-container');
                    this._elements.headerCanvas = this._elements.root.find('.msoc-list-header-canvas');
                    this._elements.viewport = this._elements.root.find('.msoc-list-viewport');
                    this._elements.canvasContainer = this._elements.root.find('.msoc-list-canvas-container');
                    this._elements.canvas = this._elements.root.find('.msoc-list-canvas');
                    this._elements.screenReader = this._elements.root.find('> .msoc-list-screen-reader');

                    this.disposer.addDisposable(this._updaters = new Support.UpdaterGroup());
                    this.disposer.addDisposable(this._runtime.operator = new Operator());
                    this.disposer.addDisposable(this._runtime.events = new Support.EventSite());
                    this.disposer.addDisposable(this._options.events = new Support.EventSite());
                    this.disposer.addDisposable(this._dynamicStylesheetUpdater = new Support.DynamicStylesheetUpdater(this._runtime.id));
                    this._dynamicStylesheetUpdater.add(function () {
                        return _this._getStylesheet();
                    });

                    this._updaters.add(this._dynamicStylesheetUpdater.getUpdater());

                    this._views = {};
                    this.disposer.addDisposable(this._views[0 /* Table */] = new TableView(this._runtime));
                    this.disposer.addDisposable(this._views[1 /* Stack */] = new StackView(this._runtime));

                    for (var viewType in this._views) {
                        var view = this._views[viewType];

                        this[view.name()] = view.controller();
                    }

                    this._attachEvents();
                    this._rendered = false;
                    this._pendingUpdateUI = false;

                    window.setTimeout(function () {
                        _this._rendered = true;
                        _this._viewType(_this._defaultViewType());

                        // FIXME: [low][1 day] Add a firefox checker
                        // Workaround FireFox bug https://bugzilla.mozilla.org/show_bug.cgi?id=706792
                        _this._elements.canvasContainer.css('width', '1000000px');
                        _this._elements.canvasContainer.css('height', '1000000px');
                        _this._elements.viewport.scrollLeft(0);
                        _this._elements.viewport.scrollTop(0);
                        _this._elements.canvasContainer.css('width', '');
                        _this._elements.canvasContainer.css('height', '');
                        _this._elements.headerCanvasContainer.css('width', '1000000px');
                        _this._elements.headerCanvasContainer.css('height', '1000000px');
                        _this._elements.headerViewport.scrollLeft(0);
                        _this._elements.headerViewport.scrollTop(0);
                        _this._elements.headerCanvasContainer.css('width', '');
                        _this._elements.headerCanvasContainer.css('height', '');

                        if (_this._pendingUpdateUI) {
                            _this.updateUI();
                        } else {
                            _this.updateUI(1);
                        }
                    });
                };

                ListControl.prototype._generateRowUniqueId = function () {
                    return 'l' + this._id + '-r' + (this._lastRowUniqueId++);
                };

                ListControl.prototype._generateColumnUniqueId = function () {
                    return 'l' + this._id + '-c' + (this._lastColumnUniqueId++);
                };

                ListControl.prototype._viewType = function (value) {
                    var _this = this;
                    return this._property({
                        name: 'viewType',
                        args: arguments,
                        afterChange: function (sender, args) {
                            var oldValue = args.oldValue, newValue = args.newValue;

                            if (!isNaN(oldValue)) {
                                _this._elements.root.removeClass('msoc-list-view-' + _this._views[oldValue].name());
                                _this._runtime.operator.stop();
                                _this._views[oldValue].deactivate();
                            }

                            if (_this._views[newValue]) {
                                _this._runtime.viewType = newValue;
                                _this._elements.root.addClass('msoc-list-view-' + _this._views[newValue].name());
                                _this._views[newValue].activate();
                                _this.updateUI(1);
                            }
                        }
                    });
                };

                ListControl.prototype._defaultViewType = function (value) {
                    return this._property({
                        name: 'defaultViewType',
                        args: arguments
                    });
                };

                ListControl.prototype._invalidateRange = function (range) {
                    this._views[this._runtime.viewType].invalidateRange(range);
                };

                ListControl.prototype._scrollIntoView = function (top, front, height, width) {
                    var scrollWidth = this._runtime.canvasWidth;
                    var scrollHeight = this._runtime.canvasHeight;
                    var scrollFront = this._runtime.viewportScrollCoordinate.front();
                    var scrollTop = this._runtime.viewportScrollCoordinate.top();
                    var clientWidth = this._runtime.viewportClientWidth;
                    var clientHeight = this._runtime.viewportClientHeight;
                    var bottom = top + height;
                    var end = front + width;

                    top = top &lt; 0 ? 0 : top;
                    front = front &lt; 0 ? 0 : front;
                    bottom = bottom > scrollHeight ? scrollHeight : bottom;
                    end = end > scrollWidth ? scrollWidth : end;

                    var targetFront, targetTop;

                    if (end > scrollFront + clientWidth) {
                        targetFront = end - clientWidth;
                    } else {
                        targetFront = scrollFront;
                    }

                    if (front &lt; targetFront) {
                        targetFront = front;
                    }

                    if (bottom > scrollTop + clientHeight) {
                        targetTop = bottom - clientHeight;
                    } else {
                        targetTop = scrollTop;
                    }

                    if (top &lt; targetTop) {
                        targetTop = top;
                    }

                    this._scrollTo(targetTop, targetFront);
                };

                ListControl.prototype._scrollTo = function (top, front) {
                    top = parseFloat(top);
                    front = parseFloat(front);

                    if (!isNaN(front)) {
                        var scrollWidth = this._runtime.canvasWidth, clientWidth = this._runtime.viewportClientWidth;

                        front = Math.max(0, Math.min(front, scrollWidth));

                        if (this._runtime.direction.rtl()) {
                            if (Support.TextDirection.zeroEnd() == 'front' &amp;&amp; Support.TextDirection.scrollFrontDirection() == -1) {
                                // FireFox
                                this._elements.viewport.scrollLeft(-front);
                            } else if (Support.TextDirection.zeroEnd() == 'end' &amp;&amp; Support.TextDirection.scrollFrontDirection() == 1) {
                                // Chrome
                                this._elements.viewport.scrollLeft(scrollWidth - clientWidth - front);
                            } else if (Support.TextDirection.zeroEnd() == 'front' &amp;&amp; Support.TextDirection.scrollFrontDirection() == 1) {
                                // IE
                                this._elements.viewport.scrollLeft(front);
                            } else {
                                // Unknown??
                                this._elements.viewport.scrollLeft(front - scrollWidth + clientWidth);
                            }
                        } else {
                            this._elements.viewport.scrollLeft(front);
                        }
                    }

                    if (!isNaN(top)) {
                        this._elements.viewport.scrollTop(Math.max(0, Math.min(top, this._runtime.canvasHeight)));
                    }
                };

                ListControl.prototype._scroll = function (topOffset, frontOffset) {
                    if (!!frontOffset) {
                        if (this._runtime.direction.rtl()) {
                            // FireFox &amp; Chrome
                            if (Support.TextDirection.zeroEnd() == 'front' &amp;&amp; Support.TextDirection.scrollFrontDirection() == -1 || Support.TextDirection.zeroEnd() == 'end' &amp;&amp; Support.TextDirection.scrollFrontDirection() == 1) {
                                frontOffset = -frontOffset;
                            }
                        }

                        this._elements.viewport.scrollLeft(this._elements.viewport.scrollLeft() + frontOffset);
                    }

                    if (!!topOffset) {
                        this._elements.viewport.scrollTop(this._elements.viewport.scrollTop() + topOffset);
                    }
                };

                ListControl.prototype._getStylesheet = function () {
                    var cssText = new Support.CssTextBuilder();

                    cssText.push('.');
                    cssText.push(this._runtime.rootClass);
                    cssText.property('width', this._runtime.width, 'px');
                    cssText.property('height', this._runtime.height, 'px');
                    cssText.property('background-color', this._options.theme.value('backgroundColor'));

                    return cssText.toString();
                };

                ListControl.prototype._updateSize = function () {
                    this._runtime.viewportWidth = this._elements.viewport.width();
                    this._runtime.viewportHeight = this._elements.viewport.height();
                    this._runtime.viewportClientWidth = this._elements.viewport[0].clientWidth;
                    this._runtime.viewportClientHeight = this._elements.viewport[0].clientHeight;
                    this._runtime.canvasHeight = this._elements.canvasContainer.height();
                    this._runtime.canvasWidth = this._elements.canvasContainer.width();
                };

                ListControl.prototype._attachProxyEvent = function (sourceName, targetName, argsTransformer) {
                    var _this = this;
                    this.disposer.addDisposable(new Support.EventAttacher(this._runtime.events, sourceName, function () {
                        arguments[0] = _this;

                        Array.prototype.unshift.call(arguments, targetName);

                        var newArgs = {}, oldArgs = arguments[2];

                        if (argsTransformer) {
                            argsTransformer(oldArgs, newArgs, true);
                            arguments[2] = newArgs;
                        }

                        var result = _this._options.events.emit.apply(_this._options.events, arguments);

                        if (argsTransformer) {
                            argsTransformer(oldArgs, newArgs, false);
                        }

                        return result;
                    }));
                };

                ListControl.prototype._attachEvents = function () {
                    var _this = this;
                    var scrollHandler = new Support.AccumulateTimeoutInvoker(function () {
                        _this.updateUI();
                    }, 50);

                    this.disposer.addDisposable(new Support.EventAttacher(this._elements.viewport, 'scroll', function (event) {
                        _this._runtime.viewportScrollLeft = _this._elements.viewport[0].scrollLeft;
                        _this._runtime.viewportScrollCoordinate = Support.CoordinateFactory.scrollFromElement(_this._runtime.direction.rtl(), _this._elements.viewport);
                        _this._runtime.events.emit('viewportScroll', _this, null);
                        scrollHandler.invoke();
                    }));

                    this.disposer.addDisposable(new Support.EventAttacher(this._elements.root, 'keydown', function (event) {
                        if (event.keyCode == 27) {
                            _this._runtime.operator.stop();
                        }
                    }));

                    // We listen to mousedown event to fix the different behavior across the different browser.
                    // Basicly, when user mouse down in the list control, the root element should get the focus.
                    // It makes something, such as key event and screen reader, simple.
                    // There is an exceptional case, we'll handle the focus in differnt way in edit mode, so we emit
                    // an event to make sure we can cancel it in edit mode
                    // FIXME: We should handle the case when user use keyboard to focus list control
                    this.disposer.addDisposable(new Support.EventAttacher(this._elements.root, 'mousedown', function (event) {
                        // Focus fix for IE, IE can focus on the cell element even if the tabindex of it is empty
                        if (document.activeElement != _this._runtime.elements.root[0] || event.target != _this._runtime.elements.root[0]) {
                            var args = {
                                event: event,
                                element: _this._runtime.elements.root,
                                cancel: false
                            };
                            _this._runtime.events.emit('beforeMouseDownFocus', _this, args);

                            if (!args.cancel) {
                                args.element.focus();

                                // FIXME: [low][1 day] this is a firefox only event to fix the focus issue in firefox, add browser check
                                // In firefox, after we focused to a div, firefox will focus to document.body later.
                                // It is an behavior we don't want to do
                                event.preventDefault();
                            }
                        }
                    }));
                    this.disposer.addDisposable(new Support.EventAttacher(this._runtime.selection, 'cursorChange', function (sender, args) {
                        _this._runtime.events.emit('cursorChange', _this, args);
                    }));
                    this.disposer.addDisposable(new Support.EventAttacher(this._runtime.selection, 'selectionChange', function (sender, args) {
                        _this._runtime.events.emit('selectionChange', _this, args);
                    }));
                    this._attachProxyEvent('table.beforeRender stack.beforeRender', 'beforeRender');
                    this._attachProxyEvent('table.rowClick stack.rowClick', 'rowClick');
                    this._attachProxyEvent('table.headerRowClick', 'headerRowClick');
                    this._attachProxyEvent('table.headerRowContextMenu', 'headerRowContextMenu');
                    this._attachProxyEvent('table.beforeColumnReorder', 'beforeColumnReorder', function (oldArgs, newArgs, from) {
                        if (from) {
                            newArgs.fromColumnIndex = oldArgs.fromColumnIndex;
                            newArgs.toColumnIndex = oldArgs.toColumnIndex;
                            newArgs.cancel = oldArgs.cancel;
                        } else {
                            oldArgs.cancel = newArgs.cancel;
                        }
                    });
                    this._attachProxyEvent('table.beforeCursorChange stack.beforeCursorChange', 'beforeCursorChange', function (oldArgs, newArgs, from) {
                        if (from) {
                            newArgs.rowIndex = oldArgs.newCursorPosition.rowIndex;
                            newArgs.columnIndex = oldArgs.newCursorPosition.columnIndex;
                            newArgs.cancel = oldArgs.cancel;
                        } else {
                            oldArgs.cancel = newArgs.cancel;
                        }
                    });
                    this._attachProxyEvent('table.beforeDeselect', 'beforeDeselect', function (oldArgs, newArgs, from) {
                        if (from) {
                            newArgs.range = oldArgs.range;
                            newArgs.cancel = oldArgs.cancel;
                        } else {
                            oldArgs.cancel = newArgs.cancel;
                        }
                    });
                    this._attachProxyEvent('table.beforeSelect', 'beforeSelect', function (oldArgs, newArgs, from) {
                        if (from) {
                            newArgs.range = oldArgs.range;
                            newArgs.reason = oldArgs.reason;
                            newArgs.cancel = oldArgs.cancel;
                        } else {
                            oldArgs.cancel = newArgs.cancel;
                        }
                    });
                    this._attachProxyEvent('cursorChange', 'cursorChange', function (oldArgs, newArgs, from) {
                        if (from) {
                            newArgs.rowIndex = oldArgs.newValue.rowIndex;
                            newArgs.columnIndex = oldArgs.newValue.columnIndex;
                        }
                    });
                    this._attachProxyEvent('selectionChange', 'selectionChange', function (oldArgs, newArgs, from) {
                        if (from) {
                            newArgs.selectedRanges = oldArgs.newValue.slice();
                        }
                    });
                };

                ListControl.prototype._updateUIInternal = function () {
                    if (this.disposer.isDisposed) {
                        return;
                    }

                    if (this._rendered) {
                        this._updaters.update();
                        this._views[this._runtime.viewType].updateUI();
                    } else {
                        this._pendingUpdateUI = true;
                    }
                };

                ListControl.prototype._property = function (options) {
                    var _this = this;
                    if (this.disposer.isDisposed) {
                        return;
                    }

                    var name = options.name, args = options.args, impactUI = typeof (options.impactUI) == 'undefined' ? true : options.impactUI, beforeChange = options.beforeChange, afterRead = options.afterRead, afterChange = options.afterChange;

                    return this._options.$property({
                        name: name,
                        args: args,
                        afterRead: function (sender, args) {
                            if (afterRead) {
                                afterRead(sender, args);
                            }

                            return _this._runtime.events.emit('propertyRead', _this, args);
                        },
                        beforeChange: function (sender, args) {
                            if (beforeChange) {
                                beforeChange(sender, args);
                            }

                            return _this._runtime.events.emit('beforePropertyChange', _this, args);
                        },
                        afterChange: function (sender, args) {
                            if (afterChange) {
                                afterChange(sender, args);
                            }

                            if (impactUI) {
                                _this.updateUI(1);
                            }

                            return _this._runtime.events.emit('propertyChange', _this, args);
                        }
                    });
                };

                ListControl.prototype._renderCellContent = function (options) {
                    var _this = this;
                    var element = options.element, row = options.row, rowIndex = options.rowIndex, columnUniqueId = options.columnUniqueId, columnIndex = options.columnIndex, rowUniqueId = row.rowUniqueId, column = this._options.columns[columnUniqueId], render = column.cellRender, viewType = this._runtime.viewType, rect = options.rect;

                    var promise = render.render({
                        cellData: row.raw[column.raw.field],
                        rowId: rowUniqueId,
                        rowIndex: rowIndex,
                        columnId: columnUniqueId,
                        columnIndex: columnIndex,
                        element: element,
                        height: rect.height,
                        rowData: row.raw,
                        rtl: this._runtime.direction.rtl(),
                        theme: this._options.theme,
                        view: viewType,
                        width: rect.width
                    });

                    if (promise) {
                        var rendered;

                        promise.always(function () {
                            if (rendered === false) {
                                var row = _this._runtime.getRowByUniqueId(rowUniqueId), columnIndex = _this._views[viewType].getColumnIndexById(columnUniqueId);

                                if (row &amp;&amp; !isNaN(columnIndex)) {
                                    // In the case the _renderCellContent is finished and then we get a promise call
                                    // We should invalidate the cell since the cell render it in async way
                                    _this._views[viewType].invalidateRange(new Range(2 /* Range */, row.rowIndex, row.rowIndex, columnIndex, columnIndex));
                                }
                            }
                        });

                        rendered = false;
                    }
                };

                ListControl.prototype._renderHeaderCellContent = function (options) {
                    var element = options.element, rowUniqueId = options.rowUniqueId, columnUniqueId = options.columnUniqueId, column = this._options.columns[columnUniqueId], render = column.headerRender, viewType = this._runtime.viewType, rect = options.rect;

                    return render.render({
                        columnUniqueId: columnUniqueId,
                        data: column.raw.data,
                        element: element,
                        height: rect.height,
                        rowUniqueId: rowUniqueId,
                        rtl: this._runtime.direction.rtl(),
                        theme: this._options.theme,
                        view: viewType,
                        width: rect.width
                    });
                };
                return ListControl;
            })();
            Controls.ListControl = ListControl;
        })(Office.Controls || (Office.Controls = {}));
        var Controls = Office.Controls;
    })(Microsoft.Office || (Microsoft.Office = {}));
    var Office = Microsoft.Office;
})(Microsoft || (Microsoft = {}));
//# sourceMappingURL=listcontrol.js.map
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Microsoft.Office.Controls.Fundamental.Disposer.html">Disposer</a></li></ul><h3>Namespaces</h3><ul><li><a href="Microsoft.Office.Controls.Fundamental.html">Fundamental</a></li></ul><h3>Interfaces</h3><ul><li><a href="Microsoft.Office.Controls.Fundamental.IDisposable.html">IDisposable</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a> on Sun Jul 12 2015 19:44:45 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
